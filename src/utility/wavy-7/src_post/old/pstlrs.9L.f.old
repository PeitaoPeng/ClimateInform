      PROGRAM PSTLRS
C////////////...........MAIN..........//////////////////////////
C$$$  MAIN PROGRAM DOCUMENTATION BLOCK
C
C MAIN PROGRAM:  SMP 40  18    SIGMA TO PRESS FOR  40   18
C   AUTHOR: J. SELA          ORG: W/NMC32     DATE: 85/01/14
C     CHANGED BY E. SCHNEIDER TO PROCESS COLA MRF86 DIAGNOSTIC
C     TAPE TO PRODUCE GLAS-LIKE INTERP TAPE
C     CHANGED TO PRODUCE ARBITRARY RESOLUTION REGULAR GRID
C     OUTPUT WITH DIRECTORY BY L. MARX
C
C ABSTRACT: READS SPECTRAL FORECAST COEFFICIENTS OF TOPOGRAPHY,
C   LOG OF SFC PRESSURE, TEMPERATURE, DIVERGENCE, VORTICITY AND
C   HUMIDITY IN SIGMA LAYERS. CONVERTS THESE VALUES TO SELECTED
C   MANDATORY PRESSURE LEVELS.
C
C
C
C
C USAGE:
C
C   INPUT FILES: (SEE REMARKS)
C     UNIT5      - CARD IMAGE FILE
C
C   OUTPUT FILES: (SEE REMARKS)
C
C
C   SUBPROGRAMS CALLED:
C     UNIQUE:
C
C     VTRANW , STRANW , HBARTR , POSTGG , OMEGAS , SIGTOP ,
C     GETRH  , IMINV  , SUMPLS , SUMPLV , SYMASY , FL22   ,
C     PSU22  , MSU22  , TRANSP , TRANSW , GOZRIM , EPSLON ,
C     DELLNP , DZTOUV , PLN2   , GLATS  , POLY   , RMSGT  ,
C            , RFFTI  , RFFTF  , RFFTB  , CYBIBM
C
C     LIBRARY: NONE
C
C   EXIT STATES:
C     COND =   0 - SUCCESSFUL RUN
C
C   REMARKS: NDRTAP UNIT NUMBER OF DIRECTORY FILE ON TAPE.
C            NSFILE UNIT NUMBER OF INPUT FILE.
C            NPFILE UNIT NUMBER OF OUTPUT FILE.
C            NTOPOG UNIT NUMBER OF TOPOGRAPHY FILE.
C
C ATTRIBUTES:
C   LANGUAGE: CDC FORTRAN
C
C$$$
C..SMPG205  POST FOR COEFFCIENTS ON PRESSURE SURFACES
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
       REAL*8 DCOLRAD(LATGH),DWGT(LATGH),DWGTCS(LATGH),DRCS2(LATGH)
       REAL*8 DALATP(LATG)
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
C     INCLUDE (BOOMDA)
      CHARACTER*4 SEQDA
      COMMON/BOOMDA/IREC,NBF,NPFILE,IPS
      COMMON/BOOMDC/SEQDA
      LOGICAL MEAN,NEWDAY,NEWTYP
      DIMENSION INDATE(4),IDAT85(4), MONLEN(12)
      CHARACTER*1 BLANK,LAB85E(32),CYEAR(4),CMONTH(4),CDAY(4),
     1 CHOUR(4)
      EQUIVALENCE (LAB85(1),LAB85E(1)),(IYRBEG,CYEAR(1)),
     1 (MONBEG,CMONTH(1)),(IDABEG,CDAY(1)),(IHRBEG,CHOUR(1))
      CHARACTER*4 PROG,DIAG,RCODE,DSKTAP,DTIN
      CHARACTER*8 LAB85(4),LAB84(6),TPIN(4),LBIN(4),SER(4)
      CHARACTER*20 TYPE
      CHARACTER*40 TITLE,SPECAL
C LABELS FOR DIAGNOSTIC QUANTITIES
      DIMENSION CI(LEVGP),CL(LEVG),RPI(LEVG),MNTSK(3,4)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      NAMELIST/PSTIN/NDRTAP,NPTABL,NDVTAB,NSFILE,NPFILE,NTOPOG,
     *NDFILE,NDAYB,NDAYL,NDAYF,NFIN,MNTSK
      DATA BLANK /' '/
      DATA PROG/'PROG'/,DIAG/'DIAG'/,RCODE/'N000'/,DSKTAP/'DISK'/
      DATA TPIN/'        ','        ','        ','        '/,
     *     LBIN/'        ','        ','        ','        '/,
     *      SER/'        ','        ','        ','        '/
      DATA TYPE/'PRESSURE HISTORY    '/
      DATA TITLE/'NEW MRF86 REGULAR GRID OUTPUT TEST      '/
      DATA    IYRBEG/0/,MONBEG/0/,IDABEG/0/,IHRBEG/0/,NDAYB/5/,NDAYL/5/,
     *MONLEN/31,28,31,30,31,30,31,31,30,31,30,31/
      DATA PMAND/1000., 850., 700., 500., 300., 200., 100./
C     CALL ERRSET ( 201,256,-1,1,1 )
C     CALL ERRSET ( 209,1,1,1,1 )
C     CALL ERRSET ( 252,1,1,1,1 )
      SEQDA='SEQU'
      NGAUS=LONG*LATG
      JCAP=JWAVE-1
      LEVS=LEVG
      DEL(1)=0.0
      ITAPE=1
      IFILE=1
      IFIN=1
      NDAYF=-1
      READ(5,PSTIN)
      WRITE(3,PSTIN)
      WRITE(6,PSTIN)
      READ(5,97)SEQDA,DSKTAP
   97 FORMAT(2A4)
      CALL RECON(NFLD,NFLP,NFDV,NOF,NDRTAP,NPTABL,NDVTAB,INDATE,TITLE,
     *SPECAL,DEL,RCODE,DTIN,NEWTYP)
      RLATS= FIRSTY*2.0 * ATAN(1.0)/90.
      RLONS= FIRSTX*2.0 * ATAN(1.0)/90.
      CALL SETLON(0.0,LONG,ALONP)
      CALL GLATRP(LATG,DALATP)
           DO I=1,LATG
              ALATP(I)=DALATP(I)
           END DO
      CALL SETLON(RLONS,LONR,BLONP)
      CALL SETLAT(RLATS,LATR,BLATP)
      CALL GTRPWT(BLONP,BLATP,LONR,LATR,BLONE,BLATE,
     A            ALONP,ALATP, LONG, LATG,ALONE,ALATE,
     B            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
      CALL RFFTI( LONG,SCNMC)
      WRITE(3, 110)JCAP,LEVS
 110  FORMAT(1H0,'SMP  S  TYPE',I2,I2,'G CREATED NOV 10 1984')
      DO 5 I = 1 , 65536
      DIMION(I) = 0.0
5     CONTINUE
      DO 10 K=1,NMAND
10    ALNPMD(K)=ALOG(PMAND(K))
      CALL SETSIG(CI,SI,DEL,SL,CL,RPI)
      CALL GLATS(LATGH,DCOLRAD,DWGT,DWGTCS,DRCS2)
          DO I=1,LATGH
            COLRAD(I)=DCOLRAD(I)
            WGT(I)=DWGT(I)
            WGTCS(I)=DWGTCS(I)
            RCS2(I)=DRCS2(I)
          END DO
      CALL EPSLON(EPS,JCAP)
      CALL LAPLAC(SNNP1,JCAP)
CCCCCC-----------------------------------------------
      READ(NTOPOG) GZ
      CALL TRANSP(GZ,1)
      NSKIN=0
      NPROG=0
      DO 27 KP=1,NFLD
      NSKIN=NSKIN+NLEVS(KP)
      IF(PRODIA(KP).EQ.PROG)NPROG=NPROG+1
  27  CONTINUE
C     WRITE OUTPUT DIRECTORY
      NGR=LONR
      NTR=LATR
      NMD=NMAND
      FSX=FIRSTX
      FSY=FIRSTY
      PRH=PRHCUT
      WRITE(NDFILE,30)TYPE,RCODE,SEQDA,NGR,NTR,NMD,FSX,FSY,PRH,INDATE,
     *DSKTAP
   30 FORMAT(A20/A4,1X,A4,2I4,I3,2F7.1,E16.8,3I3,I5,1X,A4)
      WRITE(NDFILE,31)TITLE,SPECAL
   31 FORMAT(2A40)
      WRITE(NDFILE,32)PMAND
   32 FORMAT(5E16.8)
      DO 34 II=1,NOF
      WRITE(NDFILE,33)CHROP(II),NVO(II),NUCO(II)
   33 FORMAT(A40,2I5)
   34 CONTINUE
      ENDFILE NDFILE
      IF(NFLD .EQ. 0) GO TO 9999
      IF(SEQDA.EQ.'DIRA')CALL SETDA
C-------------------------------------------------------
C     READ INPUT SIGMA FILE
C-------------------------------------------------------
      DO 5000 IDAYM=NDAYF,NDAYL
   36 CONTINUE
      IF(.NOT.NEWTYP)THEN
      READ(NSFILE,END=37)LAB85
      GO TO 39
      ELSE
      READ(NSFILE,END=37)FHOUR,IDATE
      MDLHR=FHOUR
      IHRBEG=IDATE(1)
      MONBEG=IDATE(2)
      IDABEG=IDATE(3)
      IYRBEG=IDATE(4)
      GO TO 40
      END IF
   37 IFIN=IFIN+1
      IF(IFIN.GT.NFIN)GO TO 9999
      NSFILE=NSFILE+1
      IF(DTIN.EQ.'DISK')GO TO 36
      IFILE=IFILE+1
      IF(IFILE.GT.3.OR.MNTSK(IFILE,ITAPE).EQ.0)THEN
      ITAPE=ITAPE+1
      IFILE=1
      IF(ITAPE.GT.4)GO TO 9999
C     CALL GETTAP(1,TPIN(ITAPE),LBIN(ITAPE),'NORING  ','181     ',
C    *SER(ITAPE),IRET,*9999)
C     GO TO 36
      END IF
C     IF(LBIN(ITAPE).EQ.'SL      ')
C    *CALL OPSYS('$','TAPE FSF 3 (181$',IERF)
      GO TO 36
   39 READ(LAB85,1001) MDLHR
 1001 FORMAT(1X,I5)
C**********************************************************************
C
C     NOTE THAT THE PROPER NMC 85 LABEL REQUIRES THE FOLLOWING :
C
C     CYEAR(4) = LAB85E(9)
C     CMONTH(4) = LAB85E(10)
C     CDAY(4) = LAB85E(11)
C     CHOUR(4) = LAB85E(12)
C
C     THE FOUR FOLLOWING STATEMENTS REFLECT THE FACT THAT THE
C     NMC 85 LABEL CURRENTLY PUT OUT BY DIAGNOSTIC NMC MODEL
C     HAVE THE YEAR AND THE HOUR TRANSPOSED.
C
C**********************************************************************
      CHOUR(4) = LAB85E(9)
      CMONTH(4) = LAB85E(10)
      CDAY(4) = LAB85E(11)
      CYEAR(4) = LAB85E(12)
C**********************************************************************
   40 IHR = IHRBEG + MDLHR
      IDAY = IDABEG + IHR / 24
      IHR = MOD(IHR,24)
      MONTH = MONBEG
      IYR = 1900 + IYRBEG
  41  IDAYMN = MONLEN(MONTH)
      IF(MONTH .EQ. 2 .AND. MOD(IYR,4) .EQ. 0) IDAYMN = IDAYMN + 1
      IF(IDAY .LE. IDAYMN) GO TO 42
      IDAY = IDAY - IDAYMN
      MONTH = MONTH + 1
      IF(MONTH .LT. 13) GO TO 41
      MONTH = 1
      IYR = IYR + 1
      GO TO 41
  42  HR = FLOAT(IHR)
      IYR2DG = IYR - 1900
      WRITE(3, 140)NSFILE,NPFILE,HOUR,INDATE,IHR,MONTH,IDAY,IYR2DG
 140  FORMAT(1H0,2X,'INPUT FROM FT',I2.2,2X,
     *'OUTPUT FT NUMBER ',I2,2X,'HOUR=',F6.2,2X,8(I4))
C......SKIP PROGNOSTIC FIELDS UNINITIALIZED AND INITIALIZED..
      IF(IDAYM.EQ.-1.OR.IDAYM.EQ.0) THEN
      CALL SKIPPR(NSFILE,NPROG,NLEVS)
      GO TO 4500
       ELSE IF(IDAYM.LT.NDAYB) THEN
      DO 44 NSKP=1,NSKIN
      READ(NSFILE)
   44 CONTINUE
      GO TO 4500
      ELSE
C.....................
C..... COMPUTE SIG TO P ON GGRID
C
      KFLD=1
      KFLO=1
      MEAN=.FALSE.
      NEWDAY=.TRUE.
      WRITE(6,226)IYR,MONTH,IDAY,HR
  226 FORMAT(' PROCESSING',I5,2I3,F7.2)
C     IF(SEQDA.EQ.'SEQU')WRITE(NPFILE)IYR,MONTH,IDAY,HR
C     IF(SEQDA.EQ.'DIRA')THEN
C     WRITE(UNIT=NPFILE,REC=IREC,IOSTAT=IER)IYR,MONTH,IDAY,HR
C     IREC=IREC+1
C     END IF
      WRITE(6,227)MEAN
  227 FORMAT(' STARTING POSTGG. MEAN=',L1)
      CALL POSTGG(PMAND,ALNPMD,MEAN,KFLD,KFLO,NSFILE,NEWDAY)
      WRITE(3,231)
      WRITE(6,231)
 231  FORMAT(1H0,'POSTGG FINISHED')
      DO 300 KP=1,NFLD
      IF(PRODIA(KP).EQ.DIAG)GO TO 310
  300 CONTINUE
  310 KP=KP-1
      KS=KFLD
      DO 350 KFLD=KS,KP
      WRITE(6,330)KFLD
  330 FORMAT(' PROCESSING INPUT FIELD NUMBER',I3)
      IF(MKDIR(KFLD).LT.1.OR.MKDIR(KFLD).EQ.100)THEN
      CALL SKIPF(NSFILE,NLEVS(KFLD))
      ELSE IF(NHARM(KFLD).EQ.NGAUS)THEN
      CALL RDFLD(NSFILE,GAUSIN,NGAUS,NLEVS(KFLD),DIMION)
      IF(MOD(MKDIR(KFLD),2).EQ.0)CALL SCASE(GAUSIN,KFLD,KFLO,
     *NLEVS(KFLD))
      CALL GTOR(GAUSIN,REGOUT,PSMB,
     *            PMAND,SL,NLEVS(KFLD),NVO(KFLO),
     *            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
      CALL RWRITE(REGOUT,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      ELSE IF(NHARM(KFLD).EQ.JKSCA)THEN
      CALL RDFLD(NSFILE,DI,JKSCA,NLEVS(KFLD),DIMION)
      CALL STOR(PMAND,ALNPMD,NLEVS(KFLD))
      CALL RWRITE(REGOUT,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
  350 CONTINUE
      KFLD=KP+1
      IF(KFLD.GT.NFLD)GO TO 2100
      WRITE(3, 380)
      WRITE(6,380)
 380  FORMAT(1H0,'PROGS FINISHED, DIAGS STARTING')
C PROCESS DIAGNOSTIC FIELDS
      MEAN=.TRUE.
      WRITE(6,227)MEAN
      CALL POSTGG(PMAND,ALNPMD,MEAN,KFLD,KFLO,NSFILE,NEWDAY)
      WRITE(3,231)
      WRITE(6,231)
      KS=KFLD
      DO 2000 KFLD=KS,NFLD
      WRITE(6,330)KFLD
      IF(MKDIR(KFLD).LT.1.OR.MKDIR(KFLD).EQ.100)THEN
      CALL SKIPF(NSFILE,NLEVS(KFLD))
      ELSE IF(NHARM(KFLD).EQ.NGAUS)THEN
      CALL RDFLD(NSFILE,GAUSIN,NGAUS,NLEVS(KFLD),DIMION)
      IF(MOD(MKDIR(KFLD),2).EQ.0)CALL SCASE(GAUSIN,KFLD,KFLO,
     *NLEVS(KFLD))
      CALL GTOR(GAUSIN,REGOUT,PSMB,
     *            PMAND,SL,NLEVS(KFLD),NVO(KFLO),
     *            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
      CALL RWRITE(REGOUT,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      ELSE IF(NHARM(KFLD).EQ.JKSCA)THEN
      CALL RDFLD(NSFILE,DI,JKSCA,NLEVS(KFLD),DIMION)
      CALL STOR(PMAND,ALNPMD,NLEVS(KFLD))
      CALL RWRITE(REGOUT,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
C
 2000 CONTINUE
 2100 WRITE(3,2500)
      WRITE(6,2500)
 2500 FORMAT(1H0,'DIAGNOSTICS COMPLETED')
C...END OF DIAGNOSTICS
          END IF
 4500 CONTINUE
9000  WRITE(3,160)
      WRITE(6,160)
 160  FORMAT(1H0,'ADVANCED TIME LOOP ')
 5000 CONTINUE
 9999 CLOSE(UNIT=NPFILE,STATUS='KEEP')
C     IF(DTIN.EQ.'TAPE')CALL OPSYS('$','TAPE REW (181$',IERX)
C     IF(DSKTAP.EQ.'TAPE')CALL OPSYS('$','TAPE REW (182$',IERY)
C     CALL EXIT
      STOP
      END
      SUBROUTINE CNVOUT(ARIN,AROUT,IDIM,IFR,ITO,IERR)
C     INCLUDE (PRMCNV)
      PARAMETER (NUNITS=220,NUMX=NUNITS-1,NGRP=NUNITS/10,NCF=1000,
     *NCF2=500,NGRMX=NGRP-1)
      CHARACTER VUNITS(-1:NUMX)*32,AUNITS(-1:NUMX)*16,
     *PUNITS(-1:NUMX)*32
      INTEGER LOOKU(0:9,0:9,0:NGRMX)
      DIMENSION CNFAC(NCF),CNFAC2(NCF2)
      COMMON/CVTBL/CNFAC,CNFAC2,LOOKU
      COMMON/CVTBL/VUNITS,AUNITS,PUNITS
      DIMENSION ARIN(IDIM),AROUT(IDIM)
      IF(IFR.LT.-1.OR.ITO.LT.-1)GO TO 700
      IF(IFR.GT.NUMX.OR.ITO.GT.NUMX)GO TO 700
      IF(IFR.EQ.-1)GO TO 300
      IF(ITO.EQ.-1)GO TO 300
      IF(ITO.EQ.IFR)GO TO 200
      IGPF=IFR/10
      IUF=MOD(IFR,10)
      IGPT=ITO/10
      IUT=MOD(ITO,10)
      IF(IGPF.NE.IGPT)GO TO 500
      ICF=LOOKU(IUF,IUT,IGPF)
      IF(ICF.EQ.0)GO TO 600
      CF=CNFAC(ICF)
      CF2=0.0
      IF(ICF.LE.NCF2)CF2=CNFAC2(ICF)
      DO 100 I=1,IDIM
      AROUT(I)=CF*ARIN(I)+CF2
  100 CONTINUE
  200 IERR=0
      RETURN
  300 IERR=-1
      RETURN
  500 IERR=1
      RETURN
  600 IERR=2
      RETURN
  700 IERR=3
      RETURN
      END
        SUBROUTINE CONFIL(ARRAY,IDIM,CONST)
        DIMENSION ARRAY(IDIM)
        DO 1000 I = 1 , IDIM
        ARRAY(I) = CONST
 1000   CONTINUE
        RETURN
        END
      SUBROUTINE DELLNP(Q,DPDPHI,DPDLAM,EPS)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     SR COMPUTES SPHERICAL HARMONIC COEFFICIENTS OF
C         COS(LAT) * GRAD(LN(PI))
C      FROM SPHERICAL HARMONIC COEFFICIENTS OF LN(PI)
C      USED IN NONLIN TERMS A AND B
C      WHEN GRAD(LN(PI)) IS NEEDED IN ZLN AND SIGMADOT
C      DIVIDE BY COS(LAT) AFTER EXPANSION ON LAT. CIRCLE,
      DIMENSION Q(2, JWAVE , KWAVE ),DPDPHI(2, JWAVE , KVEC ),
     1  DPDLAM(2, JWAVE , KWAVE ),EPS( JWAVE , KVEC )
C      NOTE DIFFERENT TRUNCATION IN GRADIENT COMPONENTS.
C     DPDPHI     = COS(LAT) D(LN(PI)) / A*D(LAT)
C     DPDLAM     =          D(LN(PI)) / A*D(LON) = I*L*Q
      DO 2 LL=1,  JWAVE
      FL=LL-1
      DO 2 IND=1,  KWAVE
      DPDLAM(1,LL,IND)=-Q(2,LL,IND)*FL
      DPDLAM(2,LL,IND)= Q(1,LL,IND)*FL
    2 CONTINUE
      KWM=KWAVE-1
      FKWM=FLOAT(KWM)
      DO 4 LL=1,  JWAVE
      XL=LL-1
      XN=XL
      DPDPHI(1,LL,1)= Q(1,LL,2)*(XL+2.0)*EPS(LL,2)
      DPDPHI(2,LL,1)= Q(2,LL,2)*(XL+2.0)*EPS(LL,2)
      DO 3 IND=2, KWM
      XN=XN+1.0
      DPDPHI(1,LL,IND)= (XN+2.0)*EPS(LL,IND+1)*
     1  Q(1,LL,IND+1)+(1.0-XN)*EPS(LL,IND)*Q(1,LL,IND-1)
      DPDPHI(2,LL,IND)= (XN+2.0)*EPS(LL,IND+1)*
     1  Q(2,LL,IND+1)+(1.0-XN)*EPS(LL,IND)*Q(2,LL,IND-1)
    3 CONTINUE
      DPDPHI(1,LL, KWAVE )=
     1       -(XL+ FKWM-1.0)*EPS(LL, KWAVE )*Q(1,LL,KWM )
      DPDPHI(2,LL, KWAVE )=
     1       -(XL+ FKWM-1.0)*EPS(LL, KWAVE )*Q(2,LL,KWM )
      DPDPHI(1,LL, KVEC )=
     1       -(XL+ FKWM)*EPS(LL, KVEC )*Q(1,LL, KWAVE )
      DPDPHI(2,LL, KVEC )=
     1       -(XL+ FKWM)*EPS(LL, KVEC )*Q(2,LL, KWAVE )
    4 CONTINUE
      AA=1.0/ 6370000.0
      DO 5 IND=1, KWAVE
      DO 5 LL=1, JWAVE
      DPDLAM(1,LL,IND)=DPDLAM(1,LL,IND)*AA
      DPDLAM(2,LL,IND)=DPDLAM(2,LL,IND)*AA
    5 CONTINUE
      DO 6 IND=1, KVEC
      DO 6 LL=1, JWAVE
      DPDPHI(1,LL,IND)=DPDPHI(1,LL,IND)*AA
      DPDPHI(2,LL,IND)=DPDPHI(2,LL,IND)*AA
    6 CONTINUE
      RETURN
      END
      SUBROUTINE DZTOUV(D,Z,U,V,E)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION D(2, JWAVE ,KWAVE),Z(2, JWAVE ,KWAVE),
     1   U(2, JWAVE ,KVEC),V(2, JWAVE ,KVEC),
     2   E( JWAVE ,KVEC)
C       COMPLEX CIL
C       L=0
      XN = 0.0
C       U(X,1,1) =  E(2,1)*Z(Y,2,1)
        U(1,1,1) =  E(1,2)*Z(1,1,2)
        U(2,1,1) =  E(1,2)*Z(2,1,2)
C       V(X,1,1) = -E(2,1)*D(Y,2,1)
        V(1,1,1) = -E(1,2)*D(1,1,2)
        V(2,1,1) = -E(1,2)*D(2,1,2)
      KWM=KWAVE-1
      DO 1 I=2,KWM
      XN = XN + 1.0
      R = 1.0/XN
      R1 = 1.0/(XN+1.0)
C     U(X,I,1)=-E(I,1)*Z(Y,I-1,1)*R+E(I+1,1)*Z(Y,I+1,1)*R1
      U(1,1,I)=-E(1,I)*Z(1,1,I-1)*R+E(1,I+1)*Z(1,1,I+1)*R1
      U(2,1,I)=-E(1,I)*Z(2,1,I-1)*R+E(1,I+1)*Z(2,1,I+1)*R1
C     V(X,I,1)= E(I,1)*D(Y,I-1,1)*R-E(I+1,1)*D(Y,I+1,1)*R1
      V(1,1,I)= E(1,I)*D(1,1,I-1)*R-E(1,I+1)*D(1,1,I+1)*R1
      V(2,1,I)= E(1,I)*D(2,1,I-1)*R-E(1,I+1)*D(2,1,I+1)*R1
    1 CONTINUE
      XN = XN + 1.0
      R = 1.0/XN
C       U(X,KWAVE,1) = -E(KWAVE,1)*Z(Y,KWM,1)*R
        U(1,1,KWAVE) = -E(1,KWAVE)*Z(1,1,KWM)*R
        U(2,1,KWAVE) = -E(1,KWAVE)*Z(2,1,KWM)*R
C       V(X,KWAVE,1) =  E(KWAVE,1)*D(Y,KWM,1)*R
        V(1,1,KWAVE) =  E(1,KWAVE)*D(1,1,KWM)*R
        V(2,1,KWAVE) =  E(1,KWAVE)*D(2,1,KWM)*R
      XN = XN + 1.0
      R = 1.0/XN
C       U(X,KVEC,1) = -E(KVEC,1)*Z(Y,KWAVE)*R
        U(1,1,KVEC) = -E(1,KVEC)*Z(1,1,KWAVE)*R
        U(2,1,KVEC) = -E(1,KVEC)*Z(2,1,KWAVE)*R
C       V(X,KVEC,1) =  E(KVEC,1)*D(Y,KWAVE)*R
        V(1,1,KVEC) =  E(1,KVEC)*D(1,1,KWAVE)*R
        V(2,1,KVEC) =  E(1,KVEC)*D(2,1,KWAVE)*R
C         FIN L=0
      DO 1000 L=2, JWAVE
      XL = L
      XN = XL-1.0
      XLL = XN
      R = 1.0/XN
      R1 = 1.0/XL
C       CIL=CMPLX(0.,1.)*(L-1)
C       U(X,1,L)=-CIL*D(Y,1,L)*R*R1 + E(2,L)*Z(Y,2,L)*R1
        U(1,L,1)= D(2,L,1)*R*R1*XLL+E(L,2)*Z(1,L,2)*R1
        U(2,L,1)=-D(1,L,1)*R*R1*XLL+E(L,2)*Z(2,L,2)*R1
C       V(X,1,L)=-CIL*Z(Y,1,L)*R*R1 - E(2,L)*D(Y,2,L)*R1
        V(1,L,1)= Z(2,L,1)*R*R1*XLL-E(L,2)*D(1,L,2)*R1
        V(2,L,1)=-Z(1,L,1)*R*R1*XLL-E(L,2)*D(2,L,2)*R1
      DO 2 I=2,KWM
      XN = XN+1.0
      R = 1.0/XN
      R1 = 1.0/(XN+1.0)
      R2 = R*R1
      RL = R2*XLL
C       U(X,I,L)=-E(I,L)*Z(Y,I-1,L)*R-CIL*D(Y,I,L)*R2
C                      + E(I+1,L)*Z(Y,I+1,L)*R1
      U(1,L,I)=-E(L,I)*Z(1,L,I-1)*R+D(2,L,I)*RL+E(L,I+1)*Z(1,L,I+1)*R1
      U(2,L,I)=-E(L,I)*Z(2,L,I-1)*R-D(1,L,I)*RL+E(L,I+1)*Z(2,L,I+1)*R1
C       V(X,I,L)= E(I,L)*D(Y,I-1,L)*R-CIL*Z(Y,I,L)*R2
C                      - E(I+1,L)*D(Y,I+1,L)*R1
      V(1,L,I)= E(L,I)*D(1,L,I-1)*R+Z(2,L,I)*RL-E(L,I+1)*D(1,L,I+1)*R1
      V(2,L,I)= E(L,I)*D(2,L,I-1)*R-Z(1,L,I)*RL-E(L,I+1)*D(2,L,I+1)*R1
    2 CONTINUE
      XN = XN +1.0
      R = 1.0/XN
      R1 = R/(XN+1.0)
C       U(X,KWAVE,L)=-E(KWAVE,L)*Z(Y,KWM,L)*R-CIL*D(Y,KWAVE,L)*R1
      U(1,L,KWAVE)=-E(L,KWAVE)*Z(1,L,KWM)*R+D(2,L,KWAVE)*R1*XLL
      U(2,L,KWAVE)=-E(L,KWAVE)*Z(2,L,KWM)*R-D(1,L,KWAVE)*R1*XLL
C       V(X,KWAVE,L)= E(KWAVE,L)*D(Y,KWM,L)*R-CIL*Z(Y,KWAVE,L)*R1
      V(1,L,KWAVE)= E(L,KWAVE)*D(1,L,KWM)*R+Z(2,L,KWAVE)*R1*XLL
      V(2,L,KWAVE)= E(L,KWAVE)*D(2,L,KWM)*R-Z(1,L,KWAVE)*R1*XLL
      XN = XN + 1.0
      R = 1.0/XN
C       U(X,KVEC,L) = -E(KVEC,L)*Z(Y,KWAVE,L)*R
        U(1,L,KVEC) = -E(L,KVEC)*Z(1,L,KWAVE)*R
        U(2,L,KVEC) = -E(L,KVEC)*Z(2,L,KWAVE)*R
C       V(X,KVEC,L) =  E(KVEC,L)*D(Y,KWAVE,L)*R
        V(1,L,KVEC) =  E(L,KVEC)*D(1,L,KWAVE)*R
        V(2,L,KVEC) =  E(L,KVEC)*D(2,L,KWAVE)*R
 1000 CONTINUE
C....
      DO 2000 IND=1,KVEC
      DO 2000 LL=1, JWAVE
      U(1,LL,IND)=U(1,LL,IND)* 6370000.0
      U(2,LL,IND)=U(2,LL,IND)* 6370000.0
      V(1,LL,IND)=V(1,LL,IND)* 6370000.0
      V(2,LL,IND)=V(2,LL,IND)* 6370000.0
 2000 CONTINUE
      RETURN
      END
      SUBROUTINE EPSLON(EPS,JCAP)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION EPS(JWAVE,KVEC)
      JCAP1 = JCAP + 1
      JCAP2 = JCAP + 2
      DO 1 LL=1,JCAP1
      L = LL - 1
      DO 1 INDE=2,JCAP2
      N = L + INDE - 1
      A = (N*N - L*L) / (4.0 * N*N - 1.0)
      EPS(LL,INDE)= SQRT (A)
1     CONTINUE
      DO 2 LL=1, JWAVE
      EPS(LL,1) = 0.0
2     CONTINUE
      RETURN
      END
      SUBROUTINE FFSNFS  (A,W,MFS)
      IMPLICIT REAL (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION A( LONG,MFS), W(NFFTF)
      JWV2M=JWV2-1
      DO 500 J = 1 , MFS
      DO 100 I = 2 , JWV2M
      A(I,J) = A(I+1,J)
  100 CONTINUE
      DO 200 I =JWV2, LONG
      A(I,J) = 0.0
  200 CONTINUE
      CALL RFFTB( LONG,A(1,J),W)
  500 CONTINUE
      RETURN
      END
      SUBROUTINE GETRH(SS,PS,SL,TS)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION SS(LONG,LEVG),PS(LONG),
     2SL(LEVG),TS(LONG,LEVG)
C
C* SS=Q ON INPUT,R.H. ON OUTPUT. PS=C.B.
C
      DO 10 K=1,LEVG
      DO 10 I=1,LONG
      IF(SS(I,K).LT.0.) SS(I,K)=0.0001
10    CONTINUE
C     R.H.=100*EOFP/ES
C     ES=6.11*EXP(L/R(1/273.16-1/T)) SAT VAP. PRES.(MB)
C     Q=0.622*EOFP/(P-.378*EOFP) MIXING RATIO
      RLRV=2.51E+10/(1.61*2.87E+6)
C***  FACTOR 1/10 CONVERTS TO CB.
      CONST=6.11*EXP(RLRV/273.16)  /  10.
C***  COMPUTE SAT. MIXING RATIO IN SATMIX
      DO 14 K=1,LEVG
      DO 14 I=1,LONG
      ES=CONST/EXP(RLRV/TS(I,K))
      SATMIX=0.622*ES/(SL(K)*PS(I)-0.378*ES)
      SS(I,K)=SS(I,K)/SATMIX
      IF(SS(I,K) .GT. 1.) SS(I,K) = 1.
14    CONTINUE
      RETURN
      END
      SUBROUTINE GETSH(SG,RG,PMAND,TG)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION SG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),PMAND(NMAND),
     2TG(LONR,LATR,NMAND)
C
C* SS=Q ON INPUT,R.H. ON OUTPUT. PMD=M.B.
C
C     R.H.=100*EOFP/ES
C     ES=6.11*EXP(L/R(1/273.16-1/T)) SAT VAP. PRES.(MB)
C     Q=0.622*EOFP/(P-.378*EOFP) MIXING RATIO
      RLRV=2.51E+10/(1.61*2.87E+6)
      CONST=6.11*EXP(RLRV/273.16)
C***  COMPUTE SAT. MIXING RATIO IN SATMIX
      DO 14 K=1,NMAND
      DO 14 J=1,LATR
      DO 14 I=1,LONR
      ARG=RLRV/TG(I,J,K)
      IF(ARG.GT.100.)ARG=100.
      IF(ARG.LT.0.)WRITE(3,12)ARG,I,J,K,TG(I,J,K)
   12 FORMAT(' BAD ARG=',E16.8,' AT',2I4,I3,' TG=',E16.8)
      ES=CONST/EXP(RLRV/TG(I,J,K))
      SATMIX=0.622*ES/(PMAND(K)-0.378*ES)
      IF(RG(I,J,K) .LT. 0.0) RG(I,J,K) = 0.0
      IF(RG(I,J,K) .GT. 1.0) RG(I,J,K) = 1.0
      SG(I,J,K)=RG(I,J,K)*SATMIX
14    CONTINUE
      RETURN
      END
      SUBROUTINE GETSLP(SLPG,ZG,PMAND)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION ZG(LONR,LATR,NMAND),SLPG(LONR,LATR),PMAND(NMAND)
      LOGICAL FIRST
      SAVE FIRST,L5,L10
      DATA    FIRST/.TRUE./
      IF(.NOT.FIRST)GO TO 10
      DO 3 L=1,NMAND
      IF(ABS(PMAND(L)-500.).LT..01)GO TO 5
    3 CONTINUE
      WRITE(3,4)
    4 FORMAT('- UNABLE TO FIND 500 MB LEVEL IN MANDATORY PRESSURE ARRAY'
     *)
      STOP 4
    5 L5=L
      DO 6 L=1,NMAND
      IF(ABS(PMAND(L)-1000.).LT..01)GO TO 8
    6 CONTINUE
      WRITE(3,7)
    7 FORMAT('-UNABLE TO FIND 1000 MB LEVEL IN MANDATORY PRESSURE ARRAY'
     *)
      STOP 7
    8 L10=L
      FIRST=.FALSE.
  10  DO 14 J=1,LATR
      DO 14 I=1,LONR
      XYZ=ZG(I,J,L10)/(1.5422885*(ZG(I,J,L5)-ZG(I,J,L10)))
c     WRITE(6,88) XYZ             
   88 FORMAT('XYZ=', e12.3) 
      SLPG(I,J) = 1000.0 *(EXP(XYZ)-1.0)
c     SLPG(I,J) = 1000.0 *
c    A (EXP(ZG(I,J,L10)/(1.5422885*(ZG(I,J,L5)-ZG(I,J,L10))))-1.0)
14    CONTINUE
      RETURN
      END
      SUBROUTINE GETTH(THG,PMAND,TG)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION THG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),PMAND(NMAND)
      WTL=ALOG(1000.0)
      R=287.05
      CP=1005.0
      ROCP=R/CP
      DO 14 K=1,NMAND
      EXNER=ROCP*(WTL-ALOG(PMAND(K)))
      EXNER=EXP(EXNER)
      DO 14 J=1,LATR
      DO 14 I=1,LONR
      THG(I,J,K)=TG(I,J,K)*EXNER
14    CONTINUE
      RETURN
      END
      SUBROUTINE GLATRP(KFULL,COLRAD)
      IMPLICIT REAL*8   (A-H,O-Z)
C      REAL          COLRAD
      DIMENSION COLRAD(KFULL)
      KHALF = KFULL / 2
      EPS=1.0E-12
C     WRITE(3,101)
C101  FORMAT ('0 I   COLAT   COLRAD',
C    1 10X, 'ITER  RES')
      SI = 1.0E+00
      K2=2*KHALF
      RK2=K2
      SCALE = 2.0E+00/(RK2**2)
      K1=K2-1
      PI = ATAN(SI)*4.0E+00
      DRADZ = PI / 360.0E+00
      RAD = 0.0E+00
      DO 1000 K=1,KHALF
      ITER=0
      DRAD=DRADZ
1     CALL POLY(K2,RAD,P2)
2     P1 =P2
      ITER=ITER+1
      RAD=RAD+DRAD
      CALL POLY(K2,RAD,P2)
      IF(SIGN(SI,P1).EQ.SIGN(SI,P2)) GO TO 2
      IF(DRAD.LT.EPS)GO TO 3
      RAD=RAD-DRAD
      DRAD = DRAD * 0.25E+00
      GO TO 1
3     CONTINUE
      COLRAD(K)=0.5E+00 * PI - RAD
      COLRAD(KFULL-K+1)=RAD - 0.5 * PI
      PHI = RAD * 180E+00 / PI
      CALL POLY(K1,RAD,P1)
      X = COS(RAD)
      CALL POLY(K2,RAD,P1)
C     WRITE(3, 102)K,PHI,COLRAD(K),ITER,P1
C102  FORMAT(1H ,I2,2X,F6.2,2X,F10.7,2X,I4,2X,D13.7)
1000  CONTINUE
      IF(MOD(KFULL,2) .EQ. 1) COLRAD(1+KFULL/2)=0.0
      WRITE(3, 100)KHALF
100   FORMAT(1H ,'SHALOM FROM 0.0 S 0 GLATS FOR ',I3)
      RETURN
      END
      SUBROUTINE GLATS(KHALF,COLRAD,WGT,WGTCS,RCS2)
      IMPLICIT REAL*8   (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
c      REAL          COLRAD,WGT,WGTCS,RCS2
      DIMENSION COLRAD(LATGH ),WGT(LATGH ),WGTCS(LATGH )
      DIMENSION RCS2(LATGH )
      EPS=1.0E-12
C     WRITE(3,101)
C101  FORMAT ('0 I   COLAT   COLRAD     WGT', 12X, 'WGTCS',
C    1 10X, 'ITER  RES')
      SI = 1.0E+00
      K2=2*KHALF
      RK2=K2
      SCALE = 2.0E+00/(RK2**2)
      K1=K2-1
      PI = ATAN(SI)*4.0E+00
      DRADZ = PI / 360.0E+00
      RAD = 0.0E+00
      DO 1000 K=1,KHALF
      ITER=0
      DRAD=DRADZ
1     CALL POLY(K2,RAD,P2)
2     P1 =P2
      ITER=ITER+1
      RAD=RAD+DRAD
      CALL POLY(K2,RAD,P2)
      IF(SIGN(SI,P1).EQ.SIGN(SI,P2)) GO TO 2
      IF(DRAD.LT.EPS)GO TO 3
      RAD=RAD-DRAD
      DRAD = DRAD * 0.25E+00
      GO TO 1
3     CONTINUE
      COLRAD(K)=RAD
      PHI = RAD * 180E+00 / PI
      CALL POLY(K1,RAD,P1)
      X = COS(RAD)
      W = SCALE * (1.0E+00 - X*X)/ (P1*P1)
      WGT(K) = W
      SN = SIN(RAD)
      W=W/(SN*SN)
      WGTCS(K) = W
      RC=1.0E+00/(SN*SN)
      RCS2(K) = RC
      CALL POLY(K2,RAD,P1)
C     WRITE(3, 102)K,PHI,COLRAD(K),WGT(K),WGTCS(K),ITER,P1
C102  FORMAT(1H ,I2,2X,F6.2,2X,F10.7,2X,E13.7,2X,E13.7,2X,I4,2X,D13.7)
1000  CONTINUE
      WRITE(3, 100)KHALF
100   FORMAT(1H ,'SHALOM FROM 0.0 S 0 GLATS FOR ',I3)
      RETURN
      END
      SUBROUTINE GTOR(GAUSIN,REGOUT,PSMB,
     *            PMAND,SL,NLEVS,NLEVR,
     *            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C     GENERAL PURPOSE GAUSSIAN TO REGULAR GRID INTERPOLATOR
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION GAUSIN(LONG,LATG,LEVG),REGOUT(LONR,LATR,NLEVR),
     1          PSMB(LONG,LATG),PMAND(NMAND),SL(LEVG),
     2       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     3       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
      DIMENSION WORK(LONG,NMAND),PIN(LEVG)
      CALL CONFIL(REGOUT,LONR*LATR*NLEVR,0.0)
      IF(NLEVS.GT.1.AND.NLEVS.LT.LEVG) THEN
       DO 120 K=NLEVS+1,LEVG
       DO 120 J=1,LATG
       DO 120 I=1,LONG
       GAUSIN(I,J,K)=0.
 120   CONTINUE
      END IF
      DO 10 LAT=1,LATG
C...SINGLE LEVEL INPUTS
      IF(NLEVS.EQ.1) THEN
      DO 110 I=1,LONG
      WORK(I,1)=GAUSIN(I,LAT,1)
 110  CONTINUE
      GO TO 100
      END IF
C...VERTICAL INTERPOLATION.
      DO 20 I=1,LONG
      DO 30 J=1,LEVG
      PIN(J)=SL(J)*PSMB(I,LAT)
  30  CONTINUE
      DO 40 K=1,NMAND
C........
      IF(PMAND(K).GT.PIN(1)) THEN
      WORK(I,K)=GAUSIN(I,LAT,1)
      GO TO 40
      END IF
C........
      IF(PMAND(K).LE.PIN(LEVG)) THEN
      WORK(I,K)=GAUSIN(I,LAT,LEVG)
      GO TO 40
      END IF
C.........
      DO 50 INT=1,LEVGM
      IF(PIN(INT).GE.PMAND(K).AND.PIN(INT+1).LT.PMAND(K)) GO TO 60
  50  CONTINUE
  60  CONTINUE
C     INTERPOLATION LINEAR IN P
      DELTAP=PMAND(K)-PIN(INT)
      DF=GAUSIN(I,LAT,INT+1)-GAUSIN(I,LAT,INT)
      DP=PIN(INT+1)-PIN(INT)
      WORK(I,K)=GAUSIN(I,LAT,INT)+(DF/DP)*DELTAP
  40  CONTINUE
  20  CONTINUE
 100  CONTINUE
C.......HORIZONTAL INTERPOLATION ON PRESSURE SURFACES
      CALL GTRPLT(LAT,WORK,LONG,NLEVR,LATG,REGOUT,LONR,LATR,
     1            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
  10  CONTINUE
C......POLAR AVERAGING (TREAT ALL AS SCALAR FIELDS)
      CALL POLAVG(REGOUT,LONR,LATR,NLEVR)
      RETURN
      END
      SUBROUTINE GTRPLT(LATCUR,FIELDA,LONA,LEVS,LATA,FIELDB,LONB,LATB,
     A                  TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
      DIMENSION FIELDA(LONA,LEVS),FIELDB(LONB,LATB,LEVS),
     A          TRPLON((LONB-1)/LONA+2,LONA),
     B          TRPLAT((LATB-1)/LATA+2,LATA),
     C          LONTRP((LONB-1)/LONA+2,LONA),NLNTRP(LONA),
     D          LATTRP((LATB-1)/LATA+2,LATA),NLTTRP(LATA)
c     DO 1000 K = 1 , LEVS
c     DO 1000 I = 1 , LONA
c     DO 1000 JT = 1 , NLTTRP(LATCUR)
c     DO 1000 IT = 1 , NLNTRP(I)
c     FIELDB(LONTRP(IT,I),LATTRP(JT,LATCUR),K)=
c    A       FIELDB(LONTRP(IT,I),LATTRP(JT,LATCUR),K) +
c    B       TRPLON(IT,I) * TRPLAT(JT,LATCUR) * FIELDA(I,K)
c1000 CONTINUE
      DO 1000 K = 1 , LEVS
      DO 1000 I = 1 , LONA
         FIELDB(I,LATCUR,K)=FIELDA(I,K)
 1000 CONTINUE
      RETURN
      END
      SUBROUTINE GTRPWT(ALONP,ALATP,LONA,LATA,ALONE,ALATE,
     A                  BLONP,BLATP,LONB,LATB,BLONE,BLATE,
     B                  TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
      DIMENSION ALONP(LONA),ALATP(LATA),
     A          ALONE(LONA+1),ALATE(LATA+1),
     B          BLONP(LONB),BLATP(LATB),
     C          BLONE(LONB+1),BLATE(LATB+1),
     D          TRPLON((LONA-1)/LONB+2,LONB),
     E          TRPLAT((LATA-1)/LATB+2,LATB),
     F          LONTRP((LONA-1)/LONB+2,LONB),NLNTRP(LONB),
     G          LATTRP((LATA-1)/LATB+2,LATB),NLTTRP(LATB)
      PI = 4.0 * ATAN(1.0)
      ALONE(1) = 0.5 * (ALONP(1) + ALONP(LONA))
     A                                - SIGN(PI,ALONP(LONA) - ALONP(1))
      DO 10 LON = 2 , LONA
      ALONE(LON) = 0.5 * (ALONP(LON-1) + ALONP(LON))
   10 CONTINUE
      ALONE(LONA+1) = ALONE(1) + 2.0 * SIGN(PI,ALONP(LONA) - ALONP(1))
      BLONE(1) = 0.5 * (BLONP(1) + BLONP(LONB))
     A                                - SIGN(PI,BLONP(LONB) - BLONP(1))
      DO 20 LON = 2 , LONB
      BLONE(LON) = 0.5 * (BLONP(LON-1) + BLONP(LON))
   20 CONTINUE
      BLONE(LONB+1) = BLONE(1) + 2.0 * SIGN(PI,BLONP(LONB) - BLONP(1))
      ALATE(1) = SIGN(0.5 * PI,ALATP(1))
      DO 30 LAT = 2 , LATA
      ALATE(LAT) = 0.5 * (ALATP(LAT-1) + ALATP(LAT))
   30 CONTINUE
      ALATE(LATA+1) = SIGN(0.5 * PI,ALATP(LATA))
      BLATE(1) = SIGN(0.5 * PI,BLATP(1))
      DO 40 LAT = 2 , LATB
      BLATE(LAT) = 0.5 * (BLATP(LAT-1) + BLATP(LAT))
   40 CONTINUE
      BLATE(LATB+1) = SIGN(0.5 * PI,BLATP(LATB))
      IF(ALATP(1) .LT. ALATP(LATA)) GO TO 50
      LATAIN = -1
      LATABG = LATA + 1
      LATAEN = 2
      GO TO 60
   50 LATAIN = 1
      LATABG = 1
      LATAEN = LATA
   60 IF(BLATP(1) .LT. BLATP(LATB)) GO TO 70
      LATBIN = -1
      LATBBG = LATB + 1
      LATBEN = 2
      GO TO 80
   70 LATBIN = 1
      LATBBG = 1
      LATBEN = LATB
   80 IF(ALONP(1) .LT. ALONP(LONA)) GO TO 90
      LONAIN = -1
      LONABG = LONA + 1
      LONAEN = 2
      GO TO 100
   90 LONAIN = 1
      LONABG = 1
      LONAEN = LONA
  100 IF(BLONP(1) .LT. BLONP(LONB)) GO TO 110
      LONBIN = -1
      LONBBG = LONB + 1
      LONBEN = 2
      GO TO 120
  110 LONBIN = 1
      LONBBG = 1
      LONBEN = LONB
  120 LAT1 = LATABG
      DO 200 LAT2 = LATBBG , LATBEN , LATBIN
      IC = 0
  125 WIDLAT = SIN(ALATE(LAT1+LATAIN)) - SIN(ALATE(LAT1))
      IF(ALATE(LAT1) .LE. BLATE(LAT2) .AND.
     A ALATE(LAT1+LATAIN) .GE. BLATE(LAT2+LATBIN)) GO TO 150
      IF(ALATE(LAT1+LATAIN) .GT. BLATE(LAT2) .AND.
     A ALATE(LAT1+LATAIN) .LE. BLATE(LAT2+LATBIN)) GO TO 140
      IF(ALATE(LAT1) .LT. BLATE(LAT2+LATBIN) .AND.
     A ALATE(LAT1) .GE. BLATE(LAT2)) GO TO 130
      GO TO 180
  130 XLAT1 = AMIN1(ALATE(LAT1+LATAIN),BLATE(LAT2+LATBIN))
      XLAT2 = ALATE(LAT1)
      GO TO 160
  140 XLAT1 = ALATE(LAT1+LATAIN)
      XLAT2 = AMAX1(ALATE(LAT1),BLATE(LAT2))
      GO TO 160
  150 XLAT1 = BLATE(LAT2+LATBIN)
      XLAT2 = BLATE(LAT2)
  160 IC = IC + 1
      LATTB2 = LAT2
      IF(LATBIN .EQ. -1) LATTB2 = LAT2 - 1
      TRPLAT(IC,LATTB2) = (SIN(XLAT1) - SIN(XLAT2)) / WIDLAT
      LATTB1 = LAT1
      IF(LATAIN .EQ. -1) LATTB1 = LAT1 - 1
      LATTRP(IC,LATTB2) = LATTB1
      IF(XLAT1 .EQ. BLATE(LAT2+LATBIN)) GO TO 190
  180 LAT1 = LAT1 + LATAIN
      GO TO 125
  190 NLTTRP(LATTB2) = IC
  200 CONTINUE
      LON1 = LONABG
      DO 300 LON2 = LONBBG , LONBEN , LONBIN
      IC = 0
  225 WIDLON = ALONE(LON1+LONAIN) - ALONE(LON1)
      IF(ALONE(LON1) .LE. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) .GE. BLONE(LON2+LONBIN)) GO TO 250
      IF(ALONE(LON1) + 2.0 * PI .LE. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) + 2.0 * PI .GE. BLONE(LON2+LONBIN)) GO TO 250
      IF(ALONE(LON1) - 2.0 * PI .LE. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) - 2.0 * PI .GE. BLONE(LON2+LONBIN)) GO TO 250
      IF(ALONE(LON1+LONAIN) .GT. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) .LE. BLONE(LON2+LONBIN)) GO TO 240
      IF(ALONE(LON1+LONAIN) + 2.0 * PI .GT. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) + 2.0 * PI .LE. BLONE(LON2+LONBIN)) GO TO 243
      IF(ALONE(LON1+LONAIN) - 2.0 * PI .GT. BLONE(LON2) .AND.
     A ALONE(LON1+LONAIN) - 2.0 * PI .LE. BLONE(LON2+LONBIN)) GO TO 247
      IF(IC .EQ. 0) GO TO 280
      IF(ALONE(LON1) .LT. BLONE(LON2+LONBIN) .AND.
     A ALONE(LON1) .GE. BLONE(LON2)) GO TO 230
      IF(ALONE(LON1) + 2.0 * PI .LT. BLONE(LON2+LONBIN) .AND.
     A ALONE(LON1) + 2.0 * PI .GE. BLONE(LON2)) GO TO 233
      IF(ALONE(LON1) - 2.0 * PI .LT. BLONE(LON2+LONBIN) .AND.
     A ALONE(LON1) - 2.0 * PI .GE. BLONE(LON2)) GO TO 237
      GO TO 280
  230 XLON1 = AMIN1(ALONE(LON1+LONAIN),BLONE(LON2+LONBIN))
      XLON2 = ALONE(LON1)
      GO TO 260
  233 XLON1 = AMIN1(ALONE(LON1+LONAIN) + 2.0 * PI,BLONE(LON2+LONBIN))
      XLON2 = ALONE(LON1) + 2.0 * PI
      GO TO 260
  237 XLON1 = AMIN1(ALONE(LON1+LONAIN) - 2.0 * PI,BLONE(LON2+LONBIN))
      XLON2 = ALONE(LON1) - 2.0 * PI
      GO TO 260
  240 IF(IC .EQ. 0 .AND. ALONE(LON1) .LT. BLONE(LON2+LONBIN)
     A .AND. ALONE(LON1) .GT. BLONE(LON2)) GO TO 280
      XLON1 = ALONE(LON1+LONAIN)
      XLON2 = AMAX1(ALONE(LON1),BLONE(LON2))
      GO TO 260
  243 IF(IC .EQ. 0 .AND. ALONE(LON1) + 2.0 * PI .LT. BLONE(LON2+LONBIN)
     A .AND. ALONE(LON1) + 2.0 * PI .GT. BLONE(LON2)) GO TO 280
      XLON1 = ALONE(LON1+LONAIN) + 2.0 * PI
      XLON2 = AMAX1(ALONE(LON1) + 2.0 * PI,BLONE(LON2))
      GO TO 260
  247 IF(IC .EQ. 0 .AND. ALONE(LON1) - 2.0 * PI .LT. BLONE(LON2+LONBIN)
     A .AND. ALONE(LON1) - 2.0 * PI .GT. BLONE(LON2)) GO TO 280
      XLON1 = ALONE(LON1+LONAIN) - 2.0 * PI
      XLON2 = AMAX1(ALONE(LON1) - 2.0 * PI,BLONE(LON2))
      GO TO 260
  250 XLON1 = BLONE(LON2+LONBIN)
      XLON2 = BLONE(LON2)
  260 IC = IC + 1
      LONTB2 = LON2
      IF(LONBIN .EQ. -1) LONTB2 = LON2 - 1
      TRPLON(IC,LONTB2) = (XLON1 - XLON2) / WIDLON
      LONTB1 = LON1
      IF(LONAIN .EQ. -1) LONTB1 = LON1 - 1
      LONTRP(IC,LONTB2) = LONTB1
      IF(XLON1 .EQ. BLONE(LON2+LONBIN)) GO TO 290
  280 LON1 = LON1 + LONAIN
      IF(LONAIN .EQ. -1 .AND. LON1 .LT. LONAEN) LON1 = LONABG
      IF(LONAIN .EQ. 1 .AND. LON1 .GT. LONAEN) LON1 = LONABG
      GO TO 225
  290 NLNTRP(LONTB2) = IC
  300 CONTINUE
      RETURN
      END
      SUBROUTINE LAPLAC(SNNP1,JCAP)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION SNNP1(JKSCA )
      JCAP1 = JCAP + 1
      IH = 0
      DO 10 N = 1 , JCAP1
      XN = FLOAT(N - 1)
      DO 10 L = 1 , JCAP1
      XNNP1 = XN * (XN + 1.0)
      SNNP1(IH+1) = XNNP1
      SNNP1(IH+2) = XNNP1
      IH = IH + 2
      XN = XN + 1.0
   10 CONTINUE
      RETURN
      END
      SUBROUTINE OMEGAS(DPHI,DLAM,CG,UG,VG,DG,DEL,RCL,TAU,PS,SL)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION DPHI( LONG),DLAM( LONG),
     1 CG( LONG,LEVG),UG( LONG,LEVG),VG( LONG,LEVG),
     2 DG( LONG,LEVG),DEL(LEVG),PS( LONG),SL(LEVG),RMSDOT(LEVGM)
      DIMENSION TAU( LONG,LEVG)
C***   TAU CONTAINS CONTRIB. TO OMEGA IN LAYERS ON RETURN FROM SR
      DIMENSION DB(LEVG),CB(LEVG),DOT(LEVGP)
      SAVE DOT,RMSDOT
      DATA DOT/LEVGP*0./,RMSDOT/LEVGM*0./
C     COMPUTE C=V(TRUE)*DEL(LN(PS)).DIVIDE BY COS FOR DEL COS FOR V
      DO 3 LO=1, LONG
      DPHI(LO)=DPHI(LO)*RCL
      DLAM(LO)=DLAM(LO)*RCL
3     CONTINUE
      DO 5 LE=1,LEVG
      DO 4 LO=1, LONG
      CG(LO,LE)=UG(LO,LE)*DLAM(LO)+VG(LO,LE)*DPHI(LO)
4     CONTINUE
5     CONTINUE
      DO 1000 LO=1, LONG
      DB(1)=DEL(1)*DG(LO,1)
      CB(1)=DEL(1)*CG(LO,1)
      DO 6 LE=1,LEVGM
      DB(LE+1)=DB(LE)+DEL(LE+1)*DG(LO,LE+1)
      CB(LE+1)=CB(LE)+DEL(LE+1)*CG(LO,LE+1)
6     CONTINUE
C
C     SIGMA DOT COMPUTED ONLY AT INTERIOR INTERFACES
      DO 7 K=1,LEVGM
      DOT(K+1)=DOT(K)+DEL(K)*(DB(LEVG)+CB(LEVG)-DG(LO,K)-CG(LO,K))
      RMSDOT(K)=RMSDOT(K)+DOT(K+1)*DOT(K+1)
7     CONTINUE
      DO 8 K=1,LEVG
      TAU(LO,K)=       SL(K)*(CG(LO,K)-CB(LEVG)-DB(LEVG))-
     1 0.5*(DOT(K+1)+DOT(K))
      TAU(LO,K)=TAU(LO,K)*PS(LO)*10.
8      CONTINUE
1000  CONTINUE
      RETURN
      END
      SUBROUTINE PLN2(SLN,COLRAD,LAT,XXX)
      IMPLICIT REAL   (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
       REAL  SLN,COLRAD
      DIMENSION SLN(JWAVE,KVEC),COLRAD(LATGH),EPS(JWAVE,KVEC)
      COMMON /SCRTCH/ X(JWAVE),Y(JWAVE),PLN(JWAVE,KVEC)
      SAVE EPS,IFIR
      DATA IFIR/0/
      IF(IFIR.EQ.1) GO TO 3
      DO 1 LL=1,JWAVE
      L = LL - 1
      DO 1 INDE=2,KVEC
      N = L + INDE - 1
      A = FLOAT(N*N - L*L) / (4.0E+00 * FLOAT(N*N) - 1.0E+00)
      EPS(LL,INDE) = SQRT(A)
1     CONTINUE
      DO 2 LL=1,JWAVE
      EPS(LL,1) = 0.0E+00
2     CONTINUE
      IFIR=1
3     CONTINUE
      COLR=COLRAD(LAT)
      SINLAT = COS(COLR)
      COS2 = 1.0E+00 - SINLAT * SINLAT
      PROD = 1.0E+00
      A = 1.0E+00
      B = 0.0E+00
      DO 5 LL=1,JWAVE
      X(LL)=FLOAT(2*LL+1)
      Y(LL)=X(LL)/(X(LL)-1.0E+00)
5     CONTINUE
      DO 10 LL=1, JWAVE
      PLN(LL,1)=0.5E+00*PROD
      FRAC=Y(LL)
      IF(PROD.LT.1.0E-35)PROD=0.0E+00
      PROD=PROD*COS2*FRAC
   10 CONTINUE
      DO 15 LL=1, JWAVE
      PLN(LL,1)=SQRT(PLN(LL,1))
      PLN(LL,2)=SQRT(X(LL))
     1           *SINLAT*PLN(LL,1)
   15 CONTINUE
      DO 20 N=3, KVEC
      DO 20 LL=1, JWAVE
      PLN(LL,N) = (SINLAT*PLN(LL,N-1)
     1   - EPS(LL,N-1)*PLN(LL,N-2))/EPS(LL,N)
   20 CONTINUE
      DO 30 N=1, KVEC
      DO 30 LL=1, JWAVE
      SLN(LL,N)=PLN(LL,N)
   30 CONTINUE
      RETURN
      END
      SUBROUTINE POLAVG(FIELD,LONS,LATS,LEVS)
      DIMENSION FIELD(LONS,LATS,LEVS)
c     DO 3000 L = 1 , LEVS
c     TOT1 = 0.0
c     TOT2 = 0.0
c     DO 1000 I = 1 , LONS
c     TOT1 = TOT1 + FIELD(I,1,L)
c     TOT2 = TOT2 + FIELD(I,LATS,L)
c1000 CONTINUE
c     TOT1 = TOT1 / FLOAT(LONS)
c     TOT2 = TOT2 / FLOAT(LONS)
c     DO 2000 I = 1 , LONS
c     FIELD(I,1,L) = TOT1
c     FIELD(I,LATS,L) = TOT2
c2000 CONTINUE
c3000 CONTINUE
      RETURN
      END
      SUBROUTINE POLEUV(U,V,NLON,NLAT,LEVS,CTLON,STLON)
      DIMENSION U(NLON,NLAT,LEVS),V(NLON,NLAT,LEVS),CTLON(NLON),
     A STLON(NLON)
      LOGICAL FIRST
      SAVE FIRST,NLATM1,PI,DLON,DLAT
      DATA    FIRST/.TRUE./
      IF(.NOT.FIRST) GO TO 3
      NLATM1 = NLAT - 1
      PI = 3.141593
      DLON = 2.0 * PI / FLOAT(NLON)
      DLAT = PI / FLOAT(NLAT - 1)
      DO 1 I = 1 , NLON
      XLN = FLOAT(I - 1) * DLON - PI
      CTLON(I) = COS(XLN)
      STLON(I) = SIN(XLN)
    1 CONTINUE
      FIRST = .FALSE.
    3 DO 20 K = 1 , LEVS
      SUMUNP = 0.0
      SUMUSP = 0.0
      SUMVNP = 0.0
      SUMVSP = 0.0
      DO 10 I = 1 , NLON
      SUMUNP = SUMUNP + U(I,NLAT,K) * CTLON(I) -
     A V(I,NLAT,K) * STLON(I)
      SUMVNP = SUMVNP + U(I,NLAT,K) * STLON(I) +
     A V(I,NLAT,K) * CTLON(I)
      SUMUSP = SUMUSP + U(I,1,K) * CTLON(I) + V(I,1,K) * STLON(I)
      SUMVSP = SUMVSP - U(I,1,K) * STLON(I) + V(I,1,K) * CTLON(I)
   10 CONTINUE
      SUMUNP = SUMUNP / FLOAT(NLON)
      SUMVNP = SUMVNP / FLOAT(NLON)
      SUMUSP = SUMUSP / FLOAT(NLON)
      SUMVSP = SUMVSP / FLOAT(NLON)
      DO 20 I = 1 , NLON
      U(I,NLAT,K) = SUMUNP * CTLON(I) + SUMVNP * STLON(I)
      V(I,NLAT,K) = -SUMUNP * STLON(I) + SUMVNP * CTLON(I)
      U(I,1,K) = SUMUSP * CTLON(I) - SUMVSP * STLON(I)
      V(I,1,K) = SUMUSP * STLON(I) + SUMVSP * CTLON(I)
   20 CONTINUE
      RETURN
      END
      SUBROUTINE POLY(N,RAD,P)
      IMPLICIT REAL*8 (A-H,O-Z)
C     X = DCOS(RAD)
      X = COS(RAD)
      Y1 = 1.0E+00
      Y2=X
      DO 1 I=2,N
      G=X*Y2
C     Y3=G-Y1+G-(G-Y1)/DFLOAT(I)
      Y3=G-Y1+G-(G-Y1)/FLOAT(I)
      Y1=Y2
      Y2=Y3
1     CONTINUE
      P=Y3
      RETURN
      END
      SUBROUTINE POSTGG(PMAND,ALNPMD,MEAN,KFLD,KFLO,NSFILE,NEWDAY)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOGICAL FIRST,SECOND,MEAN,NOMEAN,
     *DOPF(16,2),NEWDAY
      CHARACTER*40 INF(5,2)
      CHARACTER*40 OPF(16,2)
      SAVE FIRST,SECOND,NOMEAN,DOPF,INF,OPF
      DATA INF/
     *'LN SURFACE PRESSURE                     ',
     *'DIVERGENCE                              ',
     *'VORTICITY                               ',
     *'SPECIFIC HUMIDITY                       ',
     *'VIRTUAL TEMPERATURE                     ',
     *'TIME MEAN LN SURFACE PRESSURE           ',
     *'TIME MEAN DIVERGENCE                    ',
     *'TIME MEAN VORTICITY                     ',
     *'TIME MEAN SPECIFIC HUMIDITY             ',
     *'TIME MEAN VIRTUAL TEMPERATURE           '/
      DATA (OPF(I,1),I=1,16)/
     *'SURFACE PRESSURE                        ',
     *'MASK                                    ',
     *'DIVERGENCE                              ',
     *'VORTICITY                               ',
     *'ZONAL WIND (U)                          ',
     *'MERIDIONAL WIND (V)                     ',
     *'OMEGA                                   ',
     *'STREAM FUNCTION                         ',
     *'VELOCITY POTENTIAL                      ',
     *'VIRTUAL TEMPERATURE                     ',
     *'GEOPOTENTIAL HEIGHT                     ',
     *'SEA LEVEL PRESSURE                      ',
     *'ABSOLUTE TEMPERATURE                    ',
     *'RELATIVE HUMIDITY                       ',
     *'SPECIFIC HUMIDITY                       ',
     *'POTENTIAL TEMPERATURE                   '/
      DATA (OPF(I,2),I=1,16)/
     *'TIME MEAN SURFACE PRESSURE              ',
     *'TIME MEAN MASK                          ',
     *'TIME MEAN DIVERGENCE                    ',
     *'TIME MEAN VORTICITY                     ',
     *'TIME MEAN ZONAL WIND (U)                ',
     *'TIME MEAN MERIDIONAL WIND (V)           ',
     *'TIME MEAN DERIVED OMEGA                 ',
     *'TIME MEAN STREAM FUNCTION               ',
     *'TIME MEAN VELOCITY POTENTIAL            ',
     *'TIME MEAN VIRTUAL TEMPERATURE           ',
     *'TIME MEAN GEOPOTENTIAL HEIGHT           ',
     *'TIME MEAN SEA LEVEL PRESSURE            ',
     *'TIME MEAN ABSOLUTE TEMPERATURE          ',
     *'TIME MEAN RELATIVE HUMIDITY             ',
     *'TIME MEAN SPECIFIC HUMIDITY             ',
     *'TIME MEAN POTENTIAL TEMPERATURE         '/
      DATA    FIRST/.TRUE./,SECOND/.FALSE./,NOMEAN/.FALSE./
C**********************************************************************
C
C      PLN2 CALCULATES LEGENDRE FUNCTIONS AT ONE GAUSSIAN LATITUDE.
C
C**********************************************************************
      IF(.NOT.FIRST)GO TO 600
      IF(MEAN)GO TO 8000
      ID=1
      JJ=1
C     SAVE ALL PLNS
      DO 400 LAT=1,LATGH
      CALL PLN2(PLN(1,LAT),COLRAD,LAT,EPS)
  400 CONTINUE
C     CHECK THAT THE INPUT FIELD IS COMPLETE AND WELL ORDERED
      KT=KFLD
      DO 450 MM=1,5
      IF(INF(MM,1).NE.CHRDSC(KT))GO TO 9000
      KT=KT+1
  450 CONTINUE
C     CHECK THAT THE OUTPUT FIELD IS WELL ORDERED. IGNORE UNDESIRED
C     OUTPUT FIELDS.
      DO 460 II=1,16
      DOPF(II,1)=.FALSE.
  460 CONTINUE
      KT=KFLO
  470 DO 475 II=JJ,16
      IF(OPF(II,1).NE.CHROP(KT))GO TO 475
      DOPF(II,1)=.TRUE.
      GO TO 480
  475 CONTINUE
      GO TO 490
  480 KT=KT+1
      JJ=II
      GO TO 470
  490 FIRST=.FALSE.
      SECOND=.TRUE.
      WRITE(3,495)(DOPF(I,1),I=1,16)
  495 FORMAT(' DOPF(,1)=',16L2)
      GO TO 700
  600 IF(.NOT.SECOND)GO TO 700
      IF(NEWDAY)GO TO 700
      IF(.NOT.MEAN)GO TO 8000
      ID=2
      JJ=1
C     CHECK THAT THE TIME MEAN INPUT FIELD IS COMPLETE AND WELL ORDERED
      KT=KFLD
      DO 650 MM=1,5
      IF(INF(MM,2).NE.CHRDSC(KT))GO TO 8500
      KT=KT+1
  650 CONTINUE
C     CHECK THAT THE TIME MEAN OUTPUT FIELD IS WELL ORDERED. IGNORE
C     UNDESIRED OUTPUT FIELDS.
      DO 660 II=1,16
      DOPF(II,2)=.FALSE.
  660 CONTINUE
      KT=KFLO
  670 DO 675 II=JJ,16
      IF(OPF(II,2).NE.CHROP(KT))GO TO 675
      DOPF(II,2)=.TRUE.
      GO TO 680
  675 CONTINUE
      GO TO 690
  680 KT=KT+1
      JJ=II
      GO TO 670
  690 SECOND=.FALSE.
      WRITE(3,695)(DOPF(I,2),I=1,16)
  695 FORMAT(' DOPF(,2)=',16L2)
  700 CONTINUE
      IF(MEAN.AND.NOMEAN)RETURN
      ID=1
      IF(MEAN)ID=2
      CALL RDFLD(NSFILE,Q,NHARM(KFLD),NLEVS(KFLD),DIMION)
      KFLD=KFLD+1
      CALL RDFLD(NSFILE,DI,NHARM(KFLD),NLEVS(KFLD),DIMION)
      KFLD=KFLD+1
      CALL RDFLD(NSFILE,ZE,NHARM(KFLD),NLEVS(KFLD),DIMION)
      KFLD=KFLD+1
      IF(DOPF(1,ID).OR.DOPF(2,ID).OR.DOPF(3,ID).OR.DOPF(4,ID))
     *CALL POSTG1(PMAND,ALNPMD,KFLO,DOPF,ID)
      IF(DOPF(5,ID).OR.DOPF(6,ID).OR.DOPF(7,ID))
     *CALL POSTG2(PMAND,ALNPMD,KFLO,DOPF,ID)
      IF(DOPF(8,ID).OR.DOPF(9,ID))
     *CALL POSTG3(PMAND,ALNPMD,KFLO,DOPF,ID)
      CALL RDFLD(NSFILE,RQ,NHARM(KFLD),NLEVS(KFLD),DIMION)
      KFLD=KFLD+1
      CALL RDFLD(NSFILE,TE,NHARM(KFLD),NLEVS(KFLD),DIMION)
      KFLD=KFLD+1
      IF(DOPF(10,ID).OR.DOPF(11,ID).OR.DOPF(12,ID))
     *CALL POSTG4(PMAND,ALNPMD,KFLO,DOPF,ID)
      IF(DOPF(13,ID).OR.DOPF(14,ID).OR.DOPF(15,ID))
     *CALL POSTG5(PMAND,ALNPMD,KFLO,DOPF,ID)
      IF(DOPF(16,ID))THEN
C***********************************************************************
C
C     GETTH CALCULATES POTENTIAL TEMPERATURE FROM TEMPERATURE.
C
C***********************************************************************
      CALL GETTH(THG,PMAND,TG)
      CALL RWRITE(THG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      NEWDAY=.FALSE.
      RETURN
 8000 WRITE(3,8100)FIRST,SECOND,MEAN
 8100 FORMAT(' FIRST, SECOND, MEAN INCONSISTENT:',3L4)
      STOP 8100
 8500 IF(MM.GT.1)GO TO 9000
      DO 8600 MM=2,5
      IF(INF(MM,ID).EQ.CHRDSC(KT))GO TO 8700
 8600 CONTINUE
      SECOND=.FALSE.
      NOMEAN=.TRUE.
      NEWDAY=.FALSE.
      RETURN
 8700 MM=MM-1
 9000 WRITE(3,9100)MEAN,MM,KT,INF(MM,ID),CHRDSC(KT)
 9100 FORMAT(' AT MEAN=',L2,' MM=',I2,' KT=',I3,' INF=',1X,A40/' ',
     *22X,'CHRDSC=',1X,A40)
      STOP 9100
      END
      SUBROUTINE POSTG1(PMAND,ALNPMD,KFLO,DOPF,ID)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOGICAL DOPF(16,2)
      CALL DELLNP (Q, DPDPHI, DPDLAM, EPS)
       CALL CONFIL(DG, LTLO * NMAND ,0.0)
       CALL CONFIL(XG, LTLO * NMAND ,0.0)
       CALL CONFIL(QG, LTLO ,0.0)
C**********************************************************************
C
C      GAUSSIAN LOOP PERFORMS LEGENDRE TRANSFORMS, FOURIER TRANSFORMS
C      INTO GAUSSIAN GRID, LATITUDE-BY-LATITUDE.  GAUSSIAN GRIDS ARE
C      THEN AREALLY INTERPOLATED INTO OUTPUT  GRIDS.
C
C**********************************************************************
      DO 1000 LAT = 1,LATGH
        DO 800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
  800   CONTINUE
C**********************************************************************
C
C     SUMPLS, SUMPLV PERFORM LEGENDRE TRANSFORMS FROM SPECTRAL TO
C     FOURIER REPRESENTATIONS.
C
C**********************************************************************
      CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(DI,DIA,DIB,QLN,LEVG)
      CALL SUMPLS(ZE,ZEA,ZEB,QLN,LEVG)
      CALL SUMPLS(Q,Q3,Q4,QLN, 1 )
C..................................................
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(Q3,SCNMC,2+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 830 I=1,LONG
      QA(I)=EXP(QA(I))
  830 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QA,SI,SL,PMAND,ALNPMD,DEL,2,DIA,DIPA,ZEA,ZEPA)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LAT,DIPA,LONG,2*NMAND,LATG,DG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C
C        SAVE SURFACE PRESSURE ON GAUSSIAN GRID (NH)
C
C***********************************************************************
      DO 850 ILONGS=1,LONG
      PSMB(ILONGS,LAT)=10.*EXP(Q3(ILONGS))
  850 CONTINUE
      CALL GTRPLT(LAT,Q3,LONG,1,LATG,QG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(Q4,SCNMC,2+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 860 I=1,LONG
      QB(I)=EXP(QB(I))
  860 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QB,SI,SL,PMAND,ALNPMD,DEL,2,DIB,DIPB,ZEB,ZEPB)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LATCO,DIPB,LONG,2*NMAND,LATG,DG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C
C        SAVE SURFACE PRESSURE ON GAUSSIAN GRID (SH)
C
C***********************************************************************
      DO 900 ILONGS=1,LONG
      PSMB(ILONGS,LATCO)=10.*EXP(Q4(ILONGS))
  900 CONTINUE
      CALL GTRPLT(LATCO,Q4,LONG,1,LATG,QG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 1000 CONTINUE
C***********************************************************************
C
C     POLAVG FIXES POLAR VALUES OF SCALAR FIELDS PRODUCED BY
C     AREAL INTERPOLATING ROUTINE TERPWT.
C
C***********************************************************************
      CALL POLAVG(DG, LONR,LATR,2*NMAND)
      CALL POLAVG(QG, LONR,LATR,1 )
C***********************************************************************
C
C     PSFMSK CONVERTS SURFACE PRESSURE FROM NATURAL LOG IN CENTIBARS
C     TO STANDARD MILLIBARS, AND GENERATES MASK ARRAY CONTAINING
C     ONES ABOVE SURFACE AND ZEROES BELOW SURFACE.
C
C***********************************************************************
      CALL PSFMSK(MASK,PMAND,QG)
      IF(DOPF(1,ID))THEN
      CALL RWRITE(QG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(2,ID))THEN
      CALL RWRITE(MASK,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(3,ID))THEN
      CALL RWRITE(DG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(4,ID))THEN
      CALL RWRITE(XG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      RETURN
      END
      SUBROUTINE POSTG2(PMAND,ALNPMD,KFLO,DOPF,ID)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      DIMENSION CTLON(LONR),STLON(LONR)
      LOGICAL DOPF(16,2)
      SAVE CTLON,STLON
      DO 1700 K=1,LEVG
      CALL DZTOUV(DI(1,K),ZE(1,K),ULN(1,K),VLN(1,K),EPS)
 1700 CONTINUE
       CALL CONFIL(UG, LTLO * NMAND ,0.0)
       CALL CONFIL(VG, LTLO * NMAND ,0.0)
       CALL CONFIL(OG, LTLO * NMAND ,0.0)
      DO 2000 LAT = 1,LATGH
        DO 1800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
 1800   CONTINUE
      CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(DPDLAM,DLAMA,DLAMB,QLN,1)
      CALL SUMPLV(DPDPHI,DPHIA,DPHIB,QLN,1)
      CALL SUMPLV(ULN,USA,USB,QLN,LEVG)
      CALL SUMPLV(VLN,VSA,VSB,QLN,LEVG)
      CALL SUMPLS(DI,DIA,DIB,QLN,LEVG)
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(DPHIA,SCNMC,3+3*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 1830 I=1,LONG
      QA(I)=EXP(QA(I))
 1830 CONTINUE
C***********************************************************************
C
C     OMEGAS CALCULATES VERTICAL MOTIONS.
C
C***********************************************************************
      CALL OMEGAS(DPHIA,DLAMA,WORK,USA,VSA,DIA,DEL,RCL,OMGA,QA,SL)
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QA,SI,SL,PMAND,ALNPMD,DEL,3,USA,UPA,VSA,VPA,OMGA,OPA)
C***********************************************************************
C
C     PSEUDO-WIND FIELDS ARE CONVERTED TO WIND FIELDS PRIOR TO
C     AREAL INTERPOLATION STEP.
C
C***********************************************************************
      DO 1850 LEV=1,NMAND
      DO 1850 I=1, LONG
      UPA(I,LEV)=UPA(I,LEV)/COSLAT
      VPA(I,LEV)=VPA(I,LEV)/COSLAT
 1850 CONTINUE
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LAT,UPA,LONG,3*NMAND,LATG,UG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(DPHIB,SCNMC,3+3*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 1860 I=1,LONG
      QB(I)=EXP(QB(I))
 1860 CONTINUE
C***********************************************************************
C
C     OMEGAS CALCULATES VERTICAL MOTIONS.
C
C***********************************************************************
      CALL OMEGAS(DPHIB,DLAMB,WORK,USB,VSB,DIB,DEL,RCL,OMGB,QB,SL)
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QB,SI,SL,PMAND,ALNPMD,DEL,3,USB,UPB,VSB,VPB,OMGB,OPB)
C***********************************************************************
C
C     PSEUDO-WIND FIELDS ARE CONVERTED TO WIND FIELDS PRIOR TO
C     AREAL INTERPOLATION STEP.
C
C***********************************************************************
      DO 1900 LEV=1,NMAND
      DO 1900 I=1, LONG
      UPB(I,LEV)=UPB(I,LEV)/COSLAT
      VPB(I,LEV)=VPB(I,LEV)/COSLAT
 1900 CONTINUE
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LATCO,UPB,LONG,3*NMAND,LATG,UG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 2000 CONTINUE
C***********************************************************************
C
C     POLEUV FIXES POLAR VALUES OF WINDS, SURFACE STRESSES PRODUCED BY
C     AREAL INTERPOLATING ROUTINE TERPWT.
C
C***********************************************************************
      CALL POLEUV(UG,VG,LONR,LATR,NMAND,CTLON,STLON)
C***********************************************************************
C
C     POLAVG FIXES POLAR VALUES OF SCALAR FIELDS PRODUCED BY
C     AREAL INTERPOLATING ROUTINE TERPWT.
C
C***********************************************************************
      CALL POLAVG(OG, LONR,LATR,NMAND)
      IF(DOPF(5,ID))THEN
      CALL RWRITE(UG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(6,ID))THEN
      CALL RWRITE(VG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(7,ID))THEN
      CALL RWRITE(OG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      RETURN
      END
      SUBROUTINE POSTG3(PMAND,ALNPMD,KFLO,DOPF,ID)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOGICAL DOPF(16,2)
C***********************************************************************
C
C     STREAM FUNCTION, VELOCITY POTENTIAL ARE CALCULATED FROM
C     VORTICITY, DIVERGENCE IN SPECTRAL SPACE.
C
C***********************************************************************
      AA2 = -6370000.0 * 6370000.0
      DO 2700 K=1,LEVG
      VP(1,K) = 0.0
      VP(2,K) = 0.0
      SF(1,K) = 0.0
      SF(2,K) = 0.0
      DO 2650 IH = 3 , JKSCA
      VP(IH,K) = AA2 * DI(IH,K) / SNNP1(IH)
      SF(IH,K) = AA2 * ZE(IH,K) / SNNP1(IH)
 2650 CONTINUE
 2700 CONTINUE
C**********************************************************************
C
C     CONFIL FILLS OUTPUT ARRAYS WITH ZEROS SO THAT THE LATITUDE-BY-
C     LATITUDE CALLS TO ROUTINE TERPWT CAN ADDITIVELY BUILD THE
C     PRESSURE-INTERPOLATED FIELDS.
C
C**********************************************************************
       CALL CONFIL(SFG, LTLO * NMAND ,0.0)
       CALL CONFIL(VPG, LTLO * NMAND ,0.0)
      DO 3000 LAT = 1,LATGH
        DO 2800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
 2800   CONTINUE
      CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(SF,SFA,SFB,QLN,LEVG)
      CALL SUMPLS(VP,VXA,VXB,QLN,LEVG)
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(QA,SCNMC,1+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 2830 I=1,LONG
      QA(I)=EXP(QA(I))
 2830 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QA,SI,SL,PMAND,ALNPMD,DEL,2,SFA,SFPA,VXA,VXPA)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LAT,SFPA,LONG,2*NMAND,LATG,SFG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(QB,SCNMC,1+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 2860 I=1,LONG
      QB(I)=EXP(QB(I))
 2860 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QB,SI,SL,PMAND,ALNPMD,DEL,2,SFB,SFPB,VXB,VXPB)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LATCO,SFPB,LONG,2*NMAND,LATG,SFG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 3000 CONTINUE
      CALL POLAVG(SFG, LONR,LATR,2*NMAND)
      IF(DOPF(8,ID))THEN
      CALL RWRITE(SFG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(9,ID))THEN
      CALL RWRITE(VPG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      RETURN
      END
      SUBROUTINE POSTG4(PMAND,ALNPMD,KFLO,DOPF,ID)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOGICAL DOPF(16,2)
       CALL CONFIL(ZG, LTLO * NMAND ,0.0)
       CALL CONFIL(TVG, LTLO * NMAND ,0.0)
      DO 4000 LAT = 1,LATGH
        DO 3800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
 3800   CONTINUE
      CALL SUMPLS(GZ,HA,HB,QLN,1)
      CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(TE,TSA,TSB,QLN,LEVG)
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(HA,SCNMC,2+LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 3830 I=1,LONG
      QA(I)=EXP(QA(I))
 3830 CONTINUE
C***********************************************************************
C
C     SIG2PZ PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PZ(TSA,QA,HA,TVPA,ZPA,SI,SL,PMAND,ALNPMD,DEL)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LAT,TVPA,LONG,2*NMAND,LATG,TVG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(HB,SCNMC,2+LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 3860 I=1,LONG
      QB(I)=EXP(QB(I))
 3860 CONTINUE
C***********************************************************************
C
C     SIG2PZ PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PZ(TSB,QB,HB,TVPB,ZPB,SI,SL,PMAND,ALNPMD,DEL)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LATCO,TVPB,LONG,2*NMAND,LATG,TVG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 4000 CONTINUE
      CALL POLAVG(TVG, LONR,LATR,2*NMAND)
      IF(DOPF(10,ID))THEN
      CALL RWRITE(TVG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(11,ID))THEN
      CALL RWRITE(ZG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(12,ID))THEN
C***********************************************************************
C
C     GETSLP CALCULATES SEA LEVEL PRESSURE FROM EMPIRICAL NMC FORMULA
C     BASED UPON 1000 MB HEIGHT AND 1000 MB - 500 MB THICKNESS.
C
C***********************************************************************
      CALL GETSLP(SLPG,ZG,PMAND)
      CALL RWRITE(SLPG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      RETURN
      END
      SUBROUTINE POSTG5(PMAND,ALNPMD,KFLO,DOPF,ID)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOGICAL DOPF(16,2)
       CALL CONFIL(TG, LTLO * NMAND ,0.0)
       CALL CONFIL(RG, LTLO * NMAND ,0.0)
C**********************************************************************
C
C      INPUT IS LEVQ LEVEL SPECIFIC HUMIDITY  RQ
C      PUT IN LEVG LEVEL ARRAY SH
C
C**********************************************************************
      IF(LEVQ.LT.LEVG)THEN
      LEVQP=LEVQ+1
      LEVGMQ=LEVG-LEVQ
      CALL CONFIL(SH(1,LEVQP),JKSCA*LEVGMQ,0.0)
      END IF
      DO 4700 I=1,JKSCA
      DO 4700 J=1,LEVQ
      SH(I,J)=RQ(I,J)
 4700 CONTINUE
      DO 5000 LAT = 1,LATGH
        DO 4800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
 4800   CONTINUE
      CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(TE,TSA,TSB,QLN,LEVG)
      CALL SUMPLS(SH,SHA,SHB,QLN,LEVG)
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(QA,SCNMC,1+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 4830 I=1,LONG
      QA(I)=EXP(QA(I))
 4830 CONTINUE
C***********************************************************************
C
C     SIGTOP PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIGTOP(TMA,TSA,SHA,QA,TPA,RPA,SI,SL,PMAND,ALNPMD,DEL)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LAT,TPA,LONG,2*NMAND,LATG,TG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      CALL FFSNFS(QB,SCNMC,1+2*LEVG)
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 4860 I=1,LONG
      QB(I)=EXP(QB(I))
 4860 CONTINUE
C***********************************************************************
C
C     SIGTOP PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIGTOP(TMB,TSB,SHB,QB,TPB,RPB,SI,SL,PMAND,ALNPMD,DEL)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
      CALL GTRPLT(LATCO,TPB,LONG,2*NMAND,LATG,TG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 5000 CONTINUE
      CALL POLAVG(TG, LONR,LATR,2*NMAND)
      IF(DOPF(13,ID))THEN
      CALL RWRITE(TG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(14,ID))THEN
      CALL RWRITE(RG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      IF(DOPF(15,ID))THEN
C***********************************************************************
C
C     GETSH CALCULATES SPECIFIC HUMIDITY FROM RELATIVE HUMIDITY.
C
C***********************************************************************
      CALL GETSH(SG,RG,PMAND,TG)
      CALL RWRITE(SG,NVO(KFLO),KFLO)
      KFLO=KFLO+1
      END IF
      RETURN
      END
      SUBROUTINE PSFMSK(MASK,PMAND,QG)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION MASK(LONR,LATR,NMAND),QG(LONR,LATR),PMAND(NMAND)
      DO 10 J=1,LATR
      DO 10 I=1,LONR
      QG(I,J) = 10.0 * EXP(QG(I,J))
10    CONTINUE
      DO 20 K=1,NMAND
      DO 20 J=1,LATR
      DO 20 I=1,LONR
      MASK(I,J,K) = 1
      IF(QG(I,J) .LT. PMAND(K)) MASK(I,J,K) = 0
20    CONTINUE
      RETURN
      END
        SUBROUTINE RDFLD(NSFILE,BUFR,NHARM,LEV,BUF1)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
        DIMENSION BUFR(NHARM,LEV),BUF1(NHARM)
        CHARACTER*8 LAB84(6)
        DO 1 K=1,LEV
        READ(NSFILE) LAB84,BUF1
        DO 2 I=1,NHARM
        BUFR(I,K)=BUF1(I)
   2    CONTINUE
   1    CONTINUE
        IF(NHARM .EQ.JKSCA)CALL TRANSP(BUFR,LEV)
        RETURN
        END
      SUBROUTINE RECON (NFLD,NFLP,NFDV,NOF,NDRTAP,NPTABL,NDVTAB,INDATE,
     *TITLE,SPECAL,DEL,RCODE,DTIN,NEWTYP)
C     RECON IS USED TO RECONCILE THE DIFFERENCES BETWEEN THE
C     INPUT FILE DIRECTORY AND THE REQUESTED FIELD DIRECTORY AND
C     PRODUCE A FINAL OUTPUT DIRECTORY.  INPUT DATASETS ARE:
C     1.  INPUT FILE DIRECTORY ON DATASET NDRTAP
C         ORDER OF FIELDS IN DIRECTORY MUST CORRESPOND TO FIELDS
C         IN THE INPUT FILE
C     2.  REQUESTED FIELD DIRECTORY ON DATASET NPTABL
C         ORDER OF FIELDS IS INDEPENDENT
C     3.  DERIVED FIELD TABLE ON DATASET NDVTAB
C         ORDER OF FIELDS TO BE DERIVED MUST CORRESPOND TO THE
C         ORDER THEY ARE PROCESSED IN THE CODE.  ORDER OF FIELDS
C         REQUIRED FOR DERIVING A FIELD IS INDEPENDENT
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
C     INCLUDE (PRMCNV)
      PARAMETER (NUNITS=220,NUMX=NUNITS-1,NGRP=NUNITS/10,NCF=1000,
     *NCF2=500,NGRMX=NGRP-1)
      CHARACTER VUNITS(-1:NUMX)*32,AUNITS(-1:NUMX)*16,
     *PUNITS(-1:NUMX)*32
      INTEGER LOOKU(0:9,0:9,0:NGRMX)
      DIMENSION CNFAC(NCF),CNFAC2(NCF2)
      COMMON/CVTBL/CNFAC,CNFAC2,LOOKU
      COMMON/CVTBL/VUNITS,AUNITS,PUNITS
      LOGICAL NEWTYP
      CHARACTER*20 TYPE1,
     *             TYPE2
      CHARACTER TYPE*20,TITLE*40,SPECAL*40,DTIN*4,SDAIN*4,RCODE*4,
     *TRUNC*1
      DATA         TYPE1/'MODEL SIGMA OUTPUT  '/,
     *             TYPE2/'COLA SIGMA HISTORY  '/
      DIMENSION IDATE(4),INDATE(4),DEL(LEVG)
C     READ IN INPUT FILE DIRECTORY
      NFLD=0
      READ(NDRTAP,1220,END=4000) TYPE
 1220 FORMAT(A20)
      WRITE(3,1221)TYPE
 1221 FORMAT(' ',A20)
      IF(TYPE.EQ.TYPE1)THEN
      NEWTYP=.FALSE.
      ELSE IF(TYPE.EQ.TYPE2)THEN
      NEWTYP=.TRUE.
      ELSE
      WRITE(3,1223)
 1223 FORMAT(' INVALID TYPE')
      STOP 1223
      END IF
      READ(NDRTAP,1230,END=4000)RCODE,SDAIN,TRUNC,NWN,MEND1,LEVIN,
     *LEVQIN,IDATE,INDATE,DTIN
1230  FORMAT(A4,1X,A4,1X,A1,I3,1X,3I3,2(3I3,I5),1X,A4)
      WRITE(3,1227)RCODE,SDAIN,TRUNC,NWN,MEND1,LEVIN,
     *LEVQIN,IDATE,INDATE,DTIN
1227  FORMAT(' ',A4,1X,A4,1X,A1,I3,1X,3I3,2(3I3,I5),1X,A4)
      READ(NDRTAP,1231,END=4000)TITLE,SPECAL
1231  FORMAT(2A40)
      WRITE(3,1228)TITLE,SPECAL
1228  FORMAT(' ',2A40)
      READ(NDRTAP,1232,END=4000)(DEL(IN),IN=1,LEVIN)
1232  FORMAT(5E16.8)
      WRITE(3,1229)(DEL(IN),IN=1,LEVIN)
1229  FORMAT(' ',5E16.8)
25    NFLD = NFLD + 1
      IF(NFLD.GT.NDI)GO TO 3000
      READ(NDRTAP,1234,END=30) CHRDSC(NFLD),PRODIA(NFLD),
     A NHARM(NFLD),NLEVS(NFLD),IFLDCD(NFLD)
 1234 FORMAT(A40,2X,A4,2X,I5,2X,I3,2X,I5)
      MKDIR(NFLD)=0
      GO TO 25
30    NFLD=NFLD-1
C     READ IN REQUESTED FIELD DIRECTORY
      NFLP=0
35    NFLP = NFLP + 1
      IF(NFLP.GT.NDP)GO TO 3000
      READ(NPTABL,1334,END=40) CHRDO(NFLP),NUC(NFLP)
1334  FORMAT(A40,I5)
      MKO(NFLP)=0
      IFE(NFLP)=0
      GO TO 35
40    NFLP=NFLP-1
C     READ IN DERIVED FIELD TABLE
      NFDV=0
45    NFDV = NFDV + 1
      IF(NFDV.GT.NDV)GO TO 3000
      READ(NDVTAB,1434,END=50) CHRDV(NFDV),KDV(NFDV),NVV(NFDV)
1434  FORMAT(A40,2X,I3,2X,I3)
      MKDV(NFDV)=0
      LIF(NFDV)=0
      KK=KDV(NFDV)
      IF(KK.GT.MDF)GO TO 3000
      DO 47 JJ=1,KK
      READ(NDVTAB,1440)CHREQ(NFDV,JJ)
 1440 FORMAT(A40)
   47 CONTINUE
      GO TO 45
50    NFDV=NFDV-1
C     DETERMINE DIRECT AVAILABILITY OF REQUESTED FIELDS
      DO 100 MM=1,NFLD
C     SEE IF FIELD IS TO BE DEFERED
      DO 80 LL=1,NFDV
      IF(CHRDSC(MM).NE.CHRDV(LL))GO TO 80
C     MARK INPUT FIELD AS TO BE DEFERED
      MKDIR(MM)=100
C     MARK DERIVED FIELD AS PENDING DERIVATION FROM INPUT FIELD
      MKDV(LL)=2
      GO TO 100
   80 CONTINUE
      DO 90 NN=1,NFLP
      IF(CHRDSC(MM).NE.CHRDO(NN))GO TO 90
C     MARK REQUESTED FIELD AS BEING AVAILABLE DIRECTLY FROM INPUT FIELD
      MKO(NN)=1
C     MARK INPUT FIELD AS NEEDED DIRECTLY
      MKDIR(MM)=1
C     SAVE INPUT FIELD NUMBER
      IFE(NN)=MM
      GO TO 100
   90 CONTINUE
  100 CONTINUE
C     EXAMINE DERIVED FIELD TABLE
      DO 200 NN=1,NFLP
C     IGNORE DIRECTLY AVAILABLE FIELDS
      IF(MKO(NN).EQ.1)GO TO 200
      DO 180 LL=1,NFDV
C     IGNORE UNDESIRED DERIVABLE FIELDS
      IF(CHRDV(LL).NE.CHRDO(NN))GO TO 180
      KK=KDV(LL)
      DO 170 JJ=1,KK
      DO 160 MM=1,NFLD
C     VERIFY AVAILABILITY OF REQUIRED FIELDS FOR DERIVATION
      IF(CHRDSC(MM).NE.CHREQ(LL,JJ))GO TO 160
      IF(CHRDSC(MM).NE.CHRDV(LL))GO TO 170
C     SAVE INPUT FILE FIELD NUMBER
      IF(MKDV(LL).EQ.2)IFE(NN)=MM
      GO TO 170
  160 CONTINUE
      GO TO 200
  170 CONTINUE
C     MARK REQUESTED FIELD AS AVAILABLE BY DERIVATION
      MKO(NN)=2
C     MARK REQUESTED FIELD AS DEFERED IF LISTED IN INPUT FILE DIRECTORY
      IF(MKDV(LL).EQ.2)MKO(NN)=3
C     MARK DERIVED FIELD AS COMPUTABLE FROM INPUT FIELDS
      MKDV(LL)=1
      GO TO 200
  180 CONTINUE
  200 CONTINUE
C     REVIEW INPUT FILE DIRECTORY
      DO 300 LL=1,NFDV
C     IGNORE UNDERIVABLE OR UNDESIRED FIELDS IN DERIVED FIELD TABLE
      IF(MKDV(LL).NE.1)GO TO 300
      KK=KDV(LL)
      DO 280 MM=1,NFLD
      IF(CHRDV(LL).EQ.CHRDSC(MM))MKDIR(MM)=MKDIR(MM)+100
      DO 260 JJ=1,KK
      IF(CHREQ(LL,JJ).NE.CHRDSC(MM))GO TO 260
C    MARK INPUT FIELD AS NEEDED FOR COMPUTING ONE OR MORE DERIVED FIELDS
      IF(CHRDV(LL).NE.CHRDSC(MM))MKDIR(MM)=MKDIR(MM)+2
      MXDIR=MM
      GO TO 280
  260 CONTINUE
  280 CONTINUE
C     SAVE LAST REQUIRED FIELD INPUT FILE SEQUENCE NUMBER
      LIF(LL)=MXDIR
  300 CONTINUE
C     CREATE OUTPUT FILE DIRECTORY
      NOF=0
      LL=1
      DO 400 MM=1,NFLD
      IF(MKDIR(MM).LT.1)GO TO 400
      IF(MOD(MKDIR(MM),2).EQ.1)THEN
      NOF=NOF+1
C     ADD DIRECTLY REQUESTED FIELD TO OUTPUT DIRECTORY
      CHROP(NOF)=CHRDSC(MM)
      NVO(NOF)=NMAND
      IF(NLEVS(MM).EQ.1)NVO(NOF)=1
      END IF
      IF(LL.GT.NFDV)GO TO 400
  315 IF(MKDV(LL).NE.1)GO TO 325
      IF(MKDIR(MM).GT.1.AND.LIF(LL).LE.MM)THEN
      NOF=NOF+1
C     ADD REQUESTED DERIVED FIELD TO OUTPUT DIRECTORY AFTER LAST
C     REQUIRED INPUT FIELD HAS BEEN PROCESSED
      CHROP(NOF)=CHRDV(LL)
      IF(NVV(LL).EQ.1)NVO(NOF)=1
      IF(NVV(LL).EQ.2)NVO(NOF)=NMAND
      ELSE
      GO TO 400
      END IF
  325 LL=LL+1
      IF(LL.GT.NFDV)GO TO 400
      GO TO 315
  400 CONTINUE
      NS=1
      DO 500 II=1,NOF
      DO 450 NN=1,NFLP
      IF(CHROP(II).EQ.CHRDO(NN))THEN
      NUCO(II)=NUC(NN)
      NFE(II)=0
      IF(MKO(NN).NE.2)THEN
      IF(NUC(NN).EQ.-1)NUCO(II)=IFLDCD(IFE(NN))
      NFE(II)=IFE(NN)
      END IF
      GO TO 500
      END IF
  450 CONTINUE
  500 CONTINUE
C     READ IN UNIT LABELS AND CONVERSION TABLES
      READ(34,5020)VUNITS
 5020 FORMAT(A32)
      READ(35,5025)AUNITS
 5025 FORMAT(A16)
      READ(36,5020)PUNITS
      READ(37,5030)CNFAC
 5030 FORMAT(5E16.8)
      READ(38,5030)CNFAC2
      READ(39,5040)LOOKU
 5040 FORMAT(20I4)
C     PRINT INPUT FILE DIRECTORY ANOTATED BY FIELD REQUIREMENTS
      WRITE(3,1244)IDATE,INDATE
 1244 FORMAT('-',20X,'I N P U T  F I L E  D I R E C T O R Y',3X,
     *'IDATE=',3I3,I5,' INDATE=',3I3,I5/
     *' ',T20,'NUMBER',T42,'CHRDSC',T72,'PRODIA',T80,'LEN',
     *T86,'LEV',T92,'CODE',T98,'MKDIR')
      WRITE(3,1254)(MM,CHRDSC(MM),PRODIA(MM),
     A NHARM(MM),NLEVS(MM),IFLDCD(MM),MKDIR(MM),MM=1,NFLD)
1254  FORMAT(' ',T20,I3,T29,A40,4X,A4,2X,I5,I4,2X,I5,4X,I3)
C     PRINT REQUESTED FILE DIRECTORY ANOTATED BY FIELD AVAILABILITY
      WRITE(3,1344)
 1344 FORMAT('-',20X,'R E Q U E S T E D  F I E L D  D I R E C T O R Y'/
     *' ',20X,'NUMBER',T44,'CHRDO',T76,'NUC',T84,'MKO',T91,'IFE')
      WRITE(3,1354) (NN,CHRDO(NN),NUC(NN),MKO(NN),IFE(NN),NN=1,NFLP)
1354  FORMAT(' ',T23,I3,T31,A40,3X,I5,4X,I3,4X,I3)
C     PRINT DERIVED FIELD TABLE ANOTATED BY FIELD AVAILABILITY
      WRITE(3,1444)
 1444 FORMAT('-',20X,'D E R I V E D  F I E L D  T A B L E'/)
      DO 1460 LL=1,NFDV
      WRITE(3,1454) LL,CHRDV(LL),KDV(LL),NVV(LL),MKDV(LL),LIF(LL),
     *(CHREQ(LL,KK),KK=1,KDV(LL))
1454  FORMAT('0',T10,'NUMBER',I3,' CHRDV:  ',A40,' KDV',I3,' NVV',I3,
     *' MKDV',I3,' LIF',I3/' ',T10,'REQUIRED FIELDS:',(' ',T28,A40))
 1460 CONTINUE
C     PRINT OUTPUT FILE DIRECTORY
      WRITE(3,1544)
 1544 FORMAT('-',20X,'O U T P U T  F I L E  D I R E C T O R Y'/
     *' ',20X,'NUMBER',T42,'CHROP',T74,'NVO',T80,'NUCO',T87,'NFE')
      WRITE(3,1554)(II,CHROP(II),NVO(II),NUCO(II),NFE(II),II=1,NOF)
 1554 FORMAT(' ',20X,I3,5X,A40,3X,I3,2X,I5,4X,I3)
      RETURN
 3000 WRITE(3,3100)NFLD,NFLP,NFDV,KK
 3100 FORMAT(' DIRECTORY TABLE OVERFLOW.  NFLD=',I5,' NFLP=',I5,' NFDV='
     *,I5,' KK=',I3)
      STOP 3100
 4000 WRITE(3,4100)
 4100 FORMAT(' UNEXPECTED END OF FILE IN INPUT FILE DIRECTORY.')
      STOP 4100
      END
      SUBROUTINE RWRITE (BFR,LEV,KFLO)
C     WRITE REGULAR GRID TO OUTPUT FILE
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (BOOMDA)
      CHARACTER*4 SEQDA
      COMMON/BOOMDA/IREC,NBF,NPFILE,IPS
      COMMON/BOOMDC/SEQDA
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION BFR(LONR,LATR,LEV),BBFR(LONR,LATR),DABFR(LRCLW)
      DATA PAD/X'5555555555555555'/
      DO 50 L=1,LEV
      IF(NFE(KFLO).EQ.0)GO TO 11
      IF(IFLDCD(NFE(KFLO)).EQ.NUCO(KFLO))GO TO 11
      CALL CNVOUT(BFR(1,1,L),BBFR,LTLO,IFLDCD(NFE(KFLO)),
     *NUCO(KFLO),IER)
      IF(IER.GT.0)WRITE(3,10)KFLO,IER,NFE(KFLO),IFLDCD(NFE(KFLO)),
     *NUCO(KFLO)
   10 FORMAT(' CONVERSION ERROR AT KFLO=',I4,' ERROR=',I3,' NFE=',I4,
     *' IFLDCD=',I4,' NUCO=',I4)
      GO TO 14
   11 DO 13 J=1,LATR
      DO 12 I=1,LONR
      BBFR(I,J)=BFR(I,J,L)
   12 CONTINUE
   13 CONTINUE
   14 IF(SEQDA.EQ.'SEQU')THEN
      CALL WRO(BBFR,LTLO)
      END IF
      IF(SEQDA.EQ.'DIRA')THEN
C    DIRECT ACCESS RECORDS ARE LRCLW WORDS LONG.  NBF RECORDS ARE
C    NEEDED TO SPAN BFR WHICH IS LTLO LONG.  EXTRA SPACE IS PADDED
      I=1
      J=1
      DO 20 KK=1,NBF-1
      DO 15 JJ=1,LRCLW
      DABFR(JJ)=BBFR(I,J)
      I=I+1
      IF(I.GT.LONR)THEN
      I=1
      J=J+1
      END IF
   15 CONTINUE
      CALL WRO(DABFR,LRCLW)
   20 CONTINUE
      DO 30 JJ=1,IPS-1
      DABFR(JJ)=BBFR(I,J)
      I=I+1
      IF(I.GT.LONR)THEN
      I=1
      J=J+1
      END IF
   30 CONTINUE
      DO 40 JJ=IPS,LRCLW
      DABFR(JJ)=PAD
   40 CONTINUE
      CALL WRO(DABFR,LRCLW)
      END IF
   50 CONTINUE
      RETURN
      END
      SUBROUTINE SCASE(GAUSIN,KFLD,KFLO,LEV)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION GAUSIN(LONG,LATG,LEV)
      DO 300 L=1,LEV
      DO 200 J=1,LATG
      DO 100 I=1,LONG
      GAUSIN(I,J,L)=ABS(GAUSIN(I,J,L))
  100 CONTINUE
  200 CONTINUE
  300 CONTINUE
      RETURN
      END
      SUBROUTINE SETDA
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (BOOMDA)
      CHARACTER*4 SEQDA
      COMMON/BOOMDA/IREC,NBF,NPFILE,IPS
      COMMON/BOOMDC/SEQDA
      CHARACTER FID*18,ERS*27
      OPEN (UNIT=NPFILE,FORM='UNFORMATTED',ACCESS='DIRECT',
     * IOSTAT=IER,RECL=LRCLB,STATUS='NEW')
      IF(IER.NE.0)GO TO 25
C***** LINES BETWEEN STARRED COMMENT CARDS ADDED TO CORRECT SYSTEM BUG
C     CALL GETFID(NPFILE,1,FID,IER1)
C     IF(IER1.NE.0)GO TO 50
C     ERS(1:6)='ERASE '
C     ERS(7:14)=FID(1:8)
C     ERS(15:15)=' '
C     ERS(16:23)=FID(9:16)
C     ERS(24:24)=' '
C     ERS(25:26)=FID(17:18)
C     ERS(27:27)='$'
C     CALL OPSYS('$',ERS,IER2)
C     IF(IER2.NE.0)GO TO 100
C***** END OF SYSTEM BUG CORRECTION
      IREC=1
      NBF=LTLO/LRCLW+1
      IPS=LTLO-(NBF-1)*LRCLW+1
      RETURN
   25 LRECL=LRCLB
      WRITE(3,33)NPFILE,LRECL,IER
   33 FORMAT(' ERROR OPENING ON UNIT',I3,' LRECL=',I5,' ERROR=',I5)
      STOP 33
   50 WRITE(3,63)NPFILE,IER1
   63 FORMAT(' ERROR OBTAINING FILE ID FROM UNIT',I3,' ERROR=',I5)
      STOP 63
  100 WRITE(3,103)FID,IER2
  103 FORMAT(' ERROR ERASING FILE ID ',A18,' ERROR=',I5)
      STOP 103
      END
      SUBROUTINE SETLAT(BEGLAT,LATS,RADLAT)
C     IMPLICIT REAL*8 (A-H,O-Z)
C      REAL*4        RADLAT,BEGLAT
      DIMENSION RADLAT(LATS)
      DRAD = -2.0E+00 * BEGLAT / FLOAT(LATS - 1)
      RAD = BEGLAT
      DO 1000 K=1,LATS
      RADLAT(K)=RAD
      RAD=RAD+DRAD
1000  CONTINUE
      RETURN
      END
      SUBROUTINE SETLON(BEGLON,LONS,RADLON)
C     IMPLICIT REAL*8 (A-H,O-Z)
C      REAL*4        RADLON,BEGLON
      DIMENSION RADLON(LONS)
      PI = 4.0E+00 * ATAN(1.0D+00)
      DRAD = 2.0E+00 * PI / FLOAT(LONS)
      RAD = BEGLON
      DO 1000 K=1,LONS
      RADLON(K)=RAD
      RAD=RAD+DRAD
1000  CONTINUE
      RETURN
      END
      SUBROUTINE SETSIG(CI, SI, DEL, SL, CL, RPI)
      IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION CI(LEVGP), SI(LEVGP),
     1 DEL(LEVG), SL(LEVG), CL(LEVG), RPI(LEVGM)
      DIMENSION DELSIG(LEVG)
      SAVE DELSIG
C
C     DATA DELSIG/ 5*0.1667, .1665/
c     DATA DELSIG/ .01,.017,0.025,0.055,0.073,0.085,0.093,
c    * 0.096,0.096,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05,0.05/
c     DATA DELSIG/   .027,  .080,  .158,
c    1               .189,  .146,  .10,
c    2               .10,  .10,  .10/
      DATA DELSIG/   10*0.1/
c     DATA DELSIG/   .12,.11,.11,.11,.11,.11,.11,.11,.11/
C
      WRITE(3,98)
98    FORMAT (1H0, 'BEGIN SETSIG')
c     IF(DEL(1).EQ.0.0)THEN
      DO 9889 K=1,LEVG
      write(6,*)K,'DELSIG=',DELSIG(K)
9889  DEL(K)=DELSIG(K)
c     END IF
      CI(1) = 0.
      SUMDEL=0.
      DO 54 K=1,LEVG
      SUMDEL=SUMDEL+DEL(K)
      CI(K+1)=CI(K)+DEL(K)
54    CONTINUE
      CI(LEVGP)=1.
      RK =  287.05    /  1005.
      RK1 = RK + 1.
      LEVS= LEVG
      DO 1 LI=1, LEVGP
1     SI(LI) = 1. - CI(LI)
      DO 3 LE=1,LEVG
        if(LE.eq.LEVG) then
      DIF = SI(LE)**RK1 - 0.
        else
      DIF = SI(LE)**RK1 - SI(LE+1)**RK1
        end if
      DIF = DIF / (RK1*(SI(LE)-SI(LE+1)))
      SL(LE) = DIF**(1.0/RK)
      write(6,*) LE,'SL=',SL(LE)
      CL(LE) = 1.0 - SL(LE)
3     CONTINUE
C     COMPUTE PI RATIOS FOR TEMP. MATRIX.
      DO 4 LE=1, LEVGM
4     RPI(LE) = (SL(LE+1)/SL(LE))**RK
      DO 5 LE=1, LEVGP
      WRITE(3, 100) LE, CI(LE), SI(LE)
100   FORMAT (1H , 'LEVEL=', I2, 2X, 'CI=', F6.3, 2X, 'SI=', F6.3)
5     CONTINUE
      WRITE(3,97)
97    FORMAT (1H0)
      DO 6 LE=1, LEVG
      WRITE(3, 101) LE, CL(LE), SL(LE), DEL(LE)
101   FORMAT (1H , 'LAYER=', I2, 2X, 'CL=', F6.3, 2X, 'SL=', F6.3, 2X,
     1 'DEL=', F6.3)
6     CONTINUE
      WRITE(3, 102) (RPI(LE), LE=1,LEVGM)
102   FORMAT (1H0, 'RPI=', (18(1X,F6.3)) )
      WRITE(3, 99)LEVS,SUMDEL
99    FORMAT (1H0,'SHALOM FROM MRF',I3,' LEVEL GDAS SUMDEL=',E13.4)
      RETURN
      END
      SUBROUTINE SIGTOP(TM,TS,SS,PS,
     *TP,RH,SI,SL,PMAND,ALNPMD,DEL)
C
C$$$   SUBPROGRAM  DOCUMENTATION  BLOCK
C
C SUBPROGRAM: SIGTOP         SIGMA TO PRESSURE CALCULATION
C   AUTHOR: J. SELA          ORG: W/NMC42    DATE: 18 NOV 83
C
C ABSTRACT: INTERPOLATES VALUES ON THE GAUSSIAN GRID FROM THE
C   SIGMA COORDINATE SYSTEM TO THE MANDATORY PRESSURE LEVELS.
C   ASSUMES THAT RELATIVE HUMIDITY, TEMPERATURE, HORIZONTAL
C   WIND COMPONENTS AND VERTICAL VELOCITY VARY IN THE VERTICAL
C   WITH THE LOG OF PRESSURE. OBTAINS HEIGHT AT PRESSURE LEVELS
C   BY INTEGRATING THE HYDROSTATIC EQUATION.
C
C
C USAGE:  CALL SIGTOP(TM,TS,RS,PS,TP,RH,SI,SL,PMAND,
C                     ALNPMD,DEL)
C
C
C.....*..1...*....*2.........3.........4.........5......*..6*........7*.
C
C - - - - - - - - - I N P U T   V A R I A B L E S  - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     TS          REAL ARRAY OF ABSOLUTE TVIRT (K)          ARG LIST
C                 IN SIGMA LAYERS.
C     SS          REAL ARRAY OF SPECIFIC HUMIDITY           ARG LIST
C                 (DIMENSIONLESS) IN SIGMA LAYERS.
C                 CONVERTED TO RELATIVE HUMIDITY
C                 BY CALL TO SUBR GETRH.
C     PS          REAL ARRAY OF SURFACE PRESSURE            ARG LIST
C                 (CENTIBARS)
C     SI          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT INTERFACE OF
C                 MODEL LAYERS.
C     SL          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT THE MIDPOINT OF
C                 MODEL LAYERS.
C     PMAND       REAL ARRAY OF MANDATORY PRESSURE          ARG LIST
C                 LEVELS (MB)
C     ALNPMD      REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 OF LOG(PMAND).
C     DEL         REAL ARRAY OF DELTA SIGMA                 ARG LIST
C                 (DIMENSIONLESS) ACROSS A MODEL LAYER.
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C - - - - - - - - - O U T P U T   V A R I A B L E S - - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     TM          REAL ARRAY OF ABSOLUTE TEMP (K)
C                 IN SIGMA LAYERS
C     TP          REAL ARRAY OF ABSOLUTE TEMP (K) ON        ARG LIST
C                 MANDATORY PRESSURE LEVELS.
C     RH          REAL ARRAY OF RELATIVE HUMIDITY           ARG LIST
C                 (DIMENSIONLESS) ON THE MANDATORY
C                 LEVELS FROM 1000 TO 300 MB INCLUSIVE.
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C - - - - - - - - - S U B P R O G R A M S   C A L L E D - - - - - - - -
C
C     NAME(S)                                               LIBRARY
C     -------                                               -------
C     (COL 7-57)                                            (COL 61-71)
C     GETRH                                                 UNIQUE
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C ATTRIBUTES:
C   LANGUAGE: CDC FORTRAN
C   SOURCE STATEMENTS: 119
C
C$$$
      IMPLICIT  REAL (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION DEL( LEVG )
      DIMENSION PMAND(NMAND),ALNPMD(NMAND),
     1   PIM(LONG,LEVG),ALNPM(LONG,LEVG),ALNP(LONG,LEVGP),
     2   PI(LONG,LEVGP),P(LONG,LEVGP),
     4   SI(LEVGP),SL(LEVG)
      DIMENSION
     1   TM(LONG, LEVG),
     2   TS(LONG,LEVG),SS(LONG,LEVG),
     3   PS(LONG),TOP(LONG)
      DIMENSION
     2   TP(LONG,NMAND),RH(LONG,NMAND)
      DIMENSION RDELP(LONG,LEVGM),BRH(LONG,LEVGM),
     1   BT(LONG,LEVGM)
      DIMENSION WRK(LONG,LEVGP)
C***  COMPUTE ABSOLUTE TEMPERATURE T=TV/(1+.61Q)
      DO 131 LON=1,LONG
      DO 131 LEV=1,LEVG
      TM(LON,LEV)=TS(LON,LEV)/(1.0+.61*SS(LON,LEV))
 131  CONTINUE
            CALL GETRH(SS,PS,SL,TM)
C***  CONVERT PS TO MB
      DO 100 LON = 1,LONG
      PS(LON) = 10.0 * PS(LON)
  100 CONTINUE
      G=9.8
      R=287.05
      CP=1005.0
      ROCP=R/CP
      CPOG=CP/G
      ROG=R/G
      CPOR=CP/R
      WTL=ALOG(1000.0)
C   COMPUTE PRESSURE ON EACH SIGMA SURFACE EXCEPT THE HIGHEST.
      DO 500 K=1,LEVG
      DO 500 LON=1,LONG
      P(LON,K)=SI(K)*PS(LON)
  500 CONTINUE
C   SET THE TOP OF THE MODEL AT 1.0 MB.
      CALL CONFIL(P(1,LEVGP),LONG,1.0)
      DO 510 K=1,LEVGP
      DO 510 LON=1,LONG
C   COMPUTE THE LOG OF PRESSURE ON EACH SIGMA SURFACE.
      ALNP(LON,K)=ALOG(P(LON,K))
C   COMPUTE EXNER FUNCTION ON EACH SIGMA SURFACE.
      WRK(LON,K)=ROCP*(ALNP(LON,K)-WTL)
      PI(LON,K)=EXP(WRK(LON,K))
  510 CONTINUE
      DO 520 K=1,LEVG
      DO 520 LON=1,LONG
C   COMPUTE THE MEAN VALUE OF THE EXNER FUNCTION IN EACH LAYER.
      PIM(LON,K)=(PI(LON,K+1)-PI(LON,K)) /
     1   (ROCP*(ALNP(LON,K+1)-ALNP(LON,K)))
C   COMPUTE THE LOG OF PIM.
      WRK(LON,K)=ALOG(PIM(LON,K))
C   COMPUTE THE LOG OF THE MEAN VALUE OF PRESSURE IN EACH LAYER.
      ALNPM(LON,K)=WTL+CPOR*WRK(LON,K)
  520 CONTINUE
      DO 800 K=1,LEVGM
      DO 800 LON=1,LONG
      RDELP(LON,K)=1.0 /(ALNPM(LON,K+1)-ALNPM(LON,K))
C  RETRUN INTERPOLATED T ABSOLUTE. TS REPLACED BY TM
      BT(LON,K)=(TM(LON,K+1)-TM(LON,K))*RDELP(LON,K)
  800 CONTINUE
      IF(LEVQ.LT.LEVG)THEN
      LEVGMQ=LEVG-LEVQ
      LEVQS=LEVQ
      CALL CONFIL(BRH(1,LEVQS),LONG*LEVGMQ,0.0)
      END IF
      LEVQM=LEVQ-1
      DO 850 K=1,LEVQM
      DO 850 LON=1,LONG
      BRH(LON,K)=(SS(LON,K+1)-SS(LON,K))*RDELP(LON,K)
  850 CONTINUE
      DO 1100 I=1,LONG
C     HEIGHTS TO PRESSURE SURFACES  -  HYDROSTATIC INTERPOLATION
C     WINDS AND TEMPS BY LINEAR INTERPOLATION WITH LN(P)
      KB=1
      KF=1
         DO 1090 KP=1,NMAND
C     SEARCH FOR MIDDLE OF SIGMA LAYER ABOVE KP
         DO 1030 K=KB,LEVG
      KS = K
      IF(ALNPMD(KP).GT.ALNPM(I,K))  GO TO 1040
 1030 CONTINUE
C     IF FALL THRU MUST EXTRAPOLATE UP
         KS = LEVG
C     FIND VALUES AND SLOPES FOR UPWARD OR DOWNWARD EXTRAPOLATION
C     AS WELL AS FOR INTERPOLATION AWAY FROM TROPOPAUSE
 1040 CONTINUE
      KB=KS
      IF ( KS.NE.1 )GO TO 1084
      RH(I,KP)=SS(I,1)
C  TS TO TM FOR ABSOLUTE T
C     TP(I,KP)=TM(I,1)+BT(I,1)*(ALNPMD(KP)-ALNPM(I,1))
      TP(I,KP)=TM(I,1)
      GO TO 1088
1084  CONTINUE
      IF(PMAND(KP).LT.PRHCUT)THEN
      RH(I,KP)=0.
      GO TO 1085
      END IF
      IF(KS.LE. LEVQ )GO TO 1083
      RH(I,KP)=SS(I, LEVQ )
      GO TO 1085
 1083 CONTINUE
      RH(I,KP)=SS(I,KS)+BRH(I,KS-1)*(ALNPMD(KP)-ALNPM(I,KS))
 1085 CONTINUE
      DDP=ALNPMD(KP)-ALNPM(I,KS)
C    TS TO TM FOR T ABSOLUTE
      TP(I,KP)=TM(I,KS)+BT(I,KS-1)*DDP
 1088 CONTINUE
C       START WITH ANOTHER SEARCH THRU THE SIGMA LEVELS
C      TO FIND THE LEVEL (KS)  ABOVE THE DESIRES MANDATORY LEVEL (KP)
      DO 1310 K=KF,LEVGP
        KS = K
        IF(ALNPMD(KP).GT.ALNP(I,K))  GO TO 1320
 1310 CONTINUE
 1320 CONTINUE
      KF=KS
 1090 CONTINUE
 1100    CONTINUE
      RETURN
      END
      SUBROUTINE SIG2PO(PS,SI,SL,PMAND,ALNPMD,DEL,NB,
     *BFI1,BFO1,BFI2,BFO2,BFI3,BFO3)
C
C$$$   SUBPROGRAM  DOCUMENTATION  BLOCK
C
C SUBPROGRAM: SIGTOP         SIGMA TO PRESSURE CALCULATION
C   AUTHOR: J. SELA          ORG: W/NMC42    DATE: 18 NOV 83
C
C ABSTRACT: INTERPOLATES VALUES ON THE GAUSSIAN GRID FROM THE
C   SIGMA COORDINATE SYSTEM TO THE MANDATORY PRESSURE LEVELS.
C   ASSUMES THAT RELATIVE HUMIDITY, TEMPERATURE, HORIZONTAL
C   WIND COMPONENTS AND VERTICAL VELOCITY VARY IN THE VERTICAL
C   WITH THE LOG OF PRESSURE. OBTAINS HEIGHT AT PRESSURE LEVELS
C   BY INTEGRATING THE HYDROSTATIC EQUATION.
C
C
C USAGE:  CALL SIG2PO(PS,SI,SL,PMAND,ALNPMD,DEL,NB,
C                     BFI1,BFO1,BFI2,BFO2,BFI3,BFO3)
C
C
C.....*..1...*....*2.........3.........4.........5......*..6*........7*.
C
C - - - - - - - - - I N P U T   V A R I A B L E S  - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     PS          REAL ARRAY OF SURFACE PRESSURE            ARG LIST
C                 (CENTIBARS)
C     SI          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT INTERFACE OF
C                 MODEL LAYERS.
C     SL          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT THE MIDPOINT OF
C                 MODEL LAYERS.
C     PMAND       REAL ARRAY OF MANDATORY PRESSURE          ARG LIST
C                 LEVELS (MB)
C     ALNPMD      REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 OF LOG(PMAND).
C     DEL         REAL ARRAY OF DELTA SIGMA                 ARG LIST
C                 (DIMENSIONLESS) ACROSS A MODEL LAYER.
C     NB          NUMBER OF BUFFERS TO PROCESS              ARG LIST
C     BFI1        1ST INPUT BUFFER ON SIGMA LEVELS          ARG LIST
C     BFI2        2ND INPUT BUFFER ON SIGMA LEVELS          ARG LIST
C     BFI3        3RD INPUT BUFFER ON SIGMA LEVELS          ARG LIST
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C - - - - - - - - - O U T P U T   V A R I A B L E S - - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     BFO1        1ST OUTPUT BUFFER ON PRESSURE LEVELS      ARG LIST
C     BFO2        2ND OUTPUT BUFFER ON PRESSURE LEVELS      ARG LIST
C     BFO3        3RD OUTPUT BUFFER ON PRESSURE LEVELS      ARG LIST
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C
C ATTRIBUTES:
C   LANGUAGE: CDC FORTRAN
C   SOURCE STATEMENTS: 119
C
C$$$
      IMPLICIT  REAL (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION DEL( LEVG )
      DIMENSION PMAND(NMAND),ALNPMD(NMAND),
     1   PIM(LONG,LEVG),ALNPM(LONG,LEVG),ALNP(LONG,LEVGP),
     2   PI(LONG,LEVGP),P(LONG,LEVGP),SI(LEVGP),SL(LEVG)
      DIMENSION
     1   BFI1(LONG, LEVG),BFI2(LONG,LEVG),BFI3(LONG,LEVG),PS(LONG)
      DIMENSION
     1   BFO1(LONG,NMAND),BFO2(LONG,NMAND),BFO3(LONG,NMAND)
      DIMENSION RDELP(LONG,LEVGM),B1(LONG,LEVGM),B2(LONG,LEVGM),
     1B3(LONG,LEVGM)
      DIMENSION WRK(LONG,LEVGP)
C***  CONVERT PS TO MB
      DO 100 LON = 1,LONG
      PS(LON) = 10.0 * PS(LON)
  100 CONTINUE
      G=9.8
      R=287.05
      CP=1005.0
      ROCP=R/CP
      CPOG=CP/G
      ROG=R/G
      CPOR=CP/R
      WTL=ALOG(1000.0)
C   COMPUTE PRESSURE ON EACH SIGMA SURFACE EXCEPT THE HIGHEST.
      DO 500 K=1,LEVG
      DO 500 LON=1,LONG
      P(LON,K)=SI(K)*PS(LON)
  500 CONTINUE
C   SET THE TOP OF THE MODEL AT 1.0 MB.
      CALL CONFIL(P(1,LEVGP),LONG,1.0)
      DO 510 K=1,LEVGP
      DO 510 LON=1,LONG
C   COMPUTE THE LOG OF PRESSURE ON EACH SIGMA SURFACE.
      ALNP(LON,K)=ALOG(P(LON,K))
C   COMPUTE EXNER FUNCTION ON EACH SIGMA SURFACE.
      WRK(LON,K)=ROCP*(ALNP(LON,K)-WTL)
      PI(LON,K)=EXP(WRK(LON,K))
  510 CONTINUE
      DO 520 K=1,LEVG
      DO 520 LON=1,LONG
C   COMPUTE THE MEAN VALUE OF THE EXNER FUNCTION IN EACH LAYER.
      PIM(LON,K)=(PI(LON,K+1)-PI(LON,K)) /
     1   (ROCP*(ALNP(LON,K+1)-ALNP(LON,K)))
C   COMPUTE THE LOG OF PIM.
      WRK(LON,K)=ALOG(PIM(LON,K))
C   COMPUTE THE LOG OF THE MEAN VALUE OF PRESSURE IN EACH LAYER.
      ALNPM(LON,K)=WTL+CPOR*WRK(LON,K)
  520 CONTINUE
      DO 800 K=1,LEVGM
      DO 800 LON=1,LONG
      RDELP(LON,K)=1.0 /(ALNPM(LON,K+1)-ALNPM(LON,K))
C  RETRUN INTERPOLATED T ABSOLUTE. TS REPLACED BY TM
      B1(LON,K)=(BFI1(LON,K+1)-BFI1(LON,K))*RDELP(LON,K)
      IF(NB.LT.2)GO TO 800
      B2(LON,K)=(BFI2(LON,K+1)-BFI2(LON,K))*RDELP(LON,K)
      IF(NB.LT.3)GO TO 800
      B3(LON,K)=(BFI3(LON,K+1)-BFI3(LON,K))*RDELP(LON,K)
  800 CONTINUE
      DO 1100 I=1,LONG
C     HEIGHTS TO PRESSURE SURFACES  -  HYDROSTATIC INTERPOLATION
C     WINDS AND TEMPS BY LINEAR INTERPOLATION WITH LN(P)
      KB=1
      KF=1
         DO 1090 KP=1,NMAND
C     SEARCH FOR MIDDLE OF SIGMA LAYER ABOVE KP
         DO 1030 K=KB,LEVG
      KS = K
      IF(ALNPMD(KP).GT.ALNPM(I,K))  GO TO 1040
 1030 CONTINUE
C     IF FALL THRU MUST EXTRAPOLATE UP
         KS = LEVG
C     FIND VALUES AND SLOPES FOR UPWARD OR DOWNWARD EXTRAPOLATION
C     AS WELL AS FOR INTERPOLATION AWAY FROM TROPOPAUSE
 1040 CONTINUE
      KB=KS
      IF ( KS.NE.1 )GO TO 1084
      BFO1(I,KP)=BFI1(I,1)
      IF(NB.GT.1)BFO2(I,KP)=BFI2(I,1)
      IF(NB.GT.2)BFO3(I,KP)=BFI3(I,1)
      GO TO 1088
1084  CONTINUE
      DDP=ALNPMD(KP)-ALNPM(I,KS)
      BFO1(I,KP)=BFI1(I,KS)+B1(I,KS-1)*DDP
      IF(NB.GT.1)BFO2(I,KP)=BFI2(I,KS)+B2(I,KS-1)*DDP
      IF(NB.GT.2)BFO3(I,KP)=BFI3(I,KS)+B3(I,KS-1)*DDP
 1088 CONTINUE
C       START WITH ANOTHER SEARCH THRU THE SIGMA LEVELS
C      TO FIND THE LEVEL (KS)  ABOVE THE DESIRED MANDATORY LEVEL (KP)
      DO 1310 K=KF,LEVGP
        KS = K
        IF(ALNPMD(KP).GT.ALNP(I,K))  GO TO 1320
 1310 CONTINUE
 1320 CONTINUE
      KF=KS
 1090 CONTINUE
 1100    CONTINUE
      RETURN
      END
      SUBROUTINE SIG2PZ(TS,PS,TOP,TVP,ZP,SI,SL,PMAND,ALNPMD,DEL)
C
C$$$   SUBPROGRAM  DOCUMENTATION  BLOCK
C
C SUBPROGRAM: SIGTOP         SIGMA TO PRESSURE CALCULATION
C   AUTHOR: J. SELA          ORG: W/NMC42    DATE: 18 NOV 83
C
C ABSTRACT: INTERPOLATES VALUES ON THE GAUSSIAN GRID FROM THE
C   SIGMA COORDINATE SYSTEM TO THE MANDATORY PRESSURE LEVELS.
C   ASSUMES THAT RELATIVE HUMIDITY, TEMPERATURE, HORIZONTAL
C   WIND COMPONENTS AND VERTICAL VELOCITY VARY IN THE VERTICAL
C   WITH THE LOG OF PRESSURE. OBTAINS HEIGHT AT PRESSURE LEVELS
C   BY INTEGRATING THE HYDROSTATIC EQUATION.
C
C
C USAGE:  CALL SIGTOP(TS,PS,TOP,TVP,ZP,SI,SL,PMAND,
C                     ALNPMD,DEL)
C
C
C.....*..1...*....*2.........3.........4.........5......*..6*........7*.
C
C - - - - - - - - - I N P U T   V A R I A B L E S  - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     TS          REAL ARRAY OF ABSOLUTE TVIRT (K)          ARG LIST
C                 IN SIGMA LAYERS.
C     PS          REAL ARRAY OF SURFACE PRESSURE            ARG LIST
C                 (CENTIBARS)
C     TOP         REAL ARRAY OF TERRAIN HEIGHT (M)          ARG LIST
C     SI          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT INTERFACE OF
C                 MODEL LAYERS.
C     SL          REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 USED TO DEFINE P AT THE MIDPOINT OF
C                 MODEL LAYERS.
C     PMAND       REAL ARRAY OF MANDATORY PRESSURE          ARG LIST
C                 LEVELS (MB)
C     ALNPMD      REAL ARRAY OF DIMENSIONLESS VALUES        ARG LIST
C                 OF LOG(PMAND).
C     DEL         REAL ARRAY OF DELTA SIGMA                 ARG LIST
C                 (DIMENSIONLESS) ACROSS A MODEL LAYER.
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C - - - - - - - - - O U T P U T   V A R I A B L E S - - - - - - - - - -
C
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     (COL 7-15)           (COL 19-57)                      (COL 61-71)
C
C     TVP         REAL ARRAY OF VIRTUAL TEMPERATURE ON      ARG LIST
C                 MANDATORY PRESSURE LEVELS. (K)
C
C
C     ZP          REAL ARRAY OF GEOPOTENTIAL HEIGHT ON      ARG LIST
C                 MANDATORY PRESSURE LEVELS. (M)
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C
C
C ATTRIBUTES:
C   LANGUAGE: CDC FORTRAN
C   SOURCE STATEMENTS: 119
C
C$$$
      IMPLICIT  REAL (A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION GAMMA(LONG),TMSL(LONG),TSTR(LONG),ZLAY(LONG)
      DIMENSION DEL( LEVG )
      DIMENSION PMAND(NMAND),ALNPMD(NMAND),
     1   PIM(LONG,LEVG),ALNPM(LONG,LEVG),ALNP(LONG,LEVGP),
     2   PI(LONG,LEVGP),P(LONG,LEVGP),Z(LONG,LEVGP),
     3   SI(LEVGP),SL(LEVG)
      DIMENSION
     1   TS(LONG,LEVG),PS(LONG),TOP(LONG),ZP(LONG,NMAND),TVP(LONG,NMAND)
      DIMENSION DH(LONG,LEVG),BZ(LONG,LEVG),ZT(LONG,LEVG)
      DIMENSION RDELP(LONG,LEVGM),BALNP(LONG,LEVG),BTV(LONG,LEVGM)
      DIMENSION WRK(LONG,LEVGP),TLEV(LONG,LEVGP)
C***  CONVERT PS TO MB
      DO 100 LON = 1,LONG
      PS(LON) = 10.0 * PS(LON)
  100 CONTINUE
      G=9.8
      R=287.05
      CP=1005.0
      ROCP=R/CP
      CPOG=CP/G
      ROG=R/G
      CPOR=CP/R
      WTL=ALOG(1000.0)
C   COMPUTE PRESSURE ON EACH SIGMA SURFACE EXCEPT THE HIGHEST.
      DO 500 K=1,LEVG
      DO 500 LON=1,LONG
      P(LON,K)=SI(K)*PS(LON)
  500 CONTINUE
C   SET THE TOP OF THE MODEL AT 1.0 MB.
      CALL CONFIL(P(1,LEVGP),LONG,1.0)
      DO 510 K=1,LEVGP
      DO 510 LON=1,LONG
C   COMPUTE THE LOG OF PRESSURE ON EACH SIGMA SURFACE.
      ALNP(LON,K)=ALOG(P(LON,K))
C   COMPUTE EXNER FUNCTION ON EACH SIGMA SURFACE.
      WRK(LON,K)=ROCP*(ALNP(LON,K)-WTL)
      PI(LON,K)=EXP(WRK(LON,K))
  510 CONTINUE
      DO 520 K=1,LEVG
      DO 520 LON=1,LONG
C   COMPUTE THE MEAN VALUE OF THE EXNER FUNCTION IN EACH LAYER.
      PIM(LON,K)=(PI(LON,K+1)-PI(LON,K)) /
     1   (ROCP*(ALNP(LON,K+1)-ALNP(LON,K)))
C   COMPUTE THE LOG OF PIM.
      WRK(LON,K)=ALOG(PIM(LON,K))
C   COMPUTE THE LOG OF THE MEAN VALUE OF PRESSURE IN EACH LAYER.
      ALNPM(LON,K)=WTL+CPOR*WRK(LON,K)
  520 CONTINUE
C   COMPUTE THE HEIGHT OF THE SIGMA SURFACES.
      DO 530 LON=1,LONG
      Z(LON,1)=TOP(LON)
  530 CONTINUE
      DO 540 K=1,LEVG
      DO 540 LON=1,LONG
      Z(LON,K+1)=Z(LON,K)+ROG*TS(LON,K)*
     1   (ALNP(LON,K)-ALNP(LON,K+1))
  540 CONTINUE
C   COMPUTE THE TEMPERATURE ON SIGMA SURFACES. MODEL THE TEMP PROFILE
C   AS LINEAR IN LOG OF PRESSURE. EXTRAPOLATE TO DETERMINE THE VALUE OF
C   TEMP AT THE HIGHEST AND LOWEST SIGMA SURFACE.
      DO 600 K=2,LEVG
      DO 600 LON=1,LONG
      TLEV(LON,K)=((ALNP(LON,K)-ALNPM(LON,K))*TS(LON,K-1)
     1   +(ALNPM(LON,K-1)-ALNP(LON,K))*TS(LON,K))
     2   /(ALNPM(LON,K-1)-ALNPM(LON,K))
  600 CONTINUE
      DO 650 LON=1,LONG
      TLEV(LON,1)=((ALNP(LON,1)-ALNPM(LON,2))*TS(LON,1)
     1   +(ALNPM(LON,1)-ALNP(LON,1))*TS(LON,2))
     2   /(ALNPM(LON,1)-ALNPM(LON,2))
      TLEV(LON, LEVGP)=
     1   ((ALNP(LON, LEVGP)-ALNPM(LON, LEVG))*TS(LON, LEVGM)
     3   +(ALNPM(LON, LEVGM)-ALNP(LON, LEVGP))*TS(LON, LEVG))
     5   /(ALNPM(LON, LEVGM)-ALNPM(LON, LEVG))
  650 CONTINUE
      DO 700 LON=1,LONG
      ZLAY(LON)=0.5 * (Z(LON,1)+Z(LON,2))
      TSTR(LON)=TS(LON,1)+0.0065 *(ZLAY(LON)-Z(LON,1))
      TMSL(LON)=TS(LON,1)+.0065 * ZLAY(LON)
      GAMMA(LON)=0.0
      IF(TMSL(LON) .LE. 290.66) GO TO 690
      TMSL(LON)=290.66
      IF(TSTR(LON) .GT. 290.66)
     1  TMSL(LON)=290.66 - 0.005 * (TSTR(LON) - 290.66 ) *
     2                             (TSTR(LON) - 290.66 )
  690 IF (Z(LON,1) .GT. 75.0)
     1  GAMMA(LON)=(TSTR(LON)-TMSL(LON))/Z(LON,1)
  700 CONTINUE
      DO 750 K=1,LEVG
      DO 750 LON=1,LONG
      DH(LON,K)=ALNP(LON,K+1)-ALNP(LON,K)
      BZ(LON,K)=ROG*(TLEV(LON,K+1)-TLEV(LON,K))/DH(LON,K)
      ZT(LON,K)=0.5 *(Z(LON,K+1)+Z(LON,K)) +
     1   0.125 * BZ(LON,K) * DH(LON,K) * DH(LON,K)
      BALNP(LON,K)=0.5 * (ALNP(LON,K+1)+ALNP(LON,K))
  750 CONTINUE
      DO 800 K=1,LEVGM
      DO 800 LON=1,LONG
      RDELP(LON,K)=1.0/(ALNPM(LON,K+1)-ALNPM(LON,K))
      BTV(LON,K)=(TS(LON,K+1)-TS(LON,K))*RDELP(LON,K)
  800 CONTINUE
      DO 1100 I=1,LONG
C     HEIGHTS TO PRESSURE SURFACES  -  HYDROSTATIC INTERPOLATION
C     WINDS AND TEMPS BY LINEAR INTERPOLATION WITH LN(P)
      KB=1
      KF=1
         DO 1090 KP=1,NMAND
C     SEARCH FOR MIDDLE OF SIGMA LAYER ABOVE KP
         DO 1030 K=KB,LEVG
      KS = K
      IF(ALNPMD(KP).GT.ALNPM(I,K))  GO TO 1040
 1030 CONTINUE
C     IF FALL THRU MUST EXTRAPOLATE UP
         KS = LEVG
C     FIND VALUES AND SLOPES FOR UPWARD OR DOWNWARD EXTRAPOLATION
C     AS WELL AS FOR INTERPOLATION AWAY FROM TROPOPAUSE
 1040 CONTINUE
      KB=KS
      IF(KS.NE.1)GO TO 1084
      TVP(I,KP)=TS(I,1)+BTV(I,1)*(ALNPMD(KP)-ALNPM(I,1))
      GO TO 1088
 1084 CONTINUE
      DDP=ALNPMD(KP)-ALNPM(I,KS)
      TVP(I,KP)=TS(I,KS)+BTV(I,KS-1)*DDP
 1088 CONTINUE
C       START WITH ANOTHER SEARCH THRU THE SIGMA LEVELS
C      TO FIND THE LEVEL (KS)  ABOVE THE DESIRES MANDATORY LEVEL (KP)
      DO 1310 K=KF,LEVGP
        KS = K
        IF(ALNPMD(KP).GT.ALNP(I,K))  GO TO 1320
 1310 CONTINUE
 1320 CONTINUE
      KF=KS
      IF(KS.EQ.1)GO TO 1340
C     ZP REFERENCES A PRESSURE LEVEL IN THE FREE AIR
 1330 CONTINUE
      HMH=ALNPMD(KP)-BALNP(I,KS-1)
      ZP(I,KP)=ZT(I,KS-1)-
     1   (ROG*TS(I,KS-1)+0.5 * BZ(I,KS-1)*HMH)*HMH
      GO TO 1090
 1340 CONTINUE
C   ZP(I,KP) IS BELOW GROUND.
      PART=ROG*(ALNP(I,1)-ALNPMD(KP))
      ZP(I,KP)=Z(I,1)+TSTR(I)*PART/
     1   (1.0 - 0.5 * PART*GAMMA(I))
 1090 CONTINUE
 1100    CONTINUE
      RETURN
      END
      SUBROUTINE SKIPF(NSFILE,LEV)
      DO 10 L=1,LEV
      READ(NSFILE)
   10 CONTINUE
      RETURN
      END
      SUBROUTINE SKIPPR(NS,NPROG,NLEVS)
      DIMENSION NLEVS(NPROG)
      DO 3 J=1,NPROG
      DO 2 I=1,NLEVS(J)
      READ(NS)
  2   CONTINUE
  3   CONTINUE
      WRITE(3,100)
 100  FORMAT(1H0,'PROGS SKIPPED')
      RETURN
      END
      SUBROUTINE STOR(PMAND,ALNPMD,LEVIN)
C     GENERAL PURPOSE SINGLE FIELD SPECTRAL SIGMA TO REGULAR PRESSURE
C     CONVERSION SUBROUTINE.  INPUT ARRAY ASSUMED TO BE IN 1ST SLOT
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
C     INCLUDE (PSTCMX)
      COMMON/PLNCOM/PLN(JKEPS,LATGH),
     1EPS(JKEPS),SNNP1(JKSCA),QLN(JKVEC),
     2 COLRAD(LATGH),WGT(LATGH),WGTCS(LATGH),RCS2(LATGH)
C....
      COMMON /SCRTCH/DIMION(65536)
      COMMON /NCARFT/SCNMC(NFFTF)
C((((((((((((......BLANK COMMON BLOCK........))))))))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
      DIMENSION
     *THG(LONR,LATR,NMAND),SG(LONR,LATR,NMAND),MASK(LONR,LATR,NMAND),
     *SLPG(LONR,LATR),QG(LONR,LATR),REGOUT(LONR,LATR,NMAND),
     *PSMB( LONG,LATG),GAUSIN( LONG, LATG,LEVG)
      DIMENSION
     *UG(LONR,LATR,NMAND),VG(LONR,LATR,NMAND),TVG(LONR,LATR,NMAND),
     *OG(LONR,LATR,NMAND),TG(LONR,LATR,NMAND),RG(LONR,LATR,NMAND),
     *ZG(LONR,LATR,NMAND),SFG(LONR,LATR,NMAND),VPG(LONR,LATR,NMAND),
     *DG(LONR,LATR,NMAND),XG(LONR,LATR,NMAND),USA(LONG,LEVG),
     *VSA(LONG,LEVG),TSA( LONG,LEVG),SHA( LONG,LEVG),SFA(LONG,LEVG),
     *VXA(LONG,LEVG),USB( LONG,LEVG),VSB( LONG,LEVG),TSB( LONG,LEVG),
     *SHB( LONG,LEVG),SFB(LONG,LEVG),VXB(LONG,LEVG),
     *HA(LONG),Q3(LONG),HB(LONG),Q4(LONG),
     *TE(JKSCA ,LEVG),SH( JKSCA,LEVG),TM( JKSCA,LEVG),
     *RQ( JKSCA,LEVQ),SF(JKSCA,LEVG),VP(JKSCA,LEVG),TPA(LONG,NMAND),
     *RPA(LONG,NMAND),ZPA(LONG,NMAND),DIPA(LONG,NMAND),
     *ZEPA(LONG,NMAND),SFPA(LONG,NMAND),VXPA(LONG,NMAND),
     *TVPA(LONG,NMAND),TPB(LONG,NMAND),RPB(LONG,NMAND),
     *ZPB(LONG,NMAND),DIPB(LONG,NMAND),ZEPB(LONG,NMAND),
     *SFPB(LONG,NMAND),VXPB(LONG,NMAND),TVPB(LONG,NMAND)
C....
      COMMON IDATE(4),HOUR,SI(LEVGP),SL(LEVG),DEL(LEVG)
C....
      COMMON ALONP( LONG),ALATP( LATG),ALONE(LONGP),ALATE(LATGP),
     A       BLONP(LONR),BLATP(LATR),BLONE(LONRP),BLATE(LATRP),
     B       TRPLON(IBX1, LONG),TRPLAT(IBX2, LATG),LONTRP(IBX1, LONG),
     C       NLNTRP( LONG),LATTRP(IBX2, LATG),NLTTRP( LONG)
C....
      COMMON
     * DPHIA( LONG),DLAMA( LONG),QA(LONG),
     * DIA( LONG,LEVG),ZEA( LONG,LEVG),TMA( LONG,LEVG),OMGA(LONG,LEVG)
      COMMON
     * DPHIB( LONG),DLAMB( LONG),QB(LONG),
     * DIB( LONG,LEVG),ZEB( LONG,LEVG),TMB( LONG,LEVG),OMGB(LONG,LEVG)
C....
      COMMON  WORK( LONG,LEVG)
C....
      COMMON
     *UPA(LONG,NMAND),VPA(LONG,NMAND),OPA(LONG,NMAND)
      COMMON
     *UPB(LONG,NMAND),VPB(LONG,NMAND),OPB(LONG,NMAND)
C....
      COMMON
     *GZ( JKSCA),DPDPHI( JKVEC),DPDLAM(JKSCA ),Q(JKSCA),
     *DI(JKSCA,LEVG),ZE(JKSCA,LEVG),ULN(JKVEC,LEVG),VLN(JKVEC,LEVG)
C....
      COMMON PSMB,SLPG,QG,DG,XG,OG
C....
      EQUIVALENCE (DG(1,1,1),UG(1,1,1),TG(1,1,1),TVG(1,1,1),SFG(1,1,1))
      EQUIVALENCE (XG(1,1,1),VG(1,1,1),RG(1,1,1),ZG(1,1,1),VPG(1,1,1))
      EQUIVALENCE (OG(1,1,1),SG(1,1,1),THG(1,1,1),MASK(1,1,1),
     *REGOUT(1,1,1))
      EQUIVALENCE (DLAMA(1),HA(1),Q3(1))
      EQUIVALENCE (DIA(1,1),TSA(1,1),SFA(1,1))
      EQUIVALENCE (ZEA(1,1),USA(1,1),VXA(1,1),SHA(1,1))
      EQUIVALENCE (TMA(1,1),VSA(1,1))
      EQUIVALENCE (DLAMB(1),HB(1),Q4(1))
      EQUIVALENCE (DIB(1,1),TSB(1,1),SFB(1,1))
      EQUIVALENCE (ZEB(1,1),USB(1,1),VXB(1,1),SHB(1,1))
      EQUIVALENCE (TMB(1,1),VSB(1,1))
      EQUIVALENCE (UPA(1,1),DIPA(1,1),SFPA(1,1),TVPA(1,1),TPA(1,1))
      EQUIVALENCE (VPA(1,1),ZEPA(1,1),VXPA(1,1),ZPA(1,1),RPA(1,1))
      EQUIVALENCE (UPB(1,1),DIPB(1,1),SFPB(1,1),TVPB(1,1),TPB(1,1))
      EQUIVALENCE (VPB(1,1),ZEPB(1,1),VXPB(1,1),ZPB(1,1),RPB(1,1))
      EQUIVALENCE (DI(1,1),TE(1,1),GAUSIN(1,1,1))
      EQUIVALENCE (ZE(1,1),SH(1,1))
      EQUIVALENCE (ULN(1,1),SF(1,1),RQ(1,1))
      EQUIVALENCE (VLN(1,1),VP(1,1),TM(1,1))
C((((((((((((((((.......END BLANK COMMON BLOCK......))))))))))))))
C    ................MEM CDCH(GCOMP) ............................
C     INCLUDE (PSTDTB)
      CHARACTER CHRDSC*40,CHRDO*40,CHRDV*40,CHREQ*40,PRODIA*4,SPCGRD*4,
     *CHROP*40
      COMMON /DIRTABC/CHRDSC(NDI),PRODIA(NDI),SPCGRD(NDI),CHRDO(NDP),
     *CHROP(NDP),CHRDV(NDV),CHREQ(NDV,MDF)
      COMMON/DIRTAB/NHARM(NDI),NLEVS(NDI),IFLDCD(NDI),MKDIR(NDI),
     *NUC(NDP),MKO(NDP),IFE(NDP),NVO(NDP),NUCO(NDP),NFE(NDP),
     *KDV(NDV),NVV(NDV),MKDV(NDV),LIF(NDV)
      DIMENSION PMAND(NMAND),ALNPMD(NMAND)
      LOUT=NMAND
      IF(LEVIN.EQ.1)LOUT=1
       CALL CONFIL(OG, LTLO * LOUT ,0.0)
C**********************************************************************
C
C      PAD INPUT IF 1<LEVIN<LEVG
C
C**********************************************************************
      IF(LEVIN.LT.LEVG.AND.LEVIN.GT.1)
     *CALL CONFIL(DI(1,LEVIN+1),JKSCA*(LEVG-LEVIN),0.0)
C**********************************************************************
C
C      GAUSSIAN LOOP PERFORMS LEGENDRE TRANSFORMS, FOURIER TRANSFORMS
C      INTO GAUSSIAN GRID, LATITUDE-BY-LATITUDE.  GAUSSIAN GRIDS ARE
C      THEN AREALLY INTERPOLATED INTO OUTPUT  GRIDS.
C
C**********************************************************************
      DO 1000 LAT = 1,LATGH
        DO 800 IH = 1, JKEPS
        QLN(2*IH-1) = PLN(IH,LAT)
        QLN(2*IH) = PLN(IH,LAT)
  800   CONTINUE
C**********************************************************************
C
C     SUMPLS, SUMPLV PERFORM LEGENDRE TRANSFORMS FROM SPECTRAL TO
C     FOURIER REPRESENTATIONS.
C
C**********************************************************************
      IF(LEVIN.GT.1)CALL SUMPLS(Q,QA,QB,QLN,1)
      CALL SUMPLS(DI,DIA,DIB,QLN,LEVIN)
C..................................................
      COSLAT= SIN (COLRAD(LAT))
      RCL=RCS2(LAT)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR NORTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO=LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      IF(LEVIN.GT.1)THEN
      CALL FFSNFS(QA,SCNMC,1+LEVIN)
      ELSE
      CALL FFSNFS(DIA,SCNMC,1)
      DO 825 I=1,LONG
      DIPA(I,1)=DIA(I,1)
  825 CONTINUE
      GO TO 840
      END IF
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 830 I=1,LONG
      QA(I)=EXP(QA(I))
  830 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QA,SI,SL,PMAND,ALNPMD,DEL,1,DIA,DIPA)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
  840 CALL GTRPLT(LAT,DIPA,LONG,LOUT,LATG,OG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
C***********************************************************************
C***********************************************************************
C
C     SUBSEQUENT CALCULATIONS ARE FOR SOUTHERN HEMISPHERE.
C
C***********************************************************************
C***********************************************************************
      LATCO= LATG+1-LAT
C***********************************************************************
C
C     FFSNFS PERFORMS FOURIER TRANSFORMS FROM FOURIER REPRESENTATIONS
C     TO GAUSSIAN GRID.
C
C***********************************************************************
      IF(LEVIN.GT.1)THEN
      CALL FFSNFS(QB,SCNMC,1+LEVIN)
      ELSE
      CALL FFSNFS(DIB,SCNMC,1)
      DO 855 I=1,LONG
      DIPB(I,1)=DIB(I,1)
  855 CONTINUE
      GO TO 880
      END IF
C***********************************************************************
C
C     CONVERT PRESSURE FROM LOG(CB) TO CB
C
C***********************************************************************
      DO 860 I=1,LONG
      QB(I)=EXP(QB(I))
  860 CONTINUE
C***********************************************************************
C
C     SIG2PO PERFORMS VERTICAL INTERPOLATION.
C
C***********************************************************************
      CALL SIG2PO(QB,SI,SL,PMAND,ALNPMD,DEL,1,DIB,DIPB)
C***********************************************************************
C
C     GTRPLT PERFORMS AREAL INTERPOLATION OF GAUSSIAN GRIDS TO
C     EVENLY SPACED GRIDS.
C
C***********************************************************************
  880 CALL GTRPLT(LATCO,DIPB,LONG,LOUT,LATG,OG,LONR,LATR,
     A            TRPLON,LONTRP,NLNTRP,TRPLAT,LATTRP,NLTTRP)
 1000 CONTINUE
C***********************************************************************
C
C     POLAVG FIXES POLAR VALUES OF SCALAR FIELDS PRODUCED BY
C     AREAL INTERPOLATING ROUTINE TERPWT.
C
C***********************************************************************
      CALL POLAVG(OG, LONR,LATR,LOUT)
      RETURN
      END
      SUBROUTINE SUMPLS (FLN,AP,AM,QLN,N)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION AP( LONG ,N), AM( LONG ,N),
     1 QLN( JKSCA ), FLN( JKSCA ,N)
      COMMON /SCRTCH/ S( JWV2 , KWAVE )
      LOGICAL FIRST
      SAVE FIRST,KWLOG,KINIT,KFIRST
      DATA    FIRST/.TRUE./
      IF(.NOT.FIRST)GO TO 7
      KWLOG=ALOG(FLOAT(KWAVE)+.5)/ALOG(2.0)
      KINIT=2**KWLOG
      KFIRST=KWAVE-KINIT
      KWLOG=KWLOG-1
      FIRST=.FALSE.
    7 CONTINUE
      DO 200 K=1,N
      IHAR = 0
      DO 10 IH2=1, KWAVE
      DO 10 IH1=1, JWV2
      IHAR = IHAR + 1
      S(IH1,IH2) = QLN(IHAR) * FLN(IHAR,K)
   10 CONTINUE
      KBY2=KINIT
      DO 20 IH2=1, KFIRST
      DO 20 IH1=1, JWV2
      S(IH1,IH2) = S(IH1,IH2) + S(IH1,IH2+KBY2)
   20 CONTINUE
      DO 50 LL=1,KWLOG
      KBY2=KBY2/2
      DO 30 IH2=1, KBY2
      DO 30 IH1=1, JWV2
      S(IH1,IH2) = S(IH1,IH2) + S(IH1,IH2+KBY2)
   30 CONTINUE
   50 CONTINUE
      DO 70 IH=1, JWV2
      AP(IH,K) = S(IH,1) + S(IH,2)
      AM(IH,K) = S(IH,1) - S(IH,2)
   70 CONTINUE
  200 CONTINUE
      RETURN
      END
      SUBROUTINE SUMPLV (VLN,AP,AM,QLN,N)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION AP(LONG,N), AM(LONG,N),
     1 QLN( JKVEC), VLN( JKVEC,N)
      COMMON /SCRTCH/ S( JWV2,KVEC)
      LOGICAL FIRST
      SAVE FIRST,KWLOG,KINIT,KFIRST
      DATA    FIRST/.TRUE./
      IF(.NOT.FIRST)GO TO 7
      KWLOG=ALOG(FLOAT(KVEC)+.5)/ALOG(2.0)
      KINIT=2**KWLOG
      KFIRST=KVEC-KINIT
      KWLOG=KWLOG-1
      FIRST=.FALSE.
    7 CONTINUE
      DO 200 K=1,N
      IHAR = 0
      DO 10 IH2=1,KVEC
      DO 10 IH1=1, JWV2
      IHAR = IHAR + 1
      S(IH1,IH2) = QLN(IHAR) * VLN(IHAR,K)
   10 CONTINUE
      KBY2=KINIT
      DO 20 IH2=1, KFIRST
      DO 20 IH1=1, JWV2
      S(IH1,IH2) = S(IH1,IH2) + S(IH1,IH2+KBY2)
   20 CONTINUE
      DO 50 LL=1,KWLOG
      KBY2=KBY2/2
      DO 30 IH2=1, KBY2
      DO 30 IH1=1, JWV2
      S(IH1,IH2) = S(IH1,IH2) + S(IH1,IH2+KBY2)
   30 CONTINUE
   50 CONTINUE
      DO 70 IH=1, JWV2
      AP(IH,K) = S(IH,1) + S(IH,2)
      AM(IH,K) = S(IH,1) - S(IH,2)
   70 CONTINUE
  200 CONTINUE
      RETURN
      END
      SUBROUTINE TRANSP(A,N)
       IMPLICIT REAL(A-H,O-Z)
      PARAMETER (LONR=48,LATR=40,LONG=48,LATG=40,JWAVE=16,KWAVE=16,
     *NMAND=7,LEVG=10,LEVQ=10,NDI=100,NDV=30,MDF=4,PRHCUT=30.,
     *FIRSTX=0.0,FIRSTY=90.0,LRCLB=4096)
      parameter(
     *LEVGP=LEVG+1,LEVGM=LEVG-1,NDP=NDI+NDV,LTLO=LONR*LATR,
     *JKSCA=JWAVE*KWAVE*2,LATGH=LATG/2,LONRP=LONR+1,LATRP=LATR+1,
     *KVEC=KWAVE+1,JKVEC=JWAVE*KVEC*2,LONGP=LONG+1,LATGP=LATG+1,
     *JKEPS=JWAVE*KVEC,IBX1=(LONR-1)/LONG+2,IBX2=(LATR-1)/LATG+2,
     *JKDER=JWAVE*KWAVE,JWV2=JWAVE*2,NMAND2=NMAND*2,NFFTF=15+LONG*2,
     *LRCLW=LRCLB/4)
      DIMENSION A(2,JWAVE,KWAVE,N)
      COMMON /SCRTCH/ B(2,JWAVE,KWAVE)
      DO 5 K=1,N
      DO 2 LL=1, JWAVE
      DO 1 I =1, KWAVE
      B(1,LL,I)=A(1,I,LL,K)
      B(2,LL,I)=A(2,I,LL,K)
 1    CONTINUE
 2    CONTINUE
      DO 4 I =1, KWAVE
      DO 3 LL=1, JWAVE
      A(1,LL,I,K)=B(1,LL,I)
      A(2,LL,I,K)=B(2,LL,I)
 3    CONTINUE
 4    CONTINUE
 5    CONTINUE
      RETURN
      END
      SUBROUTINE WRO(BFR,NDIM)
C     INCLUDE (BOOMDA)
      CHARACTER*4 SEQDA
      COMMON/BOOMDA/IREC,NBF,NPFILE,IPS
      COMMON/BOOMDC/SEQDA
      DIMENSION BFR(NDIM)
      IF(SEQDA.EQ.'SEQU')THEN
      DO 10 I=1,NDIM
        IF (ABS(BFR(I)).LT.1.E-30) BFR(I)=0.
 10   CONTINUE
      WRITE(NPFILE)BFR
      END IF
      IF(SEQDA.EQ.'DIRA')THEN
      WRITE(UNIT=NPFILE,REC=IREC,IOSTAT=IER)BFR
      IF(IER.NE.0)GO TO 100
      IREC=IREC+1
      END IF
      RETURN
  100 WRITE(3,113)NPFILE,IREC,IER
  113 FORMAT(' ERROR WITING TO UNIT',I3,' IREC=',I5,' IER=',I5)
      STOP 113
      END
