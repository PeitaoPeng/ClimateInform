#
#QSUB-Gc 1
#QSUB-Gf 2
#QSUB-Gp ia1
#
#QSUB -lM 2.5mW   # Memory limit
#QSUB -lT 5:00  # Time limit
#QSUB -eo        # Combine stdout and stderr and send to following
#
set echo
wipeftmp
cd $FTMPDIR
#  SET:
#
#  nmaxpts = maximum #pts in left or right field part of covariance matrix
#  nyrs    = # years
#  nmons   = # days/mons/seasons/whatever
#  idl     = inner dimension of LEFT field
#  jdl     = outer dimension of LEFT field
#  idr     = inner dimension of RIGHT field
#  jdr     = outer dimension of RIGHT field
#  nmodes  = # modes to save (max = 20)
#  normal  = yes, if you want to normalize the data
#            no,  otherwise
#  rotate  = yes, if you want to compute rotated SVD
#          = no,  if you want to compute unrotated SVD
#  title   = character*30  used in plotting the data
#  svdfile = name of file to which will save the svd in archive
#            as well as append to various other output for identification
#  left    = pathname to raw data LEFT field
#  right   = pathname to raw data RIGHT field
#  arcdir  = path to archive directory where 'svdfile' will be stored
#  netdir  = path to local disk directory where grads data will be stored
#  whomedir= path to home directory where grads will be run from
#  mon1    = if DJF mean, set mon1 = 12 (# of month starting with)
#            if JJA mean, set mon1 = 6
#  monavg  = # of months to average starting with mon1 (for DJF, monavg=3)
# iregl = region numbers in table below for LEFT field.must have 2 digits 
# iregr = region numbers in table below for RIGHT field.must have 2 digits
#  ldata    = 'atm' if LEFT is atmosphere variable, = 'sst' if is SST
#  rdata    = 'atm' if RIGHT is atmosphere variable, = 'sst' if is SST
#
# testcode == on if want some diagnostic printout code turned on
set testcode=off

set MJNHOME=`whome mjn`
set nmaxpts=132
set nyrs=46
set nmons=28
set idl=48
set jdl=16
set idr=48
set jdr=16
set nmodes=6
set normal=no
set rotate=no
set title='NMCZ5day.Ztend'
set svdfile=nmc.ndjfm.z500-5day.v.z500-5day-tendency_new

# LEFT DATA settings
set left=/archive/mjn/nmc/z500.5-day_mean.ndjfm_new
set ldata=atm
set iregl='01'
dmget $left
   if($status != 0) exit 1
\cp $left left
   if($status != 0) exit 1
assign -a left -F cache:48:1 -N ieee fort.31 

# RIGHT DATA settings
set right=/archive/mjn/nmc/z500.5-day_tendency.ndjfm_new
set rdata=atm
set iregr='01'
dmget $right
   if($status != 0) exit 1
\cp $right right
   if($status != 0) exit 1
assign -a right -F cache:48:1 -N ieee fort.32 

# mon1 and monavg not used here
set mon1='11'
set monavg='01'

set arcdir=$ARCHIVE/svd
set netdir='mjn:/net/mjn/data/svd'
set whomedir=$WHOME/svd/grads
#
# field        ireg?   domain                      # grid pts
# -----        ----    ----------                  ----------
#
# z 500                
#                1     northern hemisphere > 20N       132
#                2     pacific sector      > 20N       
#                3     atlantic sector     > 20N       

#
# IF DATA FOR SOUTHERN HEMISPHERE AND ON 48x16 grid, SET IREGL < 0, IREGR < 0
#
\cp $MJNHOME/svd/rotated_svd/*.? .
  if($status != 0) exit 1
\rm load*
\cp $MJNHOME/svd/myload/nmc_48x16.F load.F
  if($status != 0) exit 1

set lsst=0
if($ldata == 'sst') set lsst=1
set rsst=0
if($rdata == 'sst') set rsst=1

#
# CREATE UNIT 78 INPUT (read in my own load.F)
#   read(78,'(i2,1x,i2,1x,i2,1x,1x)') mbeg,mavg,ireg,lsst  <== left field
#   read(78,'(i2,1x,i2,1x,i2,1x,1x)') mbeg,mavg,ireg,rsst <== right field
#
cat > fort.78 << eof
$mon1 $monavg $iregl $lsst
$mon1 $monavg $iregr $rsst
eof

#*********************************************************************
#NO NEED TO CHANGE ANYTHING BELOW THIS POINT
#*********************************************************************
#
set opts=""
if($testcode == 'on') set opts="-D check"
if($normal == 'yes') then
  set opts=("$opts -D norml")
  set title="$title".NORM
  set svdfile="$svdfile".norm
endif
set lrsvd=0
if($rotate == 'yes') then
  set nrot=20
  set lrsvd=1
  set title=("RSVD $title")
  set svdfile="$svdfile.RSVD"
else
  set nrot="$nmodes"
endif
#
cat > parm.h << eof
c  nmon    = # days/mons/seasons/whatever
c  nyrs    = # years
c  nmax    = largest possible #pts (or max(nmaxl,nmaxr))
c  nmaxl   = can set explicitly to # of LEFT field points
c  nmaxr   = can set explicitly to # of RIGHT field points
c  ndimsv  = min(nmaxl,nmaxr)
c  nf      = # of modes starting at 1st to keep
      parameter (nmon=$nmons)
      parameter (nyr=$nyrs)
      parameter (idl=$idl,jdl=$jdl)
      parameter (idr=$idr,jdr=$jdr)
      parameter (nmax=$nmaxpts)
      parameter (nmaxl=nmax)
      parameter (nmaxr=nmax)
      parameter (ndimsv=nmax)
      parameter (nf=$nmodes)
      parameter (lrsvd=$lrsvd)
      parameter (nrot=$nrot)
eof

declare svd 61 cray
declare aleft 71 direct
declare bright 72 direct
declare bleft 73 direct
declare aright 74 direct

cf77 $opts -l nag *.[Ff]
   if($status != 0) exit 1
\rm *.?

# CREATE UNIT 79 INPUT (read in comput.F)
#   read(79,'(a30)') labex              <== title
cat > fort.79 << eof
$title
eof

a.out 
if($status != 0) exit 1

# rename title files and save to $whomedir
  mv fort.81 aleft_titles
  mv fort.82 bright_titles
  mv fort.83 bleft_titles
  mv fort.84 aright_titles
  tar cfv $svdfile.titles.tar  *titles
  rcp $svdfile.titles.tar $whomedir

# save svd results
  mv svd $arcdir/$svdfile

\rm .assign
cat > job.f << eof
      program main
      parameter (id=$idl,jd=$jdl,idjd=id*jd)
      real a(id,jd)
c
c INPUT
c aleft  = 11
c bright = 12
c bleft  = 13
c aright = 14
c
c OUTPUT
c merged = 21
c
      nrec=0
c for each mode
      do n=1,$nmodes
c for each type of correlation
        do iu=11,14
          read(iu) a
          write(21) a
        enddo
      enddo
      close(21)
      stop
      end
eof

declare aleft 11 direct
declare bright 12 direct
declare bleft 13 direct
declare aright 14 direct
declare $svdfile 21 direct
cf77 job.f
  if($status != 0) exit 1
a.out
  if($status != 0) exit 1
rcp $svdfile $netdir
cat > ctl << eof
DSET ^$svdfile
*
UNDEF -1.e10
TITLE svd projections Northern Hemisphere
*
XDEF 48 LINEAR  0.0 7.5 
YDEF 16 GAUSR15 25
ZDEF 1  LEVELS  990
TDEF $nmodes LINEAR 01jan1946 1mo
*
VARS 4
aleft   0 99  coeff a v left
bright   0 99  coeff b v right
bleft   0 99  coeff b v left
aright   0 99  coeff a v right
ENDVARS
eof
rcp ctl $netdir/$svdfile.ctl
exit 0
