
c    67  1         2         3         4         5         6         7 2
c* This reads in the corrected forecasts, the uncorrected forecasts,
c* and the observed and computes varification scores.  Correlation and
c* MSE maps are printed out for plotting.  
c* For temp and prec: nsta=327, read in weights;
c* for h700: nsta=163, weights set to 1.0.
c      parameter(nsta=327,ntim=43)
c      parameter(nsta=133,ntim=42)
c      parameter(nsta=133,ntim=42) !SET NUMBER OF STATIONS, TIMES !usual
c      parameter(nsta=197,ntim=37) !===SET NUMBER OF STATIONS, TIMES Peitao work
c      parameter(nsta=133,ntim=41) !SET NUMBER OF STATIONS, TIMES !used ocnl
       parameter(nsta=1390,ntim=45) !===SET NUMBER OF STATIONS, TIMES   AMIP 
      real zco(nsta,ntim),zuc(nsta,ntim),zob(nsta,ntim),zsp(nsta,ntim)
      real cor(nsta),err(nsta),bias(nsta),wgt(nsta),v1(1000),v2(1000) 
      real dandxb(nsta),dandsd(nsta),climo(nsta),serror(nsta)
      real insowi(ntim),insosu(ntim),v1enso(1000),v2enso(1000)
      character cs(12)*3,ctyp*4
      data ctyp/'h700'/,wgt/nsta*1.0/
c      data cs/'jan','feb','mar','apr','may','jun','jul','aug','sep',
c     *        'oct','nov','dec'/
      data cs/'djf','jfm','fma','mam','amj','mjj','jja','jas','aso',
     *        'son','ond','ndj'/
c     data insowi/    ! enso status for jfm for 1958-94   n=12
c    $    1,   0,   0,   0,   0,   0,   0,   0,   1,   0,
c    $    0,   1,   0,  -1,   0,   1,  -1,   0,  -1,   0,
c    $    0,   0,   0,   0,   0,   1,   0,  -1,   0,   1,
c    $    0,  -1,   0,   0,   1,   0,   0/
c     data insosu/    ! enso status for jas for 1958-94   n=15
c    $    0,   0,   0,   0,   0,   1,  -1,   1,   0,   0,
c    $    0,   0,  -1,  -1,   1,  -1,  -1,  -1,   0,   0,
c    $    0,   0,   0,   0,   1,   0,   0,   0,   1,   1,
c    $   -1,   0,   0,   1,   0,   0,   1/
      data insowi/    ! enso status for jfm for 1950-94   n=15
     $             -1,   0,   0,   0,   0,  -1,  -1,   0,
     $    1,   0,   0,   0,   0,   0,   0,   0,   1,   0,
     $    0,   1,   0,  -1,   0,   1,  -1,   0,  -1,   0,
     $    0,   0,   0,   0,   0,   1,   0,  -1,   0,   1,
     $    0,  -1,   0,   0,   1,   0,   0/
      data insosu/    ! enso status for jas for 1950-94   n=19
     $             -1,   0,   0,   0,  -1,  -1,  -1,   0,
     $    0,   0,   0,   0,   0,   1,  -1,   1,   0,   0,
     $    0,   0,  -1,  -1,   1,  -1,  -1,  -1,   0,   0,
     $    0,   0,   0,   0,   1,   0,   0,   0,   1,   1,
     $   -1,   0,   0,   1,   0,   0,   1/
c   --if want to correct systematic error between forecasts and obs with
c   --respect to all or a part of the base period, set errsys to 1 
c   --(otherwise set to 0) and specify the desired period in terms of
c   --year index (itim1 and itim2). 
       data errsys/0/ ! if 1, syst err corrected for spatial anom cor
       if(errsys.ne.1)errsys=0
c     if(nsta.ne.163)then
c      open(22,file='semp')
c      do n=1,nsta
c       read(22,92) wgt(n)
c   --if want to correct systematic error between forecasts and obs with
c   --respect to all or a part of the base period, set errsys to 1 
c   --(otherwise set to 0) and specify the desired period in terms of
c   --year index (itim1 and itim2). 
       data errsys/0/ ! if 1, syst err corrected for spatial anom cor
       if(errsys.ne.1)errsys=0
c     if(nsta.ne.163)then
c      open(22,file='semp')
c      do n=1,nsta
c       read(22,92) wgt(n)
c      end do
c      close(22)
c     end if
c* Loop over months or seasons.
c     write(6,95)
c     write(6,96)
 95   format('      Uncorrected',16x,'Corrected',18x,'SST Only')
 96   format('Time  Cort Cors MSEt MSEb B**2',
     *       '   Cort Cors MSEt MSEb B**2   Cort Cors MSEt MSEb B**2')
c     do 1000 mon=1,12  
      mon=02   ! === SET SEASON HERE (middle month number)
c* Read in the data.
c      open(10,file=ctyp//'/semp.'//cs(mon))
c      open(12,file='sstsp/'//ctyp//'/semp.'//cs(mon))
      open(10,file='semp')
      open(30,file='/export/sgi84/wd51ab/arcsfc/h7pnamsd')
      open(32,file='/export/sgi84/wd51ab/arcsfc/clim7995')
c     open(12,file='xtmp/sstsp/semp.'//cs(mon))
c     kdo=int(real(nsta)/15.)+1
c     ilstp=mod(nsta,15)-1
c     do 120 iter=1,mon
c     read(30,121)(dandxb(ipt),ipt=1,nsta),(dandsd(ipt),ipt=1,nsta)
c 121 format(/13(10f7.2/),3f7.2//13(10f7.2/),3f7.2)
c 120 read(32,123)(climo(ipt),ipt=1,nsta)
c 123 format(/13(10f7.2/),3f7.2)
c     write(6,122)(dandxb(ipt),ipt=1,nsta),(dandsd(ipt),ipt=1,nsta),
c    $  (climo(ipt),ipt=1,nsta)
  122 format('predictand means'/13(10f7.2/),3f7.2/'predictand ',
     $  'stand devs'/13(10f7.2/),3f7.2/'departure of 1979-95'/
     $  13(10f7.2/),3f7.2)
      do iy=1,ntim
c      do i=1,kdo
c       i1=(i-1)*15+1
c       i2=i1+14
c       if(i.eq.kdo)i2=i1+ilstp
        read(10,12) (zco(ii,iy),ii=1,nsta)
   12   format(138(9x,15f6.3/),9x,15f6.3)
c       read(12,12) (zsp(ii,iy),ii=i1,i2)
c      end do
c      do i=1,kdo
c       i1=(i-1)*15+1
c       i2=i1+14
c       if(i.eq.kdo)i2=i1+ilstp
c       read(10,12) (zuc(ii,iy),ii=1,nsta)
c       read(12,12) (dum,ii=i1,i2)
c      end do
c      do i=1,kdo
c       i1=(i-1)*15+1
c       i2=i1+14
c       if(i.eq.kdo)i2=i1+ilstp
        read(10,12) (zob(ii,iy),ii=1,nsta)
c       read(12,12) (dum,ii=i1,i2)
c      end do
      end do
      close(10)
ccc      print*, 'Got the data: '//cs(mon)
c* Get and write out the map mean statistics:
c* (1) uncorrected, (2) corrected.
c   --temporal correlation skill
      av=0.
      aven=0.
      do 200 ii=1,nsta
      ktenso=0
      do 201 iy=1,ntim
      if(ii.eq.1)write(6,202)ii,zco(ii,iy),zob(ii,iy)
  202 format(i4,2x,2f7.2)
      v1(iy)=zco(ii,iy)
      v2(iy)=zob(ii,iy)
        if(mon.eq.2.and.insowi(iy).ne.0)then
          ktenso=ktenso+1
          v1enso(ktenso)=v1(iy)
          v2enso(ktenso)=v2(iy)
        end if
        if(mon.eq.8.and.insosu(iy).ne.0)then
          ktenso=ktenso+1
          v1enso(ktenso)=v1(iy)
          v2enso(ktenso)=v2(iy)
        end if
  201 continue
           itim1=26
           itim2=34
           if(mon.eq.1)itim1=27
           nysys=itim2-itim1+1
c   --find sysematic fcst error with respect to period defined by itim1,itim2 
      if (errsys.eq.1)call syserr(v1,v2,ii,ntim,nsta,itim1,itim2,serror)
      call CORREL(v1,v2,ntim,a1,a2,sd1,sd2,c)                   ! all years
      call CORREL(v1enso,v2enso,ktenso,aa1,aa2,sdv1,sdv2,censo) ! enso yrs only
c   --adjust for cross-validation degeneracy
      if(c.lt.0.)c=c*(sd1/sd2)       
      if(censo.lt.0.)censo=censo*(sdv1/sdv2)
      write(6,204)mon,ii,ntim,a1,a2,sd1,sd2,c
  204 format('isea=',i2,' pt',i4,' ntim=',i2,' avg',2f7.2,' sd',2f7.2,
     $ ' cor',f6.2)
      write(6,321)    ii,ktenso,aa1,aa2,sdv1,sdv2,censo
  321 format(' enso',2x,' pt',i4,' ntim=',i2,' avg',2f7.2,' sd',2f7.2,
     $ ' cor',f6.2)
      av=av+c
      aven=aven+censo
  200 continue
      write(6,241)(serror(ista),ista=1,nsta)
  241 format('systematic error in fcsts'/14(10f7.2/))
      av=av/float(nsta)
      aven=aven/float(nsta)
      write(6,205)mon,nsta,av,aven,ktenso,ntim
  205 format('isea=',i2,' mean temporal correl, for',i4,' stations is',
     $  2f7.3/30x,' (2nd one:enso); n=',i3,', not',i3)
c   --spatial correlation skill;once with normalized point data, then
c   --with nonnormalized (higher latitudes take on higher amplitudes).
c     do 310 inorm=1,2
      do 310 inorm=1,1   ! if not doing Jeff/Huug stuff, no need for inorm=2
      av1=0.
      av2=0.
      av8088=0.
      do 301 iy=1,ntim
c     iyr=54+iy
c     iyr=57+iy
      iyr=49+iy
      do 300 ii=1,nsta
      if(inorm.eq.1)then
         v1(ii)=zco(ii,iy)-climo(ii)-errsys*serror(ii)
         v2(ii)=zob(ii,iy)-climo(ii)
      else
         v1(ii)=(zco(ii,iy)-climo(ii)-errsys*serror(ii))*dandsd(ii)
         v2(ii)=(zob(ii,iy)-climo(ii))*dandsd(ii)
      end if
  300 continue 
      call CORREL(v1,v2,nsta,a1,a2,sd1,sd2,c)
      call COR2(v1,v2,nsta,a1,a2,sd1,sd2,c2)
      write(6,304)mon,iy,iyr,nsta,a1,a2,sd1,sd2,c,c2
  304 format('isea=',i2,' yr',2i3,' nsta=',i3,' avg',2f7.2,' sd',2f7.2,
     $ ' C,C2',2f6.2)
      av1=av1+c/float(ntim)
      av2=av2+c2/float(ntim)
      if(iy.ge.itim1.and.iy.le.itim2)av8088=av8088+c2/float(nysys)
  301 continue
      write(6,305)mon,ntim,av1,av2,av8088
  305 format('isea=',i2,' mean spatial cor, cor2 for',i4,' cases is',
     $  2f7.3/'av8088 for cor2 =',f7.3)
  310 continue ! normalization loop: two passes.
c1000 continue
      stop
      end
      SUBROUTINE CORREL(VRBL1,VRBL2,N,AVG1,AVG2,SD1,SD2,COR)                    
      DIMENSION VRBL1(N),VRBL2(N)                                               
      AVG1=0.                                                                   
      AVG2=0.                                                                   
      SD1=0.                                                                    
      SD2=0.                                                                    
      COR=0.                                                                    
      DO 10 I=1,N                                                               
      AVG1=AVG1+VRBL1(I)                                                        
   10 AVG2=AVG2+VRBL2(I)                                                        
      AVG1=AVG1/FLOAT(N)                                                        
      AVG2=AVG2/FLOAT(N)                                                        
      DO 20 J=1,N                                                               
      SD1=SD1+(VRBL1(J)-AVG1)**2                                                
   20 SD2=SD2+(VRBL2(J)-AVG2)**2                                                
      SD1=SQRT(SD1/FLOAT(N))                                                    
      SD2=SQRT(SD2/FLOAT(N))                                                    
      DO 30 K=1,N                                                               
   30 COR=COR+((VRBL1(K)-AVG1)/SD1)*((VRBL2(K)-AVG2)/SD2)                       
      COR=COR/FLOAT(N)                                                          
      RETURN                                                                    
      END                                                                       
      SUBROUTINE COR2(VRBL1,VRBL2,N,AVG1,AVG2,SD1,SD2,COR)                    
      DIMENSION VRBL1(N),VRBL2(N)                                               
      AVG1=0.                                                                   
      AVG2=0.                                                                   
      SD1=0.                                                                    
      SD2=0.                                                                    
      COR=0.                                                                    
      DO 10 I=1,N                                                               
      AVG1=AVG1+VRBL1(I)                                                        
   10 AVG2=AVG2+VRBL2(I)                                                        
      AVG1=AVG1/FLOAT(N)                                                        
      AVG2=AVG2/FLOAT(N)                                                        
      DO 20 J=1,N                                                               
      SD1=SD1+(VRBL1(J)-0.)**2                                                
   20 SD2=SD2+(VRBL2(J)-0.)**2                                                
      SD1=SQRT(SD1/FLOAT(N))                                                    
      SD2=SQRT(SD2/FLOAT(N))                                                    
      DO 30 K=1,N                                                               
   30 COR=COR+((VRBL1(K)-0.)/SD1)*((VRBL2(K)-0.)/SD2)                       
      COR=COR/FLOAT(N)                                                          
      RETURN                                                                    
      END                                                                       
      subroutine syserr(v1,v2,ista,ntim,nsta,itim1,itim2,serror) 
c   --This determines systematic error in forecasts with respect
c   --to a specified period whose starting and ending time-index
c   --numbers (not to exceed ntim) are as given in the last two 
c   --arguments. The error is loaded into "serror" for the 
c   --current station (ista out of nsta)
      dimension v1(1000),v2(1000),serror(nsta)
      ntcor=itim2-itim1+1
      avg1=0.
      avg2=0.
      if(itim1.lt.1)itim1=1
      if(itim2.gt.ntim)itim1=ntim
      do 1 iy=itim1,itim2
      avg1=avg1+v1(iy) 
    1 avg2=avg2+v2(iy) 
      avg1=avg1/float(ntcor)
      avg2=avg2/float(ntcor)
      serror(ista)=avg1-avg2
      return
      end

