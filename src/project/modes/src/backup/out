9c9,10
<       real f3d(imx,jmx,ny),f4d(imx,jmx,ny,3),f4d2(imx,jmx,ny,3)
---
>       real f3d(imx,jmx,ny),f3d2(imx,jmx,ny),f3d3(imx,jmx,ny)
>       real f4d(imx,jmx,ny,3),f4d2(imx,jmx,ny,3)
13,14c14,15
<       real ts1(ny),ts2(ny)
<       real ts3(ifld),ts4(ifld)
---
>       real ts0(ny),ts1(ny),ts2(ny)
>       real ts3(ifld),ts4(ifld),ts5(ifld)
25a27
>       real eout(ngrd)
28a31
>       open(50,form='unformatted',access='direct',recl=4*ngrd)
31d33
<       open(53,form='unformatted',access='direct',recl=4*imx*jmx)
40c42,43
<       write(6,*) 'coslat=',coslat
---
> c     write(6,*) 'coslat=',coslat
>       write(6,*) 'cosr=',cosr
61,62c64,65
< c clim, std and normalize
<       its=clm_s
---
> c  mtp, trd and normalize
> c
72,78c75,90
< c clm_std
<       call clm_std(f3d,imx,jmx,ny,its,clim,stdv)
<       if(ms.eq.2) then
<       write(53,rec=1) clim
<       write(53,rec=2) stdv
<       endif
< c
---
>       go to 1212
>       call clm_std(f3d,imx,jmx,ny,1,clim,stdv)
> c have tropical mean index
>       do it=1,ny
>         ts1(it)=0
>         tarea=0
>       do i=1,imx
>       do j=32,42
>         ts1(it)=ts1(it)+coslat(j)*f3d(i,j,it)
>         tarea=tarea+coslat(j)
>       enddo
>       enddo
>         ts1(it)=ts1(it)/tarea
>       enddo
>       call normal(ts1,ts0,ny)
> c have regression pattern
81c93,96
<          var3m(i,j,ms)=stdv(i,j)*stdv(i,j)
---
>       do it=1,ny
>         ts1(it)=f3d(i,j,it)
>       enddo
>       call regr_t(ts0,ts1,ny,corr(i,j),regr(i,j),undef)
83a99,117
> c have residual
> c
>       if(mtp.eq.0) then
>       do it=1,ny
>         do i=1,imx
>         do j=1,jmx
>           f3d(i,j,it)=f3d(i,j,it)-ts0(it)*regr(i,j)
>         enddo
>         enddo
>       enddo
>       endif
> c
> c detrend
>       if(ktrd.eq.0) then
>       call ltrend(f3d,f3d2,f3d3,imx,jmx,ny,1,ny,fld,fld2)
>       call assign3d(f3d2,f3d,imx,jmx,ny)
>       endif
>  1212 continue
> c
91d124
<         do it=1,ny
92a126
>         do it=1,ny
93a128
>         enddo
94a130
>         do it=1,ny
96,97d131
<         endif
<           f4d2(i,j,it,ms)=ts1(it) ! raw
98a133
>         endif
103,113d137
< c totvar
<       do i=1,imx
<       do j=1,jmx
<         vartot(i,j)=0
<         do ms=1,3
<          vartot(i,j)=vartot(i,j)+var3m(i,j,ms)/3.
<         enddo
<       enddo
<       enddo
<       call area_avg(vartot,coslat,imx,jmx,is,ie,js,je,vout0)
<       write(6,*) 'vout0=',vout0
130a155
>       iw3=0
151c176
<      &           nmod,reval,revec,rcoef,tt,rwk,rwk2)
---
>      &           nmod,reval,revec,rcoef,tt,rwk,rwk2,mskip)
169,176d193
< c== put rcoef to tcof for easy later use
< c
<       do m=1,nmod
<       do it=1,ifld
<         tcof(m,it)=rcoef(m,it)
<       enddo
<       enddo
< c
183c200,201
<         ts3(it)=tcof(m,it)
---
>         ts3(it)=coef(m,it)
>         ts4(it)=rcoef(m,it)
190c208
<         ts4(it)=afld(i,j,it)
---
>         ts5(it)=afld(i,j,it)
193c211,212
<       call regr_t(ts3,ts4,ifld,corr(i,j),regr(i,j),undef)
---
>       call regr_t(ts3,ts5,ifld,corr(i,j),regr(i,j),undef)
>       call regr_t(ts4,ts5,ifld,corr2(i,j),regr2(i,j),undef)
197,201c216,218
< c
<       do i=1,imx
<       do j=1,jmx
<         varp(i,j)=regr(i,j)*regr(i,j)
<       enddo
---
> 
>       do i=1,ngrd
>          eout(i)=revec(i,m)
203,206c220
<         
<       call area_avg(varp,coslat,imx,jmx,is,ie,js,je,out2)
<       ratio=out2/vout0
<       write(6,*)'mode=',m, ' ratio= ',ratio
---
>       call noreof(eout,ngrd)
207a222
> c
209,211c224,229
<       write(51,rec=iw) corr
<       iw=iw+1
<       write(51,rec=iw) regr
---
>       write(50,rec=iw) eout
> 
>       iw2=iw2+1
>       write(51,rec=iw2) regr
>       iw2=iw2+1
>       write(51,rec=iw2) regr2
213d230
<       call normal(ts3,ts4,ifld)
215,216c232,237
<       iw2=iw2+1
<       write(52,rec=iw2) ts4
---
>       call normal(ts3,ts5,ifld)
>       iw3=iw3+1
>       write(52,rec=iw3) ts5
>       call normal(ts4,ts5,ifld)
>       iw3=iw3+1
>       write(52,rec=iw3) ts5
222a244,255
>       SUBROUTINE assign3d(f1,f2,n,m,k)
>       DIMENSION f1(n,m,k),f2(n,m,k)
>       do i=1,n
>       do j=1,m
>       do l=1,k
>          f2(i,j,l)=f1(i,j,l)
>       enddo
>       enddo
>       enddo
>       return
>       end
> 
232a266,320
>       SUBROUTINE noreof(rot,ifld)
>       DIMENSION rot(ifld)
>       avg=0.
>       do i=1,ifld
>          avg=avg+rot(i)/float(ifld)
>       enddo
>       do i=1,ifld
> c       rot(i)=rot(i)-avg
>         rot(i)=rot(i)
>       enddo
> c
>       sd=0.
>       do i=1,ifld
>         sd=sd+rot(i)*rot(i)/float(ifld)
>       enddo
>         sd=sqrt(sd)
>       do i=1,ifld
>         rot(i)=rot(i)/sd
>       enddo
>       return
>       end
> 
>       SUBROUTINE noreof2d(fld,imx,jmx,is,ie,js,je)
>       DIMENSION fld(imx,jmx)
>       av=0.
>       ng=0
>       do i=is,ie
>       do j=js,je
>          ng=ng+1
>          av=av+fld(i,j)
>       enddo
>       enddo
>       av=av/float(ng)
> c
>       do i=is,ie
>       do j=js,je
> c        fld(i,j)=fld(i,j)-av
>       enddo
>       enddo
> c
>       sd=0.
>       do i=is,ie
>       do j=js,je
>         sd=sd+fld(i,j)**2/float(ng)
>       enddo
>       enddo
>         sd=sqrt(sd)
>       do i=is,ie
>       do j=js,je
>         fld(i,j)=fld(i,j)/sd
>       enddo
>       enddo
>       return
>       end
> 
282,283c370,371
< c       rot2(i)=rot(i)-avg
<         rot2(i)=rot(i)
---
>         rot2(i)=rot(i)-avg
> c       rot2(i)=rot(i)
382a471,527
> CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
> C  using least square to have y=a+bx
> CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
>       subroutine ltrend(grid,out,out2,imx,jmx,nt,its,ite,a,b)
>       dimension grid(imx,jmx,nt),out(imx,jmx,nt)
>       dimension out2(imx,jmx,nt)
>       dimension a(imx,jmx),b(imx,jmx)
>       real lxx, lxy
> c
>       do i=1,imx
>       do j=1,jmx
> c
>       if(grid(i,j,1).gt.-1000) then
> c
>       xb=0
>       yb=0
>       do it=its,ite
>         xb=xb+float(it)/float(ite-its+1)
>         yb=yb+grid(i,j,it)/float(ite-its+1)
>       enddo
> c
>       lxx=0.
>       lxy=0.
>       do it=its,ite
>       lxx=lxx+(it-xb)*(it-xb)
>       lxy=lxy+(it-xb)*(grid(i,j,it)-yb)
>       enddo
>       b(i,j)=lxy/lxx
>       a(i,j)=yb-b(i,j)*xb
> 
>       else
>       a(i,j)=-9.99E+8
>       b(i,j)=-9.99E+8
>       endif
> 
>       enddo !over j
>       enddo !over i
> c
>       do i=1,imx
>       do j=1,jmx
>       do it=1,nt
> 
>       if(grid(i,j,1).gt.-1000) then
>         out(i,j,it)=grid(i,j,it)-b(i,j)*float(it)-a(i,j) !detrended
>         out2(i,j,it)=b(i,j)*float(it)+a(i,j) !trend
>       else
>         out(i,j,it)=-9.99E+8
>         out2(i,j,it)=-9.99E+8
>       endif
> 
>       enddo
>       enddo
>       enddo
> c
>       return
>       end
> 
