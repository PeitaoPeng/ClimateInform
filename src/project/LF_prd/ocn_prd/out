9c9,10
<       real grid(imax,ltime),wmoobs(imax,ntprd)
---
>       real grid(imax,ltime),grid2(imax,ltime)
>       real grid3(imax,ltime),wmoobs(imax,ntprd)
28c29
<       dimension clmg(ndec-3,imax)
---
>       dimension clmg(ndec,imax)
30,35d30
<       dimension rtprd(imax),rtprdn(imax)
<       dimension iobs(imax,ntprd-30),iprd(imax,ntprd-30)
<       dimension i1d1(imax),i1d2(imax)
<       dimension hsmap(imax)
<       dimension sdp(imax),sdo(imax)
<       dimension wk22(ndx,ndy)
37c32
<       real fld3D(imax,nyear,12)
---
>       real fld3D(imax,ltime+1,12)
40,41c35,39
<       open(unit=15,form='unformatted',access='direct',recl=4*ndx*ndy)
<       open(unit=16,form='unformatted',access='direct',recl=4)
---
>       open(unit=20,form='unformatted',access='direct',recl=4*imax)
>       open(unit=25,form='unformatted',access='direct',recl=4*imax)
>       open(unit=40,form='unformatted',access='direct',recl=4)
>       open(unit=50,form='unformatted',access='direct',recl=4*imax)
>       open(unit=60,form='unformatted',access='direct',recl=4)
44c42
<       do ny=1,nyear
---
>       do ny=1,ltime+1
53,54c51,53
< c== seasonal anomalies
<       call season_anom(fld3D,nyear,ltime,iseason,imax,grid)
---
> c
> c== seasonal mean
>       call season_mean(fld3D,ltime+1,iseason,imax,grid)
57c56
< C== REOF analysis for the 1931-90 period
---
> c
58a58,61
> c     ifld=60
>       call season_anom2(fld3D,ltime+1,ifld,iseason,imax,grid2)
> c
> C== REOF analysis for the 1931-90 period
60c63
<       call reof_rpc(grid,imax,ltime,ifld,mrot,mmax,nw,fld2D,eof)
---
>       call reof_rpc(grid2,imax,ltime,ifld,mrot,mmax,nw,fld2D,eof)
67c70
<      &ltime,ntprd,mmax,kp,ltime,m)
---
>      &ltime,ntprd,mmax,kp,ifld,m)
100c103,104
<       call reof_rpc(grid,imax,ltime,ifld,mrot,mmax,nw,fld2D,eof)
---
>       call season_anom2(fld3D,ltime+1,it,iseason,imax,grid3)
>       call reof_rpc(grid3,imax,ltime,ifld,mrot,mmax,nw,fld2D,eof)
119a124
> c
131c136
< c       write(60,rec=iw) fldprd(m,it)
---
>         write(60,rec=iw) fldprd(m,it)
133c138
< c       write(60,rec=iw) vrfy(m,it)
---
>         write(60,rec=iw) vrfy(m,it)
160c165
<       do id=1,ndec-3
---
>       do id=1,2
170,171c175
< c
<       do it=1,30  !for 1961-1990
---
>       do it=1,40
174,179c178,179
< c
<       do id=1,ndec-4  !for 1991->(1990+(ndec-4)*10)
<       do k=1,10
<         kt=30+k+(id-1)*10
<         prd2d(i,kt)=prd2d(i,kt)-clmg(id,i)
<       enddo
---
>       do it=41,ntprd
>         prd2d(i,it)=prd2d(i,it)-clmg(2,i)
181,185d180
< c
<       ks=30+(ndec-4)*10+1
<       if(ks.gt.nt) go to 112
<       do k=ks,nt ! to (1990+(ndec-4)*10+1)->current year
<         prd2d(i,k)=prd2d(i,k)-clmg(ndec-3,i)
187,189d181
<  112  continue
< c
<       enddo  !for cd
199,200c191,192
<       call stdv(wk1,30,sdo(i))
<       call stdv(wk2,30,sdp(i))
---
>       call stdv(wk1,30,sdo)
>       call stdv(wk2,30,sdp)
203,204c195,196
<         obsn(i,k)=wmoobs(i,k)/sdo(i)
<         prdn(i,k) = prd2d(i,k)/sdp(i)
---
>         obsn(i,k)=wmoobs(i,k)/sdo
>         prdn(i,k) = prd2d(i,k)/sdp
211,212c203,204
<       call stdv(wk1,30,sdo(i))
<       call stdv(wk2,30,sdp(i))
---
>       call stdv(wk1,30,sdo)
>       call stdv(wk2,30,sdp)
215,221c207,208
<         obsn(i,k)=wmoobs(i,k)/sdo(i)
<         prdn(i,k)=prd2d(i,k)/sdp(i)
<       enddo
< c  have stdv for 81-10
<       do k=1,30
<         wk1(k)=wmoobs(i,k+20)
<         wk2(k)=prd2d(i,k+20)
---
>         obsn(i,k)=wmoobs(i,k)/sdo
>         prdn(i,k)=prd2d(i,k)/sdp
223,224d209
<       call stdv(wk1,30,sdo(i))
<       call stdv(wk2,30,sdp(i))
235,236c220,221
< c     write(20,rec=it) obs
< c     write(25,rec=it) prd
---
>       write(20,rec=it) obs
>       write(25,rec=it) prd
245c230
< c       write(50,rec=it) prd
---
>         write(50,rec=it) prd
247,248c232,233
< c
< c== have hss time series
---
> c    
> c== have Heidke skill
264,269c249
< c
<       do i=1,imax
<         iobs(i,k)=iwk3(i)
<         iprd(i,k)=iwk4(i)
<       enddo
< c
---
>         
275,278c255
< c
<       enddo  !over year k
< c
<       write(6,*) 'avg_hs=',avghs
---
>       enddo
281,292c258
<       write(16,rec=it) r1d1(it)
<       enddo
< c
< c== have hss map
< c
<       nss=ntprd-30
<       do i=1,imax
<         do k=1,nss
<           i1d1(k)=iobs(i,k)
<           i1d2(k)=iprd(i,k)
<         enddo
<         call heidke(i1d1,i1d2,h,hsmap(i),nss)
---
>       write(40,rec=it) r1d1(it)
294c260,261
<       write(6,*) 'hss map=',hsmap
---
> 
>       write(6,*) 'avg_hs=',avghs
296c263
<       do it=1,ntprd-30
---
>       do it=1,20
325a293,303
>       
>       stop
>       end
>         
> 
>       subroutine season_mean(fld,nyear,mons,nmax,out)
> CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
> C. calculate seasonal mean of 102 cd data
> C===========================================================
>       real fld(nmax,nyear,12)
>       real clim(nmax,12),out(nmax,nyear-1)
327c305,309
< c== for real time forecast
---
>       IF(mons.eq.12) THEN
> 
>       m1=12
>       m2=1
>       m3=2
329,337c311,314
<       do m=1,mmax
<       call opt_k(fld2D,kk(m),acx(m),ltime,ntprd,mmax,kp,ltime,m) !fld2D from line 119
<       enddo
<       do m=1,mmax
<          avg=0
<          do k=ltime-kk(m)+1,ltime
<          avg=avg+fld2D(m,k)/float(kk(m))
<          end do
<          pcprd(m)=avg
---
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny+1,m2)+fld(i,ny+1,m3))/3.
>         enddo
338a316,317
> 
>       ELSE IF (mons.eq.11) THEN
340,345c319,322
<       do i=1,imax
<         rtprd(i)=0.
<       do m=1,mmax
<         rtprd(i)=rtprd(i)+pcprd(m)*eof(i,m)
<       enddo
<       enddo
---
> 
>       m1=11
>       m2=12
>       m3=1
347,348c324,327
<       do i=1,imax
<         rtprd(i)=rtprd(i)-clmg(ndec-3,i)
---
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny,m2)+fld(i,ny+1,m3))/3.
>         enddo
350,351c329,339
<       do i=1,imax
<         rtprdn(i)=rtprd(i)/sdp(i)
---
> c
>       ELSE
> 
>       m1=mons      !m1=1 -> JFM;
>       m2=m1+1
>       m3=m2+1
> c
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny,m2)+fld(i,ny,m3))/3.
>         enddo
353,365c341,347
<       write(6,*) 'rtprd=',rtprd
<       write(6,*) 'rtprdn=',rtprdn
< c write out prd and hsmap
<       call CD102_2_2x2(rtprd,wk22)
<       write(15,rec=1) wk22
<       call CD102_2_2x2(rtprdn,wk22)
<       write(15,rec=2) wk22
<       call CD102_2_2x2(hsmap,wk22)
<       write(15,rec=3) wk22
<       
<       stop
<       end
<         
---
> 
>       END IF
> c
>       return
>       END
> c
> 
503c485
<       do i=1,ncd 
---
>       do i=1,ncd
508,509d489
< c     write(6,100)h,ss,j,j1,m,tot 
< 100   format(1h ,2f6.1,3i5,f6.0) 
600c580
<       subroutine season_anom(fld,nyear,ltime,mons,nmax,out)
---
>       subroutine season_anom(fld,nyear,mons,nmax,out)
605c585
<       real clim(nmax,12),out(nmax,ltime)
---
>       real clim(nmax,12),out(nmax,nyear-1)
609c589
<       do ny=1,ltime
---
>       do ny=1,nyear-1
624c604
<       do ny=1,ltime
---
>       do ny=1,nyear-1
638c618
<       do ny=1,ltime
---
>       do ny=1,nyear-1
651c631
<       do ny=1,ltime
---
>       do ny=1,nyear-1
661a642,722
> 
>       subroutine season_anom2(fld,nytot,nyear,mons,nmax,out)
> CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
> C. calculate seasonal anom & clim of 102 cd data
> C===========================================================
>       real fld(nmax,nytot,12)
>       real clim(nmax,12),out(nmax,nyear-1)
> c
>       call setzero(clim,nmax,12)
>       do m=1,12
>       do ny=1,nyear-1
>         do i=1,nmax
>          clim(i,m)=clim(i,m)+fld(i,ny,m)/float(nyear-1)
>         enddo
>       end do
>       end do
> c
> c have seasonal mean
> c
>       IF(mons.eq.12) THEN
> 
>       m1=12
>       m2=1
>       m3=2
> c
> c for history
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny+1,m2)+fld(i,ny+1,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
>       enddo
> c for target year
>         do i=1,nmax
>       out(i,nyear)=(fld(i,nyear,m1)+fld(i,nyear+1,m2)+fld(i,nyear+1,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
> 
>       ELSE IF (mons.eq.11) THEN
> c
> 
>       m1=11
>       m2=12
>       m3=1
> c
> c for history
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny,m2)+fld(i,ny+1,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
>       enddo
> c for target year
>         do i=1,nmax
>       out(i,nyear)=(fld(i,nyear,m1)+fld(i,nyear,m2)+fld(i,nyear+1,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
> c
>       ELSE
> 
>       m1=mons      !m1=1 -> JFM;
>       m2=m1+1
>       m3=m2+1
> c
> c for history
>       do ny=1,nyear-1
>         do i=1,nmax
>         out(i,ny)=(fld(i,ny,m1)+fld(i,ny,m2)+fld(i,ny,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
>       enddo
> c for target year
>         do i=1,nmax
>       out(i,nyear)=(fld(i,nyear,m1)+fld(i,nyear,m2)+fld(i,nyear,m3)-
>      &         (clim(i,m1)+clim(i,m2)+clim(i,m3)))/3.
>         enddo
> 
>       END IF
> c
>       return
>       END
835d895
<       if(ks.gt.nt) go to 111
842c902
<  111  return
---
>       return
