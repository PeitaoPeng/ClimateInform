#!/bin/sh

set -eaux
#cccccccccccccccccccccccccccccccccccccccccccccccccccccccc
# have seasonal clim and anom of AMIP esm
#ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
 
lcdir=/cpc/home/wd52pp/project/ca_proj/data_proc
tmp=/cpc/home/wd52pp/tmp
if [ ! -d $tmp ] ; then
  mkdir -p $tmp
fi

datain=/cpc/home/tzhang/FY23proj/FV3AMIP_SST
dataout=/cpc/home/wd52pp/data/ca_proj
maskdir=/cpc/home/wd52pp/utility/mask/
#
cd $tmp
#
var=sst

filein=FV3AMIP_monthly_mean_sst_194712-202205
fileout=FV3amip.$var.3mon_anom.jfm1979-mam2022
ybgn=1979
yend=2022
totyr=`expr $yend - 1948`
totmo=`expr $totyr \* 12 + 1 + 5`

#=======================================
# rewrite hgt
#=======================================
tmax=$totmo # from jan1979
clm_bgn=373  #jan1979
clm_end=$tmax
nts=375  # feb1979
nte=`expr $tmax - 1` # mid-mon of the latest season

cat >masksst<<EOF
run havesst.gs
EOF
#
cat >havesst.gs<<EOF
'reinit'
'open  $datain/$filein.ctl'
'open $maskdir/landsea.mask.360x180.ctl'
'set gxout fwrite'
'set fwrite maskedsst.gr'
'set x 1 360'
'set y 1 180'
'set t 1 $totmo'
'd maskout(sst,land.2(time=jan1949)-100)'
'c'
EOF
#
grads -bl <masksst
#
cat>maskedsst.ctl<<EOF
dset ^maskedsst.gr
UNDEF 9.999e+20
TITLE AMIP
TITLE GFSFV3amip 2D data
XDEF 360 LINEAR 0.5 1.
YDEF 180 LINEAR -89.5 1.
ZDEF   1 levels 1
TDEF 999 LINEAR dec1947  1mon
VARS 1
$var 0 99  $var
ENDVARS
EOF

cat >havedata<<EOF
run anom.gs
EOF

cat >anom.gs<<EOF
'reinit'
'open $datain/$filein.ctl'
'set x 1 360'
'set y 1 180'
'set t 1 12'
*anom wrt clim over 1979-2021
'define clm=ave($var,t+$clm_bgn, t=$clm_end,1yr)'
*anom wrt clim
'modify clm seasonal'
'set gxout fwrite'
'set fwrite $fileout.gr'
'set t $nts $nte'
'd ave($var-clm,t-1,t+1)'
'c'
EOF
#
grads -bl <havedata
#
cat>$fileout.ctl<<EOF
dset ^$fileout.gr
UNDEF 9.999e+20
TITLE AMIP
TITLE GFSFV3amip 2D data
XDEF 360 LINEAR 0.5 1.
YDEF 180 LINEAR -89.5 1.
ZDEF   1 levels 1
TDEF 999 LINEAR feb1979  1mon
VARS 1
$var 0 99  $var
ENDVARS
EOF

mv $fileout.* $dataout
#
