#!/bin/sh

set -eaux

lcdir=/cpc/home/wd52pp/project/ca_prd/wk34/data_proc
tmp=/cpc/home/wd52pp/tmp/test
datadir=/cpc/home/wd52pp/data/ca_prd
#
years=1979
yeare=2014
totyr=`expr $yeare - $years + 1`  # totyear of data available
intyr=`expr $totyr - 1`  # full year number
#cyrwks=23                # pent number of current year
cyrwks=52                # pent number of current year
totpen=`expr $intyr \* 52 + $cyrwks`

cd $tmp
#
xdim=144
ydim=73
undef=-999000000

infile=$datadir/wk.sata.1979-curr
outfile1=wk.sata.1979-curr.detrd
outfile2=wk.sata.1979-curr.trend
outfile3=wk.sata_a_b.1979-curr

cat>detrend.f<<EOF
      program main
      parameter(im=$xdim,jm=$ydim)
      parameter(nyr=$totyr)
      parameter(undef=$undef)
      real*4 w1d1(nyr),w1d2(nyr)
      real*4 w1d3(nyr),w1d4(nyr)
      real*4 wk(im,jm),wk2(im,jm)
      real*4 avg(im,jm)
      real*4 wk4d(im,jm,52,nyr)
      real*4 wk4d2(im,jm,52,nyr)
      real*4 wk4d3(im,jm,52,nyr)
      real*4 wk4d4(im,jm,52,nyr)
      real*4 ext1(im,jm,64,nyr-2)
      real*4 ext2(im,jm,64,nyr-2)
      real*4 aa(im,jm,52),bb(im,jm,52)
c
      open(10,
     &file='$infile.gr',
     &access='direct',form='unformatted',recl=im*jm*4)
c
      open(50,
     &file='$outfile1.gr',
     &form='unformatted',access='direct',recl=im*jm*4)
      open(60,
     &file='$outfile2.gr',
     &form='unformatted',access='direct',recl=im*jm*4)
      open(70,
     &file='$outfile3.gr',
     &form='unformatted',access='direct',recl=im*jm*4)
c
c read in weekly data
c
      ir=0
      do iy=1,nyr
      nwk=52
      if(iy.eq.nyr) nwk=$cyrwks
      do ip=1,nwk

      ir=ir+1
      read(10,rec=ir) wk
      do i=1,im
      do j=1,jm
        wk4d(i,j,ip,iy)=wk(i,j)
      enddo
      enddo

      enddo
      enddo
c
c for extended (end of 1st yr to begin of last yr)year_long=nyr-1) array
c
c for the core of the extended array
      do iy=2,nyr-1
      do ip=1,52
      do i=1,im
      do j=1,jm
        ext1(i,j,ip+6,iy-1)=wk4d(i,j,ip,iy)
      enddo
      enddo
      enddo
      enddo
c for the ip=1-6 and ip=59-64
      do iy=2,nyr-1
      do ip=1,6
      do i=1,im
      do j=1,jm
        ext1(i,j,ip,iy-1)=wk4d(i,j,52+ip,iy-1)
        ext1(i,j,58+ip,iy-1)=wk4d(i,j,ip,iy+1)
      enddo
      enddo
      enddo
      enddo
c
c have 13-week (~ 3-mon) avg 
c
      do iy=1,nyr-2
      do ip=1,52
      call wkavg(ext1,nyr-2,64,im,jm,avg,ip,iy)
      do i=1,im
      do j=1,jm
        wk4d2(i,j,ip,iy+1)=avg(i,j)
      enddo
      enddo
      enddo
      enddo
c
c detrend data
c
      do ip=1,52
      do i=1,im
      do j=1,jm

        if(abs(wk4d(i,j,1,1)).lt.100) then

        do iy=1,nyr
          w1d1(iy)=0.
          w1d2(iy)=wk4d(i,j,ip,iy)
        enddo
        do iy=1,nyr-2
          w1d1(iy+1)=wk4d2(i,j,ip,iy)
        enddo
        
        call ltrend_1d(w1d1,w1d2,w1d3,w1d4,nyr,2,nyr-2,
     &aa(i,j,ip),bb(i,j,ip))

        do iy=1,nyr
          wk4d3(i,j,ip,iy)=w1d3(iy)
          wk4d4(i,j,ip,iy)=w1d4(iy)
        enddo

        else

        do iy=1,nyr
          wk4d3(i,j,ip,iy)=undef
          wk4d4(i,j,ip,iy)=undef
        enddo

        aa(i,j,ip)=undef
        bb(i,j,ip)=undef

        endif

      enddo
      enddo
      enddo
c
      iw=0
      nwk=52
      do iy=1,nyr
      if(iy.eq.nyr) nwk=$cyrwks
      do ip=1,nwk
      
      do i=1,im
      do j=1,jm
        wk(i,j)=wk4d3(i,j,ip,iy)
        wk2(i,j)=wk4d4(i,j,ip,iy)
      enddo
      enddo

      iw=iw+1
      write(50,rec=iw) wk
      write(60,rec=iw) wk2
      enddo
      enddo
      write(6,*) 'tot_wk=',iw

c write out a and b
      iw=0
      do ip=1,52
      
      do i=1,im
      do j=1,jm
        wk(i,j)=aa(i,j,ip)
        wk2(i,j)=bb(i,j,ip)
      enddo
      enddo

      iw=iw+1
      write(70,rec=iw) wk
      iw=iw+1
      write(70,rec=iw) wk2
      enddo

      stop
      end

CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C  using least square to have y=a+bx
C  here xin=3-mon avg, xin2=weekly data
C  out=detrended xin2, out2=trend
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
      subroutine ltrend_1d(xin,xin2,out,out2,nt,its,ite,a,b)
      dimension xin(nt),xin2(nt),out(nt),out2(nt)
      real lxx, lxy
c
      xb=0
      yb=0
      do it=its,ite
        xb=xb+float(it)/float(ite-its+1)
        yb=yb+xin(it)/float(ite-its+1)
      enddo
c
      lxx=0.
      lxy=0.
      do it=its,ite
      lxx=lxx+(it-xb)*(it-xb)
      lxy=lxy+(it-xb)*(xin(it)-yb)
      enddo
      b=lxy/lxx
      a=yb-b*xb
c
      do it=1,nt
        out(it)=xin2(it)-b*float(it)-a !detrended
        out2(it)=b*float(it)+a !trend
      enddo
c
      return
      end
c 13-wk avg
      subroutine wkavg(wk,nyr,ime,im,jm,avg,ip,iy)
      dimension wk(im,jm,ime,nyr),avg(im,jm)
c
      do i=1,im
      do j=1,jm
      avg(i,j)=0.
      do ik=1,13
      avg(i,j)=avg(i,j)+wk(i,j,ip-1+ik,iy)/13.
      enddo
      enddo
      enddo

      return
      end
EOF
#
gfortran detrend.f
./a.out
#==========================================
# have ctl for tmp data
#==========================================
#
cat>$outfile1.ctl<<EOF
dset ^$outfile1.gr
undef -999000000
*
TITLE wkly Tsfc
*
xdef 144 linear    0.  2.5
ydef  73 linear  -90.  2.5
zdef 1 linear 1 1
tdef 9999 linear 04jan1979 7dy
vars 1
t  1 99  wkly Tsfc (C)
ENDVARS
EOF
#
cat>$outfile2.ctl<<EOF
dset ^$outfile2.gr
undef -999000000
*
TITLE wkly Tsfc
*
xdef 144 linear    0.  2.5
ydef  73 linear  -90.  2.5
zdef 1 linear 1 1
tdef 9999 linear 04jan1979 7dy
vars 1
t  1 99  wkly Tsfc (C)
ENDVARS
EOF
#
cat>$outfile3.ctl<<EOF
dset ^$outfile3.gr
undef -999000000
*
TITLE wkly Tsfc
*
xdef 144 linear    0.  2.5
ydef  73 linear  -90.  2.5
zdef 1 linear 1 1
tdef 52 linear 04jan1979 7dy
vars 2
a  1 99  a in y=bx+a (C)
b  1 99  b in y=bx+a (C/yr)
ENDVARS
EOF
#
cp $outfile1.* $datadir
cp $outfile2.* $datadir
cp $outfile3.* $datadir
#\rm $tmp/*

