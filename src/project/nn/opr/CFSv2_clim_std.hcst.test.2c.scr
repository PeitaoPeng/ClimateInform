#!/bin/sh

set -eaux
#cccccccccccccccccccccccccccccccccccccccccccccccccccccccc
# have clim and std of 1mon-lead monthly and seasonal MME MEAN HCST data
# update every year around Mar 10
#ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
 
lcdir=/cpc/home/wd52pp/project/nn/opr
tmp=/cpc/consistency/tmp_ann
if [ ! -d $tmp ] ; then
  mkdir -p $tmp
fi
datadir=/cpc/consistency/nn/cfsv2_ww
#
clim=2c # type of clim
yyyyb=1982
yyyye=2020
totyr=`expr $yyyye - $yyyyb + 1`
#
nleadmon=9
nleadss=7
#clmperiod=1991-2020
clmperiod=1982-2010
#
cd $tmp
#
for var in SSHem; do
for icmon in 01 02 03 04 05 06 07 08 09 10 11 12; do
#for icmon in 05; do
#
if [ $icmon = 12 ]; then icmonw=dec; tgtm=jan; fi 
if [ $icmon = 01 ]; then icmonw=jan; tgtm=feb; fi 
if [ $icmon = 02 ]; then icmonw=feb; tgtm=mar; fi 
if [ $icmon = 03 ]; then icmonw=mar; tgtm=apr; fi 
if [ $icmon = 04 ]; then icmonw=apr; tgtm=may; fi 
if [ $icmon = 05 ]; then icmonw=may; tgtm=jun; fi 
if [ $icmon = 06 ]; then icmonw=jun; tgtm=jul; fi 
if [ $icmon = 07 ]; then icmonw=jul; tgtm=aug; fi 
if [ $icmon = 08 ]; then icmonw=aug; tgtm=sep; fi 
if [ $icmon = 09 ]; then icmonw=sep; tgtm=oct; fi 
if [ $icmon = 10 ]; then icmonw=oct; tgtm=nov; fi 
if [ $icmon = 11 ]; then icmonw=nov; tgtm=dec; fi 
#
for tp in mon ss; do
#for tp in ss; do

if [ $tp = 'mon' ]; then nlead=$nleadmon; fi
if [ $tp = 'ss' ];  then nlead=$nleadss; fi

nread=`expr $totyr \* $nlead`
nread2=`expr 30 \* $nlead`
#
#=======================================
# regrid to 2.5x2.5
#=======================================
imx2=144
jmx2=73
#
cat >int<<fEOF
reinit
run regrid.gs
fEOF

cat >regrid.gs<<gsEOF
'reinit'
'open $datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.ctl'
'open /cpc/home/wd52pp/project/nn/nmme/data_proc/land.2.5x2.5.ctl'
'set gxout fwrite'
'set fwrite $datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.2.5x2.5.gr'
nt=1
while ( nt <= $nread)

'set t 'nt
say 'time='nt
'set lon   0. 357.5'
'set lat -90.  90.'
'd lterp(f,land.2(time=feb1982))'

nt=nt+1
endwhile
gsEOF
#
/usr/local/bin/grads -pb <int
#
cat>$datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.2.5x2.5.ctl<<EOF
dset ^CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.2.5x2.5.gr
undef -9.99E+8
*
options little_endian
*
XDEF 144 LINEAR    0.  2.5
YDEF  73 LINEAR  -90.  2.5
zdef  01 levels 1
tdef   9999 linear feb1982 1mo
*
VARS 1
f    0 99   ss or mon ave
ENDVARS
EOF
#
#=======================================
# clm_std
#=======================================
#yr_skip=`expr 1990 - 1981`  # skip 1982-1990 for clim of 1991-2020
yr_skip=0  # no skip for clim of 1982-2011
nyr1=17 # length of 1st period of clm
nyr2=12 # length of 2nd period of clm

clm_s1=`expr $yr_skip \* $nlead + 1` # mon_start for 1st clim
clm_e1=`expr $clm_s1 + $nyr1 \* $nlead - 1` # mon_end for 1st clim
clm_s2=`expr $clm_e1 + 1` # mon_start for clim
clm_e2=`expr $clm_s2 + $nyr2 \* $nlead - 1` # mon_end for clim

cat >clm_std<<EOF
run read_write.gs
EOF
#
cat >read_write.gs<<EOF
'reinit'
'open $datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.2.5x2.5.ctl'
'set gxout fwrite'
'set fwrite $datadir/CFSv2.$var.$tp.clim_std.${icmonw}_ic.$clmperiod.ld1-$nlead.esm.$clim.gr'
'set x 1 $imx2'
'set y 1 $jmx2'
it1=$clm_s1
it2=$clm_s2
ld=1
while ( ld <= $nlead)
'define clm1=ave(f,t='it1',t=$clm_e1,$nlead)'
'define clm2=ave(f,t='it2',t=$clm_e2,$nlead)'
'define std1=sqrt(ave((f-clm1)*(f-clm1),t='it1',t=$clm_e1,$nlead))'
'define std2=sqrt(ave((f-clm2)*(f-clm2),t='it2',t=$clm_e2,$nlead))'
'd clm1'
'd std1'
'd clm2'
'd std2'
it1=it1+1
it2=it2+1
ld=ld+1
endwhile
EOF
#
grads -bl <clm_std
#
cat>CFSv2.$var.$tp.clim_std.${icmonw}_ic.$clmperiod.ld1-$nlead.esm.$clim.ctl<<EOF
dset ^CFSv2.$var.$tp.clim_std.${icmonw}_ic.$clmperiod.ld1-$nlead.esm.$clim.gr
undef -9.99e+8
*
TITLE fcst
*
XDEF 144 LINEAR    0.  2.5
YDEF  73 LINEAR  -90.  2.5
zdef  01 levels 1
tdef  $nlead linear feb1982 1mo
vars 4
clm1 1 99 over 30-yrs
std1 1 99 over 30-yrs
clm2 1 99 over 30-yrs
std2 1 99 over 30-yrs
ENDVARS
EOF
#
mv CFSv2.$var.*.clim* $datadir
#

cat >anom<<EOF
run anom.gs
EOF
cat >anom.gs<<EOF
'reinit'
'open $datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.2.5x2.5.ctl'
'open $datadir/CFSv2.$var.$tp.clim_std.${icmonw}_ic.$clmperiod.ld1-$nlead.esm.$clim.ctl'
'set gxout fwrite'
'set fwrite CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.anom.$clim.gr'
'set x 1 $imx2'
'set y 1 $jmx2'
nye1=$nyr1
nye2=$totyr
nld=$nlead
*
iy=1
ir=1
while ( iy <= nye1)
ld=1
while ( ld <= nld)
'set t 'ir''
'd f-clm1.2(t='ld')'
ld=ld+1
ir=ir+1
endwhile
iy=iy+1
endwhile
*
iy=nye1+1
ir=nye1*nld+1
while ( iy <= nye2)
ld=1
while ( ld <= nld)
'set t 'ir''
'd f-clm2.2(t='ld')'
ld=ld+1
ir=ir+1
endwhile
iy=iy+1
endwhile
EOF
#
grads -bl <anom
#
cat>$datadir/CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.anom.$clim.ctl<<EOF
dset ^CFSv2.$var.$tp.${icmonw}_ic.1982-$yyyye.ld1-$nlead.esm.anom.$clim.gr
undef -9.99e+8
*
TITLE fcst
*
XDEF 144 LINEAR    0.  2.5
YDEF  73 LINEAR  -90.  2.5
zdef  $nlead LINEAR 1 1
tdef  999 linear ${tgtm}1982 1yr
vars 1
f $nlead 99 lead1-$nlead
ENDVARS
EOF
mv CFSv2.$var.* $datadir
#
done  # tp loop
done  # icmon loop
done  # var loop
