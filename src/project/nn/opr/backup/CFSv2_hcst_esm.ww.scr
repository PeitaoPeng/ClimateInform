#!/bin/sh

set -eaux
#cccccccccccccccccccccccccccccccccccccccccccccccccccccccc
# process WW's CFSv2 data
#ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
 
lcdir=/cpc/home/wd52pp/project/nn/opr
tmp=/cpc/home/wd52pp/tmp
if [ ! -d $tmp ] ; then
  mkdir -p $tmp
fi

var=SSHem  # or SSTem
datain=/cpc/consistency/nn/CFSv2$var
dataout=/cpc/consistency/nn/cfsv2_ww
#
cd $tmp
#
nleadmon=9
nleadss=7
conv=1
if [ $var = prate ]; then conv=86400; fi

for model in CFSv2; do
for icmon in 01 02 03 04 05 06 07 08 09 10 11 12; do
#for icmon in 09; do
#
if [ $icmon = 01 ]; then tmon=feb; tseason=fma; icmonw=jan; fi 
if [ $icmon = 02 ]; then tmon=mar; tseason=mam; icmonw=feb; fi 
if [ $icmon = 03 ]; then tmon=apr; tseason=amj; icmonw=mar; fi 
if [ $icmon = 04 ]; then tmon=may; tseason=mjj; icmonw=apr; fi 
if [ $icmon = 05 ]; then tmon=jun; tseason=jja; icmonw=may; fi 
if [ $icmon = 06 ]; then tmon=jul; tseason=jas; icmonw=jun; fi 
if [ $icmon = 07 ]; then tmon=aug; tseason=aso; icmonw=jul; fi 
if [ $icmon = 08 ]; then tmon=sep; tseason=son; icmonw=aug; fi 
if [ $icmon = 09 ]; then tmon=oct; tseason=ond; icmonw=sep; fi 
if [ $icmon = 10 ]; then tmon=nov; tseason=ndj; icmonw=oct; fi 
if [ $icmon = 11 ]; then tmon=dec; tseason=djf; icmonw=nov; fi 
if [ $icmon = 12 ]; then tmon=jan; tseason=jfm; icmonw=dec; fi 
#
yend=2020
yyyy=1982
while [ $yyyy -le $yend ]; do

cat >have_data<<EOF
run read_write.gs
EOF

cat >read_write.gs<<EOF
'reinit'
'open $datain/CFSv2$var.ctl'
'set x 1 360'
'set y 1 181'
nze1=$nleadmon
nze2=$nleadss
'set gxout fwrite'
'set fwrite $var$yyyy.mon.gr'
'set time $tmon$yyyy'
nz=1
while ( nz <= nze1)
'set z 'nz
say 'nz='nz
'd ${var}*$conv'
nz=nz+1
endwhile
'disable fwrite'
*
'set gxout fwrite'
'set fwrite $var$yyyy.ss.gr'
'set time $tmon$yyyy'
nz=1
while ( nz <= nze2)
'set z 'nz
nzend=nz+2
say 'nzend='nzend
'define ss=ave($var,z='nz',z='nzend')'
'd ss*$conv'
nz=nz+1
endwhile
EOF
#
grads -bl <have_data
#
cat>$var$yyyy.mon.ctl<<EOF
dset ^$var$yyyy.mon.gr
undef -9.99e+08
*
TITLE fcst
*
xdef  360 linear    0.  1.
ydef  181 linear  -90   1.
zdef    1 linear 1 1
tdef    $nleadmon linear jan1982 1mo
vars 1
f 1 99 1_mon lead
ENDVARS
EOF
#
cat>$var$yyyy.ss.ctl<<EOF
dset ^$var$yyyy.ss.gr
undef -9.99e+08
*
TITLE fcst
*
xdef  360 linear    0.  1.
ydef  181 linear  -90   1.
zdef    1 linear 1 1
tdef    $nleadss linear jan1982 1mo
vars 1
f 1 99 1_mon lead
ENDVARS
EOF
#
yyyy=`expr $yyyy + 1`
done  # yyyy loop

#======================================
# cat files together
#======================================
mv ${var}1982.mon.gr tm.1982
mv ${var}1982.ss.gr ts.1982
yy=1983
while [ $yy -le $yend ]
do

yym=`expr $yy - 1`

cat tm.$yym $var$yy.mon.gr > tm.$yy
cat ts.$yym $var$yy.ss.gr > ts.$yy

\rm tm.$yym
\rm ts.$yym

yy=`expr $yy + 1`
done

mv tm.$yend $dataout/$model.$var.mon.${icmonw}_ic.1982-${yend}.ld1-$nleadmon.esm.gr
mv ts.$yend $dataout/$model.$var.ss.${icmonw}_ic.1982-${yend}.ld1-$nleadss.esm.gr

cat>$dataout/$model.$var.ss.${icmonw}_ic.1982-${yend}.ld1-$nleadss.esm.ctl<<EOF
dset ^$model.$var.ss.${icmonw}_ic.1982-${yend}.ld1-$nleadss.esm.gr
undef -9.99e+08
*
TITLE fcst
*
xdef  360 linear    0.  1.
ydef  181 linear  -90   1.
zdef    1 linear 1 1
tdef  999 linear jan1982 1mon
vars 1
f 1 99 lead1-$nleadss
ENDVARS
EOF
#
cat>$dataout/$model.$var.mon.${icmonw}_ic.1982-${yend}.ld1-$nleadmon.esm.ctl<<EOF
dset ^$model.$var.mon.${icmonw}_ic.1982-${yend}.ld1-$nleadmon.esm.gr
undef -9.99e+08
*
TITLE fcst
*
xdef  360 linear    0.  1.
ydef  181 linear  -90   1.
zdef    1 linear 1 1
tdef  999 linear jan1982 1mon
vars 1
f 1 99 lead1-$nleadmon
ENDVARS
EOF
#
done  # ic_mon loop
#
done  # model loop
#

