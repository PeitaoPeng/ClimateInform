#!/bin/sh

set -eaux

lcdir=/cpc/home/wd52pp/project/prd_test/eeof
tmp=/cpc/home/wd52pp/tmp
datain=/cpc/home/wd52pp/data/LF_prd
datadir=/cpc/home/wd52pp/data/prd_test
#
#key parameters
long_in_time=82
lagged_numbers=3
long_real=82   # =long_in_time/sample_interval
ntime=`expr $long_real - $lagged_numbers + 1`
id=0 # ID=0: covariance matrix; ID>0:correlation matrix
mrot=9

cd $tmp
/bin/rm *.*
cp $lcdir/eeof_102cd.one_ss.f $tmp/eeof.f
cp $lcdir/reof.s.f $tmp/.
cp $lcdir/CD102_2_2x2.s.f $tmp/.

for season in djf; do
#
if [ "$season" = jfm ]; then mons=1; fi
if [ "$season" = fma ]; then mons=2; fi
if [ "$season" = mam ]; then mons=3; fi
if [ "$season" = amj ]; then mons=4; fi
if [ "$season" = mjj ]; then mons=5; fi
if [ "$season" = jja ]; then mons=6; fi
if [ "$season" = jas ]; then mons=7; fi
if [ "$season" = aso ]; then mons=8; fi
if [ "$season" = son ]; then mons=9; fi
if [ "$season" = ond ]; then mons=10; fi
if [ "$season" = ndj ]; then mons=11; fi
if [ "$season" = djf ]; then mons=12; fi
#
cat > parm.h << eof
       parameter(ltime=$long_in_time)
       parameter(iseason=$mons)
       parameter(ml=$lagged_numbers)
       parameter(lreal=$long_real)
       parameter(nfld=$ntime)
       parameter(ID=$id)
       parameter(nmod=$mrot)
eof
#
gfortran -o eeof.x eeof.f reof.s.f CD102_2_2x2.s.f
echo "done compiling"

#
 ln -s $datain/temp_102.txt fort.10
 ln -s $datadir/eeof_constructed_temp_102cd.$season.1931-curr.gr      fort.70

ln -s $datadir/eeoft.temp_102cd.$season.1931-curr.gr   fort.50
ln -s $datadir/eeofs.temp_102cd.$season.1931-curr.gr   fort.55
ln -s $datadir/reeoft.temp_102cd.$season.1931-curr.gr  fort.60
ln -s $datadir/reeofs.temp_102cd.$season.1931-curr.gr  fort.65
#
eeof.x > $datadir/eeof.temp_102cd.$season.1931-curr.out
#
cat>$datadir/eeofs.temp_102cd.$season.1931-curr.ctl<<EOF
dset ^eeofs.temp_102cd.$season.1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF 9999 LINEAR FEB1931 1mon
*
vars  10
c1     1 99 corr of eeof
r1     1 99 regr of eeof
c2     1 99 corr of eeof
r2     1 99 regr of eeof
c3     1 99 corr of eeof
r3     1 99 regr of eeof
c4     1 99 corr of eeof
r4     1 99 regr of eeof
c5     1 99 corr of eeof
r5     1 99 regr of eeof
endvars
EOF
#
cat>$datadir/reeofs.temp_102cd.$season.1931-curr.ctl<<EOF2
dset ^reeofs.temp_102cd.$season.1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF 9999 LINEAR FEB1931 1mon
*
vars  10
c1     1 99 corr of eeof
r1     1 99 regr of eeof
c2     1 99 corr of eeof
r2     1 99 regr of eeof
c3     1 99 corr of eeof
r3     1 99 regr of eeof
c4     1 99 corr of eeof
r4     1 99 regr of eeof
c5     1 99 corr of eeof
r5     1 99 regr of eeof
endvars
EOF2
#
cat>$datadir/eeoft.temp_102cd.$season.1931-curr.ctl<<EOF3
dset ^eeoft.temp_102cd.$season.1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
XDEF   $ntime LINEAR  0.  1
YDEF   1 LINEAR  -90.  2.5
ZDEF   1 LINEAR 1 1.
TDEF 9999 LINEAR FEB900 1mon
*
vars   9
pc1    1 99 pc of eeof1
pc2    1 99 pc of eeof2
pc3    1 99 pc of eeof3
pc4    1 99 pc of eeof4
pc5    1 99 pc of eeof5
pc6    1 99 pc of eeof5
pc7    1 99 pc of eeof5
pc8    1 99 pc of eeof5
pc9    1 99 pc of eeof5
endvars
EOF3
#
cat>$datadir/reeoft.temp_102cd.$season.1931-curr.ctl<<EOF4
dset ^reeoft.temp_102cd.$season.1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
XDEF   $ntime LINEAR  0.  1
YDEF   1 LINEAR  -90.  2.5
ZDEF   1 LINEAR 1 1.
TDEF 9999 LINEAR FEB1931 1mon
*
vars   9
pc1    1 99 pc of eeof1
pc2    1 99 pc of eeof2
pc3    1 99 pc of eeof3
pc4    1 99 pc of eeof4
pc5    1 99 pc of eeof5
pc6    1 99 pc of eeof5
pc7    1 99 pc of eeof5
pc8    1 99 pc of eeof5
pc9    1 99 pc of eeof5
endvars
EOF4
#
cat>$datadir/eeof_constructed_temp_102cd.$season.1931-curr.ctl<<EOF
dset ^eeof_constructed_temp_102cd.$season.1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF 9999 LINEAR feb1931 1mon
*
vars  3
obs    1 99 obs
con1    1 99 with classical eeof
con2    1 99 with rotated eeof
endvars
EOF
#
done
