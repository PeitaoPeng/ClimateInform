#!/bin/sh

set -eaux

lcdir=/cpc/home/wd52pp/project/prd_test/eeof
tmp=/cpc/home/wd52pp/tmp
datadir=/cpc/home/wd52pp/data/prd_test
#
#key parameters
long_in_time=987
sample_interval=1
lagged_numbers=13
long_real=987   # =long_in_time/sample_interval
ntime=`expr $long_real - $lagged_numbers + 1`
skip=0
id=0 # ID=0: covariance matrix; ID>0:correlation matrix
mrot=7

cd $tmp
/bin/rm *.*
cp $lcdir/eeof_102cd.f $tmp/eeof.f
cp $lcdir/reof.s.f $tmp/.
cp $lcdir/CD102_2_2x2.s.f $tmp/.

#
cat > parm.h << eof
       parameter(ltime=$long_in_time)
       parameter(itdel=$sample_interval)
       parameter(ml=$lagged_numbers)
       parameter(lreal=$long_real)
       parameter(nfld=$ntime)
       parameter(ID=$id)
       parameter(iskip=$skip)
       parameter(nmod=$mrot)
eof
#
gfortran -o eeof.x eeof.f reof.s.f CD102_2_2x2.s.f
echo "done compiling"

#
 ln -s $datadir/temp_102.jfm1931-mam2013.gr fort.10
 ln -s $datadir/eeof_constructed_temp_102cd.jfm1931-curr.gr      fort.70

ln -s $datadir/eeoft.temp_102cd.jfm1931-curr.gr   fort.50
ln -s $datadir/eeofs.temp_102cd.jfm1931-curr.gr   fort.55
ln -s $datadir/reeoft.temp_102cd.jfm1931-curr.gr  fort.60
ln -s $datadir/reeofs.temp_102cd.jfm1931-curr.gr  fort.65
#
eeof.x > $datadir/eeof.temp_102cd.jfm1931-curr.out
#
cat>$datadir/eeofs.temp_102cd.jfm1931-curr.ctl<<EOF
dset ^eeofs.temp_102cd.jfm1931-curr.gr
*options big_endian
UNDEF  -999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF -9999.0 LINEAR FEB1931 1mon
*
vars  26
c1     1 99 corr of eeof
r1     1 99 regr of eeof
c2     1 99 corr of eeof
r2     1 99 regr of eeof
c3     1 99 corr of eeof
r3     1 99 regr of eeof
c4     1 99 corr of eeof
r4     1 99 regr of eeof
c5     1 99 corr of eeof
r5     1 99 regr of eeof
c6     1 99 corr of eeof
r6     1 99 regr of eeof
c7     1 99 corr of eeof
r7     1 99 regr of eeof
c8     1 99 corr of eeof
r8     1 99 regr of eeof
c9     1 99 corr of eeof
r9     1 99 regr of eeof
c10     1 99 corr of eeof
r10     1 99 regr of eeof
c11     1 99 corr of eeof
r11     1 99 regr of eeof
c12     1 99 corr of eeof
r12     1 99 regr of eeof
c13     1 99 corr of eeof
r13     1 99 regr of eeof
endvars
EOF
#
cat>$datadir/reeofs.temp_102cd.jfm1931-curr.ctl<<EOF2
dset ^reeofs.temp_102cd.jfm1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF 9999 LINEAR FEB1931 1mon
*
vars  26
c1     1 99 corr of eeof
r1     1 99 regr of eeof
c2     1 99 corr of eeof
r2     1 99 regr of eeof
c3     1 99 corr of eeof
r3     1 99 regr of eeof
c4     1 99 corr of eeof
r4     1 99 regr of eeof
c5     1 99 corr of eeof
r5     1 99 regr of eeof
c6     1 99 corr of eeof
r6     1 99 regr of eeof
c7     1 99 corr of eeof
r7     1 99 regr of eeof
c8     1 99 corr of eeof
r8     1 99 regr of eeof
c9     1 99 corr of eeof
r9     1 99 regr of eeof
c10     1 99 corr of eeof
r10     1 99 regr of eeof
c11     1 99 corr of eeof
r11     1 99 regr of eeof
c12     1 99 corr of eeof
r12     1 99 regr of eeof
c13     1 99 corr of eeof
r13     1 99 regr of eeof
endvars
EOF2
#
cat>$datadir/eeoft.temp_102cd.jfm1931-curr.ctl<<EOF3
dset ^eeoft.temp_102cd.jfm1931-curr.gr
*options big_endian
UNDEF  -999.0
TITLE SST EOF
XDEF   $ntime LINEAR  0.  1
YDEF   1 LINEAR  -90.  2.5
ZDEF   1 LINEAR 1 1.
TDEF 9999 LINEAR FEB900 1mon
*
vars  7
pc1    1 99 pc of eeof1
pc2    1 99 pc of eeof2
pc3    1 99 pc of eeof3
pc4    1 99 pc of eeof4
pc5    1 99 pc of eeof5
pc6    1 99 pc of eeof5
pc7    1 99 pc of eeof5
endvars
EOF3
#
cat>$datadir/reeoft.temp_102cd.jfm1931-curr.ctl<<EOF4
dset ^reeoft.temp_102cd.jfm1931-curr.gr
*options big_endian
UNDEF  -999.0
TITLE SST EOF
XDEF   $ntime LINEAR  0.  1
YDEF   1 LINEAR  -90.  2.5
ZDEF   1 LINEAR 1 1.
TDEF 9999 LINEAR FEB1931 1mon
*
vars  7
pc1    1 99 pc of eeof1
pc2    1 99 pc of eeof2
pc3    1 99 pc of eeof3
pc4    1 99 pc of eeof4
pc5    1 99 pc of eeof5
pc6    1 99 pc of eeof5
pc7    1 99 pc of eeof5
endvars
EOF4
#
cat>$datadir/eeof_constructed_temp_102cd.jfm1931-curr.ctl<<EOF
dset ^eeof_constructed_temp_102cd.jfm1931-curr.gr
*options big_endian
UNDEF  -9999.0
TITLE SST EOF
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
ZDEF 1 LINEAR 1 1.
TDEF 9999 LINEAR feb1931 1mon
*
vars  3
obs    1 99 obs
con1    1 99 with classical eeof
con2    1 99 with rotated eeof
endvars
EOF
#
