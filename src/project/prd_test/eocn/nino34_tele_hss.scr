#!/bin/sh

set -eaux

lcdir=/export/hobbes/wd52pp/project/prd_skill
tmp=/export/hobbes/wd52pp/tmp
datadir=/export-12/cacsrv1/wd52pp/prd_skill
#
#var=temp
var=prec
#
last_yr=2009
longtime=79
ntprd=49  # ntprd=longtime-30
model=nino34  # linear regression of Nino34 to CONUS temp
#
cp $lcdir/nino34_tele_hss.f $tmp/nino34.f
cp $lcdir/CD102_2_2x2.s.f $tmp/CD102_2_2x2.s.f
cp $lcdir/reof.s.f $tmp/reof.s.f
cd $tmp
#
 for season in jfm fma mam amj mjj jja jas aso son ond ndj djf; do
#for season in jfm; do
#
if [ "$season" = jfm ]; then mons=1; fi
if [ "$season" = fma ]; then mons=2; fi
if [ "$season" = mam ]; then mons=3; fi
if [ "$season" = amj ]; then mons=4; fi
if [ "$season" = mjj ]; then mons=5; fi
if [ "$season" = jja ]; then mons=6; fi
if [ "$season" = jas ]; then mons=7; fi
if [ "$season" = aso ]; then mons=8; fi
if [ "$season" = son ]; then mons=9; fi
if [ "$season" = ond ]; then mons=10; fi
if [ "$season" = ndj ]; then mons=11; fi
if [ "$season" = djf ]; then mons=12; fi
#
cat > parm.h << eof
       parameter(ltime=$longtime)
       parameter(imax=102)
       parameter(ntprd=$ntprd)
       parameter(iseason=$mons)
       parameter(ndx=36,ndy=19)
       parameter(ndec=5) !# of wmo clim for the whole data length
       parameter(nys=1)  ! starting year of data
       parameter(mmax=10) ! cut off eof modes
eof
#
f77 -o nino34.x CD102_2_2x2.s.f reof.s.f nino34.f
echo "done compiling"
#
/bin/rm $tmp/fort.*         
#
 ln -s /export-12/cacsrv1/wd52pp/LF_prd/${var}_102.txt                     fort.10
 ln -s /export-12/cacsrv1/wd52pp/obs/sst/nino34.mon.jan1931-may2010.gr     fort.11
#
 ln -s $datadir/wmoobs_${var}.$season.1991-$last_yr.i3e                    fort.20
 ln -s $datadir/${model}prd_${var}.$season.1991-$last_yr.i3e               fort.25
 ln -s $datadir/${model}prd_hss_${var}.$season.1991-$last_yr.gr            fort.40
 ln -s $datadir/${model}prd_${var}.$season.1991-$last_yr.non-norm.gr       fort.50
 ln -s $datadir/acc_rms.${model}_regr.${var}.$season.1991-$last_yr.gr      fort.60
 ln -s $datadir/regr_corr.${model}_2_${var}.$season.1991-$last_yr.2x2.gr       fort.61
#
nino34.x > $datadir/${model}prd_hss.$season.out
#
cat>$datadir/${model}prd_hss_${var}.$season.1991-$last_yr.ctl<<EOF
dset $datadir/${model}prd_hss_${var}.$season.1991-$last_yr.gr
undef 999.0
title Realtime Surface Obs
xdef    1 linear    0.000  1
ydef    1 linear    0.000  5
zdef    1 levels 500
tdef $ntprd linear jan1991  1yr
vars   1
hs   0 99 Type of Ob
endvars
EOF
#
cat>$datadir/acc_rms.${model}_regr.${var}.$season.1991-$last_yr.ctl<<EOF2
dset $datadir/acc_rms.${model}_regr.${var}.$season.1991-$last_yr.gr
undef 999.0
title Realtime Surface Obs
xdef    1 linear    0.000  1
ydef    1 linear    0.000  5
zdef    1 levels 500
tdef $ntprd linear jan1961  1yr
vars   2
acc   0 99 Type of Ob
rms   0 99 Type of Ob
endvars
EOF2
#
cat>$datadir/regr_corr.${model}_2_${var}.$season.1991-$last_yr.2x2.ctl<<EOF3
dset ^regr_corr.${model}_2_${var}.$season.1991-$last_yr.2x2.gr
undef -9999.0
title Realtime Surface Obs
xdef   36 linear -130 2
ydef   19 LINEAR   20 2
zdef    1 levels 500
tdef 999 linear jan1995  1yr
vars   2
reg     0 99 ocn prd t
cor     0 99 ocn prd t
endvars
EOF3
done
