#!/bin/sh

set -eaux

lcdir=/cpc/home/wd52pp/project/prd_test/pls/hrcn
tmp=/cpc/home/wd52pp/tmp/test
sstdir=/cpc/home/wd52pp/data/obs/sst
hurdir=/cpc/home/wd52pp/utility/hurricane/OBS
 
season=jfm
prctand=hrcn
prctor=hadoisst

cd $tmp

infile1=$prctor.1948-2016.$season.gr
infile2=mask_oi.gr
infile3=hurr_ATL_1948-2016.txt
cp $sstdir/$infile1 $tmp/.
cp $sstdir/$infile2 $tmp/.
cp $hurdir/$infile3 $tmp/.

outfile1=${prctand}_$prctor.$season.fcst.flt.pat
outfile2=${prctand}_$prctor.$season.fcst.flt.ts
outfile3=$prctor.$season.eof_flt

cp $lcdir/pls_fcst.s.f $tmp/.
cp $lcdir/reof.s.f $tmp/.

xdim=360
ydim=180
is=100
ie=360
js=60
je=150
undef=-999000000
nyear=69
nfstart=35
nfend=$nyear
mode=5
istd=1  #=1 standardize; =0 none
icut=20 #eof cutoff
ngrd=18399 #grd # of the area for eof analysis

cat>hrcn_sst.f<<EOF
      parameter(im=$xdim,jm=$ydim)
      parameter(nyr=$nyear)
      parameter(nfs=$nfstart,nfe=$nfend)
      parameter(nto=nfe-nfs+1)
      parameter(undef=$undef)
      parameter(mode=$mode)
      parameter(ID=$istd)
c
      real*4 hur0(4,nyr)
      real*4 hur(nyr),f1(nto),f2(nto)
      real*4 w2d(im,jm),w2d2(im,jm)
      real*4 fin(im,jm,nyr),sst(im,jm,nyr),sstic(im,jm)
      real*4 xlat(jm),cosl(jm)
      real*4 mask(im,jm)
      real*4 pc(nyr,mode),pat(im,jm,mode),pat2(im,jm,mode)
      real*4 var(mode),corr(mode),pcprd(nyr,mode),pco(mode)
      real*4 w1d(nyr),w1d2(nyr),w3d(im,jm,nyr)
      real*4 avg(nto)
      real*4 pat3d(im,jm,mode,nto)
c
c sst data
      open(11,
     1file='$infile1',
     2access='direct',form='unformatted',recl=im*jm*4)
      open(12,
     1file='$infile2',
     2access='direct',form='unformatted',recl=im*jm*4)
c
c OBS total hurricane 1948-2008
      OPEN(13,file='$infile3')
c
      open(21,
     1file='$outfile1.gr',
     2access='direct',form='unformatted',recl=im*jm*4)
      open(22,
     1file='$outfile2.gr',
     2access='direct',form='unformatted',recl=4)
      open(23,
     1file='$outfile3.gr',
     2access='direct',form='unformatted',recl=im*jm*4)
c
      PI=4.*atan(1.)
      CONV=PI/180.

      do j=1,jm
      xlat(j)=-89.5+(j-1)*1.0
      enddo

      do j=1,jm
        cosl(j)=COS(xlat(j)*CONV)
      enddo
c
c read in data
      write(6,*) 'read in data'
      read(12,rec=1) mask
c
      do iy=1,nyr
        read(11,rec=iy) w2d
        do i=1,im
        do j=1,jm
          if(mask(i,j).ne.0) then
          fin(i,j,iy)=w2d(i,j)
          else
          fin(i,j,iy)=undef
          endif
        enddo
        enddo
      enddo
c
c read in hur0
117   format(8x,4f8.1)
      do iy=1,nyr
      read(13,117) (hur0(i,iy),i=1,4)
      end do
c
      do iy=1,nyr
        hur(iy)=hur0(1,iy)
      enddo
      write(6,*) 'hur=',hur
c eof filter data
      call eof_sst_flt(fin,sst,cosl,im,jm,$is,$ie,$js,$je,
     &$ngrd,nyr,$icut,0)
c write out sst
      iw=0
      do it=1,nyr
        do i=1,im
        do j=1,jm
          w2d(i,j)=fin(i,j,it)
          w2d2(i,j)=sst(i,j,it)
        enddo
        enddo
        iw=iw+1
        write(23,rec=iw) w2d
        iw=iw+1
        write(23,rec=iw) w2d2
      enddo
c
c forecast  start
      DO ity=nfs,nfe

        it=0
        do iy=1,ity-1

          w1d(iy)=hur(iy)
        do i=1,im
        do j=1,jm
          w3d(i,j,iy)=sst(i,j,iy)
        enddo
        enddo

        enddo !iy loop

        do i=1,im
        do j=1,jm
          sstic(i,j)=sst(i,j,ity)
        enddo
        enddo
        
c anom input data
      call anom(w1d,nyr,ity-1,av)
      avg(ity-34)=av

      do i=1,im
      do j=1,jm
        if(abs(sst(i,j,1)).lt.999) then

        do iy=1,ity-1
          w1d2(iy)=w3d(i,j,iy)
        enddo

        call anom(w1d2,nyr,ity-1,av)

        do iy=1,ity-1
          w3d(i,j,iy)=w1d2(iy)
        enddo

        sstic(i,j)=sstic(i,j)-av

        endif
      enddo
      enddo

      call pls_fcst(nyr,ity-1,im,jm,$is,$ie,$js,$je,mode,
     &w1d,w3d,sstic,pco,pat,pat2,var,cosl,undef,ID)
c
      do m=1,mode
        pcprd(ity,m)=pco(m)
        do i=1,im
        do j=1,jm
          pat3d(i,j,m,ity-34)=pat2(i,j,m)
        enddo
        enddo
      enddo
c
c variance explained in the training data
      vt=0
      iyr=1947+ity
      do m=1,mode
      vt=vt+var(m)
      enddo
      write(6,*) ' for year',iyr
      write(6,*) 'training var=',var
      write(6,*) 'accumulated var=',vt

      ENDDO !ity loop
c
      write(6,*) 'hur_avg=',avg
c
c write out
c sst cor pattern for each target year
      iw=0
      do iy=1,nto

        do m=1,mode
          do i=1,im
          do j=1,jm
            w2d(i,j)=pat3d(i,j,m,iy)
c           w2d(i,j)=pat2(i,j,m)
          enddo
          enddo

          iw=iw+1
          write(21,rec=iw) w2d
        enddo
c
      enddo
c
      do iy=1,nfs-1
      do m=1,mode
        pcprd(ity,m)=undef
      enddo
      enddo

      iw=0
      do iy=1,nyr
        iw=iw+1
        obs=hur(iy)
        write(22,rec=iw) obs
      do m=1,mode
        pcx=pcprd(iy,m)
        iw=iw+1
        write(22,rec=iw) pcx
      enddo
      enddo
c
c cor skill of pls mode
      do m=1,mode
        it=0
        do iy=nfs,nfe
        it=it+1
          f1(it)=hur(iy)
          f2(it)=pcprd(iy,m)
        enddo
        call anom(f1,nto,nto,avg)
        call anom(f2,nto,nto,avg)
        call cor_reg(nto,f1,f2,cor,reg)
        var(m)=cor*cor
        corr(m)=cor
      enddo !m loop
      write(6,*) 'var of fcst',var
      write(6,*) 'cor of fcst',corr
c
      stop
      end
c
c========================
      subroutine anom(ts,nt,nt2,avg)
      dimension ts(nt)
        av=0
        do i=1,nt2
          av=av+ts(i)
        enddo
        avg=av/float(nt2)
        do i=1,nt2
          ts(i)=ts(i)-avg
        enddo
      return
      end
ccccccccccccccccccccccc
      subroutine eof_sst_flt(fin,fout,cosl,im,jm,is,ie,js,je,
     &ngrd,nt,mod,ID)
      dimension fin(im,jm,nt),fout(im,jm,nt)
      dimension ts1(nt),ts2(nt)
      dimension cosl(jm)
      dimension regr(im,jm,mod),corr(im,jm,mod)
      dimension aaa(ngrd,nt),wk(nt,ngrd)
      dimension eval(nt),evec(ngrd,nt),coef(nt,nt)
c
      do it=1,nt
        ng=0
        do j=js,je
        do i=is,ie
          if(abs(fin(i,j,1)).LT.999) then
          ng=ng+1
          aaa(ng,it)=fin(i,j,it)*cosl(j)
          endif
        end do
        end do
      end do !it loop
      write(6,*) 'ngrd= ',ng

cc... EOF analysis begin
      call eofs(aaa,ngrd,nt,nt,eval,evec,coef,wk,ID)
      totv1=0
      do i=1,mod
      totv1=totv1+eval(i)
      end do
      write(6,*)'total= ',totv1
c
CC...have regr of coef to data
      do m=1,mod

      do it=1,nt
        ts1(it)=coef(m,it)
      enddo
        call normal2(ts1,nt)
      do it=1,nt
        coef(m,it)=ts1(it)
      enddo

      enddo ! m loop
c
      DO m=1,mod      !loop over mode

      do j=1,jm
      do i=1,im
c
      do it=1,nt      !loop over time
        ts1(it)=coef(m,it)
        ts2(it)=fin(i,j,it)
      end do
c
      if(abs(fin(i,j,1)).LT.990) then
      call regr_t(ts1,ts2,nt,corr(i,j,m),regr(i,j,m))
      else
        corr(i,j,m)=$undef
        regr(i,j,m)=$undef
      endif
      end do
      end do

      ENDDO !m loop
c
CC...reconstruct filtered data
      do j=1,jm
      do i=1,im
      do it=1,nt
        fout(i,j,it)=0.
      enddo
      enddo
      enddo
c
      DO it=1,nt

      do j=1,jm
      do i=1,im
c
      if(abs(fin(i,j,1)).LT.990) then
        do m=1,mod
        fout(i,j,it)=fout(i,j,it)+coef(m,it)*regr(i,j,m)
        enddo
       else
        fout(i,j,it)=$undef
      endif
      end do
      end do

      ENDDO ! it loop

      return
      end

      SUBROUTINE regr_t(f1,f2,ltime,cor,reg)
      dimension f1(ltime),f2(ltime)

      cor=0.
      sd1=0.
      sd2=0.

      do it=1,ltime
         cor=cor+f1(it)*f2(it)/float(ltime)
         sd1=sd1+f1(it)*f1(it)/float(ltime)
         sd2=sd2+f2(it)*f2(it)/float(ltime)
      enddo

      sd1=sd1**0.5
      sd2=sd2**0.5
      reg=cor/(sd1)
      cor=cor/(sd1*sd2)

      return
      end

      SUBROUTINE normal2(rot,ltime)
      DIMENSION rot(ltime)
      sd=0.
      do i=1,ltime
        sd=sd+rot(i)*rot(i)/float(ltime)
      enddo
      sd=sqrt(sd)
      do i=1,ltime
      rot(i)=rot(i)/sd
      enddo
      return
      end
EOF
#
#gfortran -mcmodel=medium -g -o avg.x avg_anom.f
#\rm avg.x
#\rm t2m*anom*
gfortran -o hur.x hrcn_sst.f reof.s.f pls_fcst.s.f
echo "done compiling"
./hur.x > $lcdir/out.$prctand.$prctor.$season.fcst.flt
#./hur.x 
#
cat>$outfile1.ctl<<EOF
dset ^$outfile1.gr
undef $undef
*
TITLE pls cor pattern
*
xdef  360 linear 0 1.
ydef  180 linear -89.5 1.
zdef    1 linear 1 1
tdef 999 linear jan1979 1mo
vars $mode
cor1 1 99 from original data
cor2 1 99 from original data
cor3 1 99 from original data
cor4 1 99 from original data
cor5 1 99 from original data
ENDVARS
EOF
#
cat>$outfile2.ctl<<EOF
dset ^$outfile2.gr
undef $undef
*
TITLE pls time series
*
xdef  1 linear 0 1.
ydef  1 linear -89.5 1.
zdef  1 linear 1 1
tdef $nyear linear aug1948 1yr
vars 6
obs  1 99 ts of obs
ts1  1 99 ts of pls
ts2  1 99 ts of pls
ts3  1 99 ts of pls
ts4  1 99 ts of pls
ts5  1 99 ts of pls
ENDVARS
EOF
cat>$outfile3.ctl<<EOF
dset ^$outfile3.gr
undef $undef
*
TITLE eof filtered sst
*
xdef  360 linear 0 1.
ydef  180 linear -89.5 1.
zdef    1 linear 1 1
tdef 999 linear jan1948 1yr
vars 2
obs 1 99 raw data
flt 1 99 filtered
ENDVARS
EOF
#
cp $outfile1.* $lcdir/.
cp $outfile2.* $lcdir/.
cp $outfile3.* $lcdir/.
